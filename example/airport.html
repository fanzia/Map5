<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../css/bootstrap-3.2.0-dist/css/bootstrap.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/Map5.css"/>

<script type="text/javascript" src="../lib/jquery-1.11.1.js"></script>
<script type="text/javascript" src="../lib/bootstrap-3.2.0-dist/bootstrap.min.js"></script>
<!-- <script type="text/javascript" src="../lib/Map5.min.js"></script> -->
<script type="text/javascript" src='../lib/requestNextAnimationFrame.js'></script>
<script type="text/javascript" src="../lib/GeoBeans.js"></script>

<script type="text/javascript" src="../lib/GeoBeans/BaseTypes/Class.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/BaseTypes/Envelope.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/BaseTypes/Color.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/BaseTypes/ColorRangeMap.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/User.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Map.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/MapManager.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/DBS/DBSManager.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/File/FileManager.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/TileDB/TileDBManager.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/RasterDB/RasterDBManager.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/GPS/GPSManager.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Poi/PoiManager.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Subscribe/SubManager.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Service/Service.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Service/ServiceManager.js"></script>


<script type="text/javascript" src="../lib/GeoBeans/Geometry.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Geometry/GeometryCollection.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Geometry/Point.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Geometry/LineString.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Geometry/Line/LinearRing.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Geometry/Polygon.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Geometry/MultiPoint.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Geometry/MultiLineString.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Geometry/MultiPolygon.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Geometry/Circle.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Geometry/GML.js"></script>

<script type="text/javascript" src="../lib/GeoBeans/Label.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Label/PointLabel.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Field.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Feature.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/FeatureType.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Workspace.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/WFS/WFSWorkspace.js"></script>


<script type="text/javascript" src="../lib/GeoBeans/Transformation.js"></script>

<script type="text/javascript" src="../lib/GeoBeans/Filter.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Filter/FilterReader.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Filter/FilterWriter.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Filter/LogicFilter.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Filter/LogicFilter/BinaryLogicFilter.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Filter/ComparisionFilter.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Filter/ComparisionFilter/BinaryComparisionFilter.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Filter/IDFilter.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Filter/UnaryLogicFilter.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Filter/SpatialFilter.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Filter/SpatialFilter/BBoxFilter.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Filter/Expression.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Filter/PropertyName.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Filter/Literal.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/MapWorkspace.js"></script>

<script type="text/javascript" src="../lib/GeoBeans/Control.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Control/TrackControl.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Control/DragMapControl.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Control/SrollMapControl.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Control/MapNavControl.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Control/ZoomControl.js"></script>

<script type="text/javascript" src="../lib/GeoBeans/Renderer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Style/StyleManager.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Style.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Style/ColorMap.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Style/StyleReader.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Style/StyleWriter.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Style/Rule.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Style/FeatureStyle.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Symbolizer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Style/PointSymbolizer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Style/LineSymbolizer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Style/PolygonSymbolizer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Style/TextSymbolizer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Style/Font.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Style/Stroke.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Style/Fill.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Events.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/InfoWindow.js"></script>

<script type="text/javascript" src="../lib/GeoBeans/Layer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/Tile.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/TileCache.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/TileLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/TileLayer/QSLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/FeatureLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/WFSLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/DBLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/GroupLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/FeatureDBLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/OverlayLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/QueryLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/ImageLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/TileLayer/WMTSLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/PanoramaLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/GeoLineLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/ChartLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/chart/SymbolChartLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/chart/RingChartLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/RippleLayer.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Layer/AirLineLayer.js"></script>


<script type="text/javascript" src="../lib/GeoBeans/Overlay.js"></script>
<script type="text/javascript" src="../lib/GeoBeans/Overlay/Marker.js"></script>



<script type="text/javascript">
	var mapObj = null;
	var username = "user1";
	var mapName = "0418";
	function init(){
		var user = new GeoBeans.User(username);
		var mapManager = user.getMapManager();
		mapObj = mapManager.getMap("mapDiv",mapName);
		if(mapObj == null){
			alert("没有该地图");
			return;
		}
		// mapObj.setDrawLayerSingle(true);
		var color = new GeoBeans.Color();
		color.setByHex("#404A59",1);
		// mapObj.setBackground(color);
		mapObj.draw();

		// 定义marker
		// var x = 116.4551;
		// var y = 40.2539;
		// var point = new GeoBeans.Geometry.Point(x,y);
		// var symbolizer = new GeoBeans.Symbolizer.PointSymbolizer();
		// symbolizer.icon_url = "marker.png";
		// symbolizer.icon_offset_x = 0;
		// symbolizer.icon_offset_y = 0;

		// var marker = new GeoBeans.Overlay.Marker("1",point,symbolizer,null);	
		// mapObj.addOverlay(marker);



		// var x = 91.1865;
		// var y = 30.1465;
		// var point = new GeoBeans.Geometry.Point(x,y);
		// var symbolizer = new GeoBeans.Symbolizer.PointSymbolizer();
		// symbolizer.icon_url = "marker.png";
		// symbolizer.icon_offset_x = 0;
		// symbolizer.icon_offset_y = 0;

		// var marker = new GeoBeans.Overlay.Marker("2",point,symbolizer,null);	
		// mapObj.addOverlay(marker);


		// var x = 108.479;
		// var y = 23.1152;
		// var point = new GeoBeans.Geometry.Point(x,y);
		// var symbolizer = new GeoBeans.Symbolizer.PointSymbolizer();
		// symbolizer.icon_url = "marker.png";
		// symbolizer.icon_offset_x = 0;
		// symbolizer.icon_offset_y = 0;

		// var marker = new GeoBeans.Overlay.Marker("3",point,symbolizer,null);	
		// mapObj.addOverlay(marker);
		// addQuadServerLayer();
	}




	var curveness = 0.4;
	var dbName = "osm";
	var typeName = "osm_airports";
	function addAirPort(){
		
		getFeatures();

	}

	function getFeatures(){
		var workspace = new GeoBeans.WFSWorkspace("tmp",
			mapObj.server,"1.0.0");
		var featureType = new GeoBeans.FeatureType(workspace,typeName);
		if(featureType.fields == null){
			featureType.fields = featureType.getFields(null,dbName);
		}
		var fields = ["shape","name"];
		featureType.getFeaturesFilterAsync2(null,dbName,null,null,null,fields,
			null,null,getFeatures_callback);
	}

	function getFeatures_callback(obj,features){
		// var first = features[0];
		// var from = first.geometry;

		var symbolizer = new GeoBeans.Symbolizer.LineSymbolizer();
		var color = new GeoBeans.Color();
		color.setByHex("#950dfc",0.1);

		symbolizer.stroke.color = color;
		symbolizer.stroke.width = 0.2;

		// 绘制到overlay中
		var layer = new GeoBeans.Layer("test");
		mapObj.addLayer(layer);
		var renderer = layer.renderer;
		renderer.setSymbolizer(symbolizer);
		// renderer.context.globalCompositeOperation = "lighter";


		var time = new Date();
		var from = null, from_geometry = null,to = null,to_geometry = null,control = null;
		for(var i = 0;i < features.length;++i){
		// for(var i = 0;i < 10;++i){	
			from = features[i];
			if(from == null){
				continue;
			}
			from_geometry = from.geometry;
			if(from_geometry == null){
				continue;
			}

			// for(var j = i+1; j < features.length;++j){
			for(var j = i+1; j < 10;++j){
				if(j <= i){
					continue;
				}
				to = features[j];
				if(to == null){
					continue;
				}
				to_geometry = to.geometry;
				if(to_geometry == null){
					continue;
				}
				control = getBezierControlPoint(from_geometry,to_geometry,curveness);
				renderer.drawBezierLine(from_geometry,to_geometry,control,mapObj.transformation);

			}
		}
		console.log(new Date() - time);
		mapObj.draw();
	}


	function getBezierControlPoint(from,to,curveness){
		if(from == null || to == null){
			return null;
		}
		var center = new GeoBeans.Geometry.Point(from.x/2+to.x/2,from.y/2+to.y/2);
		// var distance = this.getDistance(from,to);
		var distance = Math.sqrt((from.x-to.x)*(from.x-to.x) + (from.y-to.y)*(from.y-to.y));
		var k = (from.x-to.x)/(from.y-to.y);
		var angle = Math.atan(k);
		angle = Math.PI/2 - angle;
		var distance_cur = distance * curveness;
		var x_cur = Math.sin(angle) * distance_cur;
		var y_cur = Math.cos(angle) * distance_cur;
		var x = center.x + x_cur;
		var y = center.y - y_cur;
		var point = new GeoBeans.Geometry.Point(x,y);
		return point;		
	}


	function addAirLine(){
		var dbName = "osm";
		var typeName = "osm_airports";

		var option = {
			curveness : 0.4
		};
		var symbolizer = new GeoBeans.Symbolizer.LineSymbolizer();
		var color = new GeoBeans.Color();
		color.setByHex("#9494E5",0.8);
		// color.setByHex("#4a53ff",0.8);
		// color.setByHex("#FFFFFF",0.8);
		symbolizer.stroke.color = color;
		symbolizer.stroke.width = 0.6;

		var pointSymbolizer = new GeoBeans.Symbolizer.PointSymbolizer();
		pointSymbolizer.size = 5;
		var color  = new GeoBeans.Color(); 
		color.setByHex("#ffff00",0.8);
		pointSymbolizer.fill.color = color;
		pointSymbolizer.stroke = null;


		var layer = new GeoBeans.Layer.AirLineLayer("air",dbName,typeName,symbolizer,pointSymbolizer,option);
		mapObj.addLayer(layer,addLayer_callback);
	}

	function addLayer_callback(){
		mapObj.draw();
	}
</script>
<body onload="init()">


	<!-- <button onclick="addAirPort()">机场</button> -->
	<button onclick="addAirLine()">航线图层</button>
	<div id="mapDiv" style="height:800px;width:100%;position:absolute;top:120px;">
	</div>
	
</body>