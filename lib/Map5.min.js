!function(){window.GeoBeans={}}();
GeoBeans.Class=function(){var t=arguments.length,n=arguments[0],e=arguments[t-1],o="function"==typeof e.initialize?e.initialize:function(){n.prototype.initialize.apply(this,arguments)};if(t>1){var i=[o,n].concat(Array.prototype.slice.call(arguments).slice(1,t-1),e);GeoBeans.inherit.apply(null,i)}else o.prototype=e;return o},GeoBeans.inherit=function(t,n){var e=function(){};e.prototype=n.prototype,t.prototype=new e;var o,i,r;for(o=2,i=arguments.length;i>o;o++)r=arguments[o],"function"==typeof r&&(r=r.prototype),GeoBeans.Util.extend(t.prototype,r)},GeoBeans.Util=GeoBeans.Util||{},GeoBeans.Util.extend=function(t,n){if(t=t||{},n){for(var e in n){var o=n[e];void 0!==o&&(t[e]=o)}var i="function"==typeof window.Event&&n instanceof window.Event;!i&&n.hasOwnProperty&&n.hasOwnProperty("toString")&&(t.toString=n.toString)}return t};
GeoBeans.Color=GeoBeans.Class({r:null,g:null,b:null,a:null,initialize:function(){this.r=parseInt(255*Math.random()),this.g=parseInt(255*Math.random()),this.b=parseInt(255*Math.random()),this.a=Math.random()},set:function(t,n,i,s){this.r=t,this.g=n,this.b=i,this.a=s},setByHex:function(t,n){if(null!=t){t=t.replace("#","");var i=parseInt(t.substring(0,2),16),s=parseInt(t.substring(2,4),16),r=parseInt(t.substring(4,6),16);this.r=i,this.g=s,this.b=r}null!=n&&(this.a=parseFloat(n))},setByRgb:function(t,n){if(null!=t){var i=t.indexOf("("),s=t.indexOf(")"),r=t.slice(i+1,s),e=r.slice(0,r.indexOf(",")),a=r.slice(r.lastIndexOf(",")+1,r.length),h=r.slice(r.indexOf(",")+1,r.lastIndexOf(","));this.r=parseInt(e),this.g=parseInt(h),this.b=parseInt(a)}null!=n&&(this.a=parseFloat(n))},getRgb:function(){return"rgb("+this.r+","+this.g+","+this.b+")"},getRgba:function(){return"rgba("+this.r+","+this.g+","+this.b+","+this.a+")"},getOpacity:function(){return this.a},setOpacity:function(t){this.a=t},zero_fill_hex:function(t,n){for(var i=t.toString(16);i.length<n;)i="0"+i;return i},getHex:function(){var t=this.getRgb();if("#"==t.charAt(0))return t;var n=t.split(/\D+/),i=65536*Number(n[1])+256*Number(n[2])+Number(n[3]);return"#"+this.zero_fill_hex(i,6)},clone:function(){var t=new GeoBeans.Color;return t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a,t}});
GeoBeans.ColorRamp=GeoBeans.Class({beginColor:null,endColor:null,number:null,initialize:function(e,n,o){this.beginColor=e,this.endColor=n,this.number=o},getValues:function(){for(var e,n,o,t,r,i=this.beginColor.slice(1,this.beginColor.length),l=this.endColor.slice(1,this.endColor.length),s=parseInt("0x"+i,16),a=(16711680&s)>>16,h=(65280&s)>>8,u=(255&s)>>0,C=parseInt("0x"+l,16),p=(16711680&C)>>16,b=(65280&C)>>8,g=(255&C)>>0,m=[],c=0;c<=this.number;c++)e=this.interpolateColor(a,p,c,this.number),n=this.interpolateColor(h,b,c,this.number),o=this.interpolateColor(u,g,c,this.number),t=new GeoBeans.Color,t.set(parseInt(e),parseInt(n),parseInt(o),1),r=t.getHex(),m.push(r);return m},interpolateColor:function(e,n,o,t){return n>e?(n-e)*(o/t)+e:(e-n)*(1-o/t)+n}});
GeoBeans.ColorRangeMap=GeoBeans.Class({beginColor:null,endColor:null,min:null,max:null,beginColorHSV:null,endColorHSV:null,initialize:function(o,r,e,i){this.beginColor=o,this.endColor=r,this.min=e,this.max=i;var n=this.beginColor.slice(1,this.beginColor.length),t=this.endColor.slice(1,this.endColor.length),s=parseInt("0x"+n,16),l=(16711680&s)>>16,a=(65280&s)>>8,h=(255&s)>>0;this.beginColorHSV=this.rgb_2_hsv(l,a,h);var g=parseInt("0x"+t,16),C=(16711680&g)>>16,u=(65280&g)>>8,b=(255&g)>>0;this.endColorHSV=this.rgb_2_hsv(C,u,b)},getValue:function(o){var r=this.getColorValue(this.beginColorHSV.h,this.endColorHSV.h,o),e=this.getColorValue(this.beginColorHSV.s,this.endColorHSV.s,o),i=this.getColorValue(this.beginColorHSV.v,this.endColorHSV.v,o),n=this.hsv_2_rgb(r,e,i);return color=new GeoBeans.Color,color.set(parseInt(n.r),parseInt(n.g),parseInt(n.b),1),color},getColorValue:function(o,r,e){var i=null;return i=e<this.min?0:e>this.max?this.max-this.min:e-this.min,r>o?(r-o)*(i/(this.max-this.min))+o:(o-r)*(1-i/(this.max-this.min))+r},rgb_2_hsv:function(o,r,e){var i,n,t,s=Math.min(o,r,e),l=Math.max(o,r,e);t=l;var a=l-s;return 0==l?(n=0,i=-1,{h:i,s:n,v:t}):(n=a/l,i=o==l?(r-e)/a:r==l?2+(e-o)/a:4+(o-r)/a,i*=60,0>i&&(i+=360),{h:i,s:n,v:parseFloat(t/255)})},hsv_2_rgb:function(o,r,e){var i,n,t;if(0==r)return i=n=t=e,{r:255*i,g:255*n,b:255*t};o/=60;var s=Math.floor(o),l=o-s,a=e*(1-r),h=e*(1-r*l),g=e*(1-r*(1-l));switch(s){case 0:i=e,n=g,t=a;break;case 1:i=h,n=e,t=a;break;case 2:i=a,n=e,t=g;break;case 3:i=a,n=h,t=e;break;case 4:i=g,n=a,t=e;break;default:i=e,n=a,t=h}return{r:255*i,g:255*n,b:255*t}}});
GeoBeans.Cookie=GeoBeans.Class({initialize:function(){},setCookie:function(e,o,i){var n=new Date;n.setTime(n.getTime()+864e5);var t=e+"="+escape(o)+";expires="+n.toGMTString();null!=i&&(t+=";path="+i),document.cookie=t},getCookie:function(e){var o=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=o?unescape(o[2]):null},delCookie:function(e,o){var i=new Date;i.setTime(i.getTime()-1);var n=this.getCookie(e);if(null!=n){var t=e+"="+n+";expires="+i.toGMTString();null!=o&&(t+=";path="+o),document.cookie=t}}});
GeoBeans.Envelope=GeoBeans.Class({xmin:null,xmax:null,ymin:null,ymax:null,initialize:function(i,t,n,m){this.xmin=i,this.ymin=t,this.xmax=n,this.ymax=m},getWidth:function(){return this.xmax-this.xmin},getHeight:function(){return this.ymax-this.ymin},getCenter:function(){var i=(this.xmin+this.xmax)/2,t=(this.ymin+this.ymax)/2,n=new GeoBeans.Geometry.Point(i,t);return n},offset:function(i,t){this.xmin+=i,this.xmax+=i,this.ymin+=t,this.ymax+=t},union:function(i){this.xmin=this.xmin<i.xmin?this.xmin:i.xmin,this.xmax=this.xmax>i.xmax?this.xmax:i.xmax,this.ymin=this.ymin<i.ymin?this.ymin:i.ymin,this.ymax=this.ymax>i.ymax?this.ymax:i.ymax},contain:function(i,t){return i>this.xmin&&i<this.xmax&&t>this.ymin&&t<this.ymax?!0:!1},scale:function(i){var t=(this.xmin+this.xmax)/2,n=(this.ymin+this.ymax)/2,m=(this.xmax-this.xmin)*i/2,x=(this.ymax-this.ymin)*i/2;this.xmin=t-m,this.xmax=t+m,this.ymin=n-x,this.ymax=n+x},toString:function(){var i="";return i+=this.xmin+",",i+=this.ymin+",",i+=this.xmax+",",i+=this.ymax},equal:function(i){return this.xmin==i.xmin&&this.xmax==i.xmax&&this.ymin==i.ymin&&this.ymax==i.ymax?!0:!1},intersects:function(i){var t=this.xmin>i.xmin?this.xmin:i.xmin,n=this.xmax<i.xmax?this.xmax:i.xmax,m=this.ymin>i.ymin?this.ymin:i.ymin,x=this.ymax<i.ymax?this.ymax:i.ymax;return n>t&&x>m}});
GeoBeans.Control=GeoBeans.Class({type:null,map:null,enabled:!0,initialize:function(n){},destory:function(){},attach:function(n){this.map=n},detach:function(){this.map=map},enable:function(n){this.enabled=n}}),GeoBeans.Control.Type={SCROLL_MAP:"SrollMapControl",DRAG_MAP:"DragMapControl",TRACK:"TrackControl",TRACKBUFFER:"TrackBufferControl",TRACKTRANSACTION:"TrackTransactionControl",TRACKOVERLAY:"TrackOverlayControl",HIT_FEATURE:"FeatureHitControl",NAV:"navControl"},GeoBeans.Control.Controls=GeoBeans.Class({map:null,controls:[],initialize:function(n){this.map=n,this.controls=[]},destory:function(){this.controls=null},add:function(n){if(null!=n&&"undefined"!=n){var t=this.find(n.type);0>t?(n.attach(this.map),this.controls.push(n)):(this.controls[t]=null,this.controls[t]=n)}},remove:function(n){if(null!=n&&"undefined"!=n){var t=this.find(n.type);t>=0&&(this.controls[t]=null,this.controls[t].splice(t,1))}},get:function(n){return this.controls[n]},find:function(n){for(var t=this.controls.length,o=0;t>o;o++){var l=this.controls[o];if(null!=l&&l.type==n)return o}return-1},cleanup:function(){for(var n=this.controls.length,t=0;n>t;t++)this.controls[t].destory(),this.controls[t]=null;this.controls=[]}});
GeoBeans.Event={CLICK:"click",DCLICK:"dblclick",MOUSE_DOWN:"mousedown",MOUSE_UP:"mouseup",MOUSE_MOVE:"mousemove",MOUSE_OVER:"mouseover",MOUSE_OUT:"mouseout",RESIZE:"resize"},GeoBeans.Event.MouseButton={LEFT:"left",RIGHT:"right",MID:"mid"},GeoBeans.Event.MouseArgs=function(){},GeoBeans.Events=GeoBeans.Class({events:null,initialize:function(){this.events=[]},destory:function(){this.events=null},addEvent:function(e,n){this.events.push({event:e,handler:n})},getEvnet:function(e){for(var n=this.events,t=0;n>t;t++){var s=this.events[t];if(s.event==e)return s}return null}});
GeoBeans.Feature=GeoBeans.Class({featureType:null,fid:null,geometry:null,values:null,symbolizer:null,initialize:function(e,l,t,u){this.featureType=e,this.fid=l,this.geometry=t,this.values=u},destroy:function(){this.featureType=null,this.geometry=null,this.values=null}});
GeoBeans.FeatureType=GeoBeans.Class({workspace:null,name:null,title:null,keywords:null,srs:null,extent:null,fields:null,geomFieldName:null,count:null,minMaxValue:null,callback_obj:null,initialize:function(e,t){this.workspace=e,this.name=t},destory:function(){this.workspace=null,this.name=null,this.title=null,this.keywords=null,this.srs=null,this.extent=null,this.geomFieldName=null},setName:function(e){this.name=e},setTitle:function(e){this.title=e},setKeywords:function(e){this.keywords=e},setSrs:function(e){this.srs=e},setExtent:function(e){this.extent=e},getFields:function(e,t){if(null!=this.fields&&0!=this.fields.length)return this.fields;var n=this,r=this.workspace.server,s="service="+this.workspace.service+"&version="+this.workspace.version+"&request=describeFeatureType&typeName="+this.name;return null!=e&&(s+="&mapName="+e),null!=t&&(s+="&sourceName="+t),$.ajax({type:"get",url:r,data:encodeURI(s),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){n.fields=n.parseFields(e)},complete:function(e,t){},error:function(){}}),this.fields},getFieldIndex:function(e){for(var t=this.getFields(),n=0,r=t.length;r>n;n++){var s=t[n];if(s.name==e)return n}return-1},parseFields:function(e){if(0!=$(e).find("ExceptionText").length){var t=$(e).find("ExceptionText").text();return t}var n=this,r=null,s=new Array;return $(e).find("sequence").children().each(function(){r=n.parseField(this),s.push(r)}),s},parseField:function(e){var t=$(e).attr("name"),n=($(e).attr("nillable"),$(e).attr("type")),r=this.parseFieldType(n),s=$(e).attr("length"),a=new GeoBeans.Field(t,r,this,s);if(r==GeoBeans.FieldType.GEOMETRY){var i=this.parseGeometryType(n);a.setGeomType(i),this.geomFieldName=t}return a},parseFieldType:function(e){return"gml"==e.substr(0,3)?GeoBeans.FieldType.GEOMETRY:e.substring(4,e.length)},parseGeometryType:function(e){return e.substr(4,e.length-16)},getFeatures:function(e,t,n,r,s){var a=this,i=this.workspace.server,o="service="+this.workspace.service+"&version="+this.workspace.version+"&request=getFeature&typeName="+this.name;null!=e&&(o+="&mapName="+e),null!=t&&(o+="&sourceName="+t),null!=n&&(o+="&maxFeatures="+n),null!=r&&(o+="&offset="+r);var l="";if(null!=s)for(var u=0;u<s.length;++u)l+=s[u],u<s.length-1&&(l+=",");return 0!=l.length&&(o+="&fields="+l),a.fields=a.getFields(e,t),$.ajax({type:"get",url:i,data:encodeURI(encodeURI(o)),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){var n=a.parseFeatures(e);a.features=n},complete:function(e,t){},error:function(){}}),this.features},getFeaturesAsync:function(e,t,n,r,s,a){var i=this,o=this.workspace.server,l="service="+this.workspace.service+"&version="+this.workspace.version+"&request=getFeature&typeName="+this.name;null!=e&&(l+="&mapName="+e),null!=t&&(l+="&sourceName="+t),null!=n&&(l+="&maxFeatures="+n),null!=r&&(l+="&offset="+r);var u="";if(null!=s)for(var c=0;c<s.length;++c)u+=s[c],c<s.length-1&&(u+=",");0!=u.length&&(l+="&fields="+u),i.fields=i.getFields(e,t),$.ajax({type:"get",url:o,data:encodeURI(encodeURI(l)),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.parseFeatures(e);void 0!=a&&a(n)},complete:function(e,t){},error:function(e,t,n){console.log("textStatus:"+t),console.log("error:"+n)}})},getFeatureBBoxGet:function(e,t,n,r,s){var a=this,i=this.workspace.server,o="service="+this.workspace.service+"&version="+this.workspace.version+"&request=getFeature&typeName="+this.name;if(null!=e&&(o+="&mapName="+e),null!=t&&(o+="&sourceName="+t),null!=n){var l=n.xmin,u=n.xmax,c=n.ymin,p=n.ymax,f="";f=.01>u-l?n.toString():l.toFixed(2)+","+c.toFixed(2)+","+u.toFixed(2)+","+p.toFixed(2),o+="&bbox="+f}return null!=r&&(o+="&maxFeatures="+r),null!=s&&(o+="&offset="+s),a.fields=a.getFields(e,t),$.ajax({type:"get",url:i,data:encodeURI(o),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){var n=a.parseFeatures(e);a.features=n},complete:function(e,t){},error:function(){}}),a.features},getFeatureBBoxGetOutput:function(e,t,n,r,s){var a=this.workspace.server,i="service="+this.workspace.service+"&version="+this.workspace.version+"&request=getFeature&typeName="+this.name;if(null!=e&&(i+="&mapName="+e),null!=t&&(i+="&sourceName="+t),null!=n){var o=n.xmin,l=n.xmax,u=n.ymin,c=n.ymax,p=o.toFixed(2)+","+u.toFixed(2)+","+l.toFixed(2)+","+c.toFixed(2);i+="&bbox="+p}return null!=r&&(i+="&maxFeatures="+r),null!=s&&(i+="&offset="+s),i+="&outputformat=shape-zip",a+"?"+i},getFeaturesBBox:function(e,t,n){var r=t.xmin,s=t.xmax,a=t.ymin,i=t.ymax,o=(r.toFixed(2)+","+a.toFixed(2)+","+s.toFixed(2)+","+i.toFixed(2),this),l=this.workspace.server,u=this.buildGetFeatureXMLBboxFilter(t,n);$.ajax({type:"post",url:l,data:u,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(t,n){var r=o.parseFeatures(t);void 0!=e&&e(o,r)},complete:function(e,t){},error:function(){}})},parseFeatures:function(e){var t=this,n=null,r=new Array,s=new GeoBeans.Geometry.GML.Reader(GeoBeans.Geometry.GML.Version.v_2_0);return $(e).find("featureMember").each(function(){n=t.parseFeature($(this).children()[0],s),r.push(n)}),r},parseFeature:function(e,t){for(var n=this.parseFID($(e).attr("fid")),r=(this.getFields(),new Array),s=null,a=null,i=this.fields.length,o=0;i>o;o++)if(a=this.fields[o],a.type==GeoBeans.FieldType.GEOMETRY){var l=$(e).find(a.name+":first").children()[0];null==l?r.push(null):(s=t.read(l),r.push(s))}else{var u=$(e).find(a.name+":first");r.push(null==u||0==u.length?null:u.text())}return new GeoBeans.Feature(this,n,s,r)},parseFID:function(e){var t=e.indexOf(".");return e.substring(t+1,e.length)},buildGetFeatureXMLBboxFilter:function(e,t){var n="",r=this.workspace.workspaceName,s='xmlns:wfs="http://www.opengis.net/wfs"',a="xmlns:"+r+'="'+this.workspace.xmlnsWorkspace+'"',i='xmlns:gml="http://www.opengis.net/gml"',o='xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"',l='xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/WFS-basic.xsd"',u='xmlns:ogc="http://www.opengis.net/ogc" ';n+='<wfs:GetFeature service="WFS" version="1.0.0"  '+s+" "+u+" "+a+" "+i+" "+o+" "+l+'><wfs:Query typeName="'+this.name+'"><ogc:Filter>';var c="",p="";if(null!=e&&void 0!=e&&(p+="<ogc:BBOX><gml:Box><gml:coordinates>"+e.xmin+","+e.ymin+" "+e.xmax+","+e.ymax+"</gml:coordinates></gml:Box></ogc:BBOX>"),null!=t&&void 0!=t){var f=t.field,m=t.value;c+="<ogc:PropertyIsEqualTo><ogc:PropertyName>"+f+"</ogc:PropertyName><ogc:Literal>"+m+"</ogc:Literal></ogc:PropertyIsEqualTo>"}return""!=c&&""!=p?n+="<And>"+c+p+"</And>":""!=c&&""==p?n+=c:""==c&&""!=p&&(n+=p),n+="</ogc:Filter></wfs:Query></wfs:GetFeature>"},getCount:function(e,t,n){var r=this,s=this.workspace.server,a="service="+this.workspace.service+"&version="+this.workspace.version+"&request=GetCount&typeName="+this.name;return null!=e&&(a+="&mapName="+e),null!=t&&(a+="&sourceName="+t),null!=n&&(a+="&bbox="+n.toString()),$.ajax({type:"get",url:s,data:encodeURI(a),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){r.count=r.parseCount(e)},complete:function(e,t){},error:function(){}}),r.count},parseCount:function(e){if(0!=$(e).find("ExceptionText").length){var t=$(e).find("ExceptionText").text();if(""!=t)return t}var n=$(e).find("Count").text();return parseInt(n)},getFeaturesWithin:function(e,t,n){var r=this,s=this.workspace.server,a=this.buildGetFeaturesXMLWithin(e,t,n);return $.ajax({type:"post",url:s,contentType:"text/xml",dataType:"xml",data:a,async:!1,beforeSend:function(e){},success:function(e,t){var n=r.parseFeatures(e);r.features=n},complete:function(e,t){},error:function(){}}),r.features},getFeaturesWithinAsync:function(e,t,n,r,s){var a=this,i=this.workspace.server,o=this.buildGetFeaturesXMLWithin(e,t,n,s);$.ajax({type:"post",url:i,contentType:"text/xml",dataType:"xml",data:o,async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseFeatures(e);void 0!=r&&r(n)},complete:function(e,t){},error:function(){}})},buildGetFeaturesXMLWithin:function(e,t,n,r){var s="";s+='<wfs:GetFeature service="WFS" version="1.1.0" ',null!=e&&(s+='mapName="'+e+'" '),null!=t&&(s+='sourceName="'+t+'" ');var a="";if(null!=r)for(var i=0;i<r.length;++i){var o=r[i];null!=o&&(a+="<wfs:PropertyName>"+o+"</wfs:PropertyName>")}var l=new GeoBeans.Geometry.GML.Writer(GeoBeans.Geometry.GML.Version.v_2_0),u=l.write(n);return s+='xmlns:world="www.world.ac.cn" xmlns:wfs="http://www.opengis.net/wfs" xmlns:gml="http://www.opengis.net/gml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd"><wfs:Query typeName="'+this.name+'">'+a+"	<Filter>		<Within>			<PropertyName>"+this.geomFieldName+"</PropertyName>"+u+"		</Within>	</Filter></wfs:Query></wfs:GetFeature>"},getFeaturesFilter:function(e,t,n,r,s,a,i){var o=this,l=this.workspace.server,u=this.buildGetFeatureFilterXML(e,t,n,r,s,a,i);return this.fields=this.getFields(e,t),$.ajax({type:"post",url:l,data:u,contentType:"text/xml",dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){var n=o.parseFeatures(e);o.features=n},complete:function(e,t){},error:function(){}}),o.features},getFeaturesFilterAsync:function(e,t,n,r,s,a,i,o){var l=this,u=this.workspace.server,c=this.buildGetFeatureFilterXML(e,t,n,r,s,a,i);this.fields=this.getFields(e,t),$.ajax({type:"post",url:u,data:c,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=l.parseFeatures(e);void 0!=o&&o(n)},complete:function(e,t){},error:function(e,t,n){console.log("textStatus:"+t),console.log("error:"+n)}})},getFeaturesFilterAsync2:function(e,t,n,r,s,a,i,o,l){var u=this,c=this.workspace.server,p=this.buildGetFeatureFilterXML(e,t,n,r,s,a);this.fields=this.getFields(e,t),this.callback_obj=o,$.ajax({type:"post",url:c,data:p,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=u.parseFeatures(e);void 0!=l&&l(u.callback_obj,n)},complete:function(e,t){},error:function(e,t,n){console.log("textStatus:"+t),console.log("error:"+n)}})},buildGetFeatureFilterXML:function(e,t,n,r,s,a,i){var o='<?xml version="1.0" encoding="UTF-8"?><wfs:GetFeature service="WFS" version="1.0.0" outputFormat="GML2" xmlns:wfs="http://www.opengis.net/wfs" xmlns:ogc="http://www.opengis.net/ogc" xmlns:gml="http://www.opengis.net/gml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd" ';null!=e&&(o+='mapName="'+e+'" '),null!=t&&(o+='sourceName="'+t+'" '),null!=r&&(o+='maxFeatures="'+r+'" '),null!=s&&(o+='offset="'+s+'" '),o+="/>";var l=$.parseXML(o),u=l.createElement("wfs:Query");if($(u).attr("typeName",this.name),null!=a)for(var c=0;c<a.length;++c){var p=l.createElement("wfs:PropertyName");$(p).text(a[c]),$(u).append(p)}var f=new GeoBeans.FilterWriter,m=f.write(l,n);if($(u).append(m),null!=i){var h=this.buildOrderbyXML(l,i);$(u).append(h)}$("GetFeature",l).append(u);var d=(new XMLSerializer).serializeToString(l);return d},buildOrderbyXML:function(e,t){if(null==t)return"";var n=e.createElement("ogc:OrderBy"),r=t.isAsc();r?$(n).attr("order","asc"):$(n).attr("order","desc");for(var s=t.getFieldCount(),a=null,i=null,o=0;s>o;++o)i=t.getField(o),null!=i&&(a=e.createElement("wfs:PropertyName"),$(a).text(i),$(n).append(a));return n},getFeatureFilterCount:function(e,t,n){var r=this,s=this.workspace.server,a=this.buildGetFeatureFilterCountXML(e,t,n);return $.ajax({type:"post",url:s,data:a,contentType:"text/xml",dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){r.count=r.parseCount(e)},complete:function(e,t){},error:function(){}}),r.count},buildGetFeatureFilterCountXML:function(e,t,n){var r='<?xml version="1.0" encoding="UTF-8"?><wfs:GetCount service="WFS" version="1.0.0" outputFormat="GML2" xmlns:world="www.world.ac.cn" xmlns:wfs="http://www.opengis.net/wfs" xmlns:ogc="http://www.opengis.net/ogc" xmlns:gml="http://www.opengis.net/gml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd" ';null!=e&&(r+='mapName="'+e+'" '),null!=t&&(r+='sourceName="'+t+'" '),r+="/>";var s=$.parseXML(r),a=s.createElement("wfs:Query");$(a).attr("typeName",this.name);var i=new GeoBeans.FilterWriter,o=i.write(s,n);$(a).append(o),$("GetCount",s).append(a);var l=(new XMLSerializer).serializeToString(s);return l},getFeatureFilterCountAsync:function(e,t,n,r,s){var a=this,i=this.workspace.server,o=this.buildGetFeatureFilterCountXML(e,t,n);return this.callback_obj=r,$.ajax({type:"post",url:i,data:o,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseCount(e);null!=s&&s(a.callback_obj,n)},complete:function(e,t){},error:function(){}}),a.count},getFeatureFilterOutput:function(e,t,n,r,s){var a=this.workspace.server,i='<?xml version="1.0" encoding="UTF-8"?><a/>',o=$.parseXML(i),l=new GeoBeans.FilterWriter,u=l.write(o,n);$(u).attr("xmlns:ogc","http://www.opengis.net/ogc"),$(u).attr("xmlns:gml","http://www.opengis.net/gml");var c=(new XMLSerializer).serializeToString(u),p="service="+this.workspace.service+"&version="+this.workspace.version+"&request=getFeature&typeName="+this.name+"&outputFormat=shape-zip&filter="+c;return null!=e&&(p+="&mapName="+e),null!=t&&(p+="&sourceName="+t),a+"?"+p},getMinMaxValue:function(e,t,n,r){if(null==r){var s=this.getMinMaxValueSyn(e,t,n);return s}this.getMinMaxValueAsync(e,t,n,r)},getMinMaxValueSyn:function(e,t,n){if(null==e)return null;var r=this,s=this.workspace.server,a="service="+this.workspace.service+"&version="+this.workspace.version+"&request=GetValue&typeName="+this.name+"&field="+e+"&type=minmax";return null!=t&&(a+="&mapName="+t),null!=n&&(a+="&sourceName="+n),$.ajax({type:"get",url:s,data:encodeURI(encodeURI(a)),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){var n=r.pareseMinMaxValue(e);this.minMaxValue=n},complete:function(e,t){},error:function(){}}),this.minMaxValue},getMinMaxValueAsync:function(e,t,n,r){if(null!=e){var s=this,a="service="+this.workspace.service+"&version="+this.workspace.version+"&request=GetValue&typeName="+this.name+"&field="+e+"&type=minmax";null!=t&&(a+="&mapName="+t),null!=n&&(a+="&sourceName="+n);var i=this.workspace.server;$.ajax({type:"get",url:i,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.pareseMinMaxValue(e);r(n)},complete:function(e,t){},error:function(){}})}},pareseMinMaxValue:function(e){var t=$(e).find("Min").text(),n=$(e).find("Max").text(),r=new Object;return r.min=t,r.max=n,r}});
GeoBeans.FieldType={DOUBLE:"double",STRING:"string",GEOMETRY:"geometry"},GeoBeans.Field=GeoBeans.Class({featureType:null,name:null,type:null,geomType:null,length:null,initialize:function(e,n,t,l){this.name=e,this.type=n,this.featureType=t,this.length=l},destroy:function(){this.name=null,this.type=null,this.featureType=null},setGeomType:function(e){this.geomType=e}});
GeoBeans.Filter=GeoBeans.Class({type:null,initialize:function(){},clone:function(){var e=new GeoBeans.Filter;return e.type=this.type,e}}),GeoBeans.Filter.Type={FilterID:"id",FilterComparsion:"comparsion",FilterLogic:"logic",FilterSpatial:"spatial"};
GeoBeans.FontManager=GeoBeans.Class({fonts:[],server:null,version:null,initialize:function(n,t){this.server=n,this.version=t},getFonts:function(){if(null!=this.fonts){if(0!=this.fonts.length)return this.fonts;var n=this,t="service=ims&version="+this.version+"&request=GetFont";return+name,$.ajax({type:"get",url:this.server,data:encodeURI(t),dataType:"xml",async:!1,beforeSend:function(n){},success:function(t,e){n.fonts=n.parseFonts(t)},complete:function(n,t){},error:function(){}}),n.fonts}},parseFonts:function(n){var t=[];return $(n).find("font").each(function(){var n=new Object,e=$(this).attr("face"),s=$(this).attr("family");n.face=e,n.family=s,t.push(n)}),t}});
GeoBeans.Geometry=GeoBeans.Class({id:null,extent:null,initialize:function(){},destory:function(){this.id=null,this.extent=null},getCentroid:function(){},hit:null}),GeoBeans.Geometry.Type={POINT:"Point",LINESTRING:"LineString",POLYGON:"Polygon",MULTIPOINT:"MultiPoint",MULTILINESTRING:"MultiLineString",MULTIPOLYGON:"MultiPolygon",CIRCLE:"Circle"},GeoBeans.Geometry.fromWKT=function(n){};
GeoBeans.InfoWindow=GeoBeans.Class({width:300,height:200,title:"Info",content:null,initialize:function(t,n){if(this.content=t,null!=n){var i=n.width;null!=i&&(this.width=i);var e=n.height;null!=e&&(this.height=e);var l=n.title;null!=l&&(this.title=l)}},getContent:function(){return this.content},getTitle:function(){return this.title}});
GeoBeans.Label=GeoBeans.Class({text:null,geometry:null,textSymbolizer:null,geometryType:null,initialize:function(){this.geometryType=GeoBeans.Geometry.Type.POINT},isCollision:function(e){return!0},computePosition:function(e,n){},adjustPosition:function(e,n){}});
GeoBeans.Layer=GeoBeans.Class({id:null,name:null,visible:!0,srid:"EPSG:4326",extent:null,map:null,events:null,canvas:null,renderer:null,mapPoint_lt:null,mapPoint_rb:null,transformation_brf:null,flag:null,initialize:function(n){this.name=n,this.events=new GeoBeans.Events,this.flag=GeoBeans.Layer.Flag.READY},destory:function(){this.name=null,this.events=null},setName:function(n){this.name=n},setMap:function(n){this.map=n;var t=this.map.canvas;if(null!=t){var e=t.height,a=t.width;this.canvas=document.createElement("canvas"),this.canvas.height=e,this.canvas.width=a,this.renderer=new GeoBeans.Renderer(this.canvas)}},setVisiable:function(n){this.visible=n},getExtent:function(){return this.extent},draw:null,load:null,unregisterEvents:function(){},cleanup:function(){},setTransformation:function(n){null!=n&&null!=n.view_c&&(this.transformation_brf=new GeoBeans.Transformation,this.transformation_brf.map=n.map,this.transformation_brf.scale=n.scale,this.transformation_brf.view_c=new GeoBeans.Geometry.Point(n.view_c.x,n.view_c.y),this.transformation_brf.view_h=n.view_h,this.transformation_brf.view_w=n.view_w,this.transformation_brf.win_cx=n.win_cx,this.transformation_brf.win_cy=n.win_cy,this.transformation_brf.win_h=n.win_h,this.transformation_brf.win_w=n.win_w)},drawLayerSnap:function(){var n=this.map.transformation,t=this.map.viewer;if(null!=t){var e=new GeoBeans.Geometry.Point(t.xmin,t.ymax),a=new GeoBeans.Geometry.Point(t.xmax,t.ymin),i=this.transformation_brf.toScreenPoint(e.x,e.y),r=this.transformation_brf.toScreenPoint(a.x,a.y),s=r.x-i.x,o=r.y-i.y;this.renderer.context.drawImage(this.canvas,i.x,i.y,s,o,0,0,this.map.canvas.width,this.map.canvas.height),this.map.renderer.drawImage(this.canvas,0,0),this.setTransformation(n)}},up:function(n){if(!(this instanceof GeoBeans.Layer.DBLayer))return void(null!=n&&n("不支持此操作"));for(var t=this.map.groupLayer.getLayers(),e=0;e<t.length;++e){var a=t[e];if(a==this){var i=e-1,r=t[i];if(null==r)return void(null!=n&&n("已经是底层图层"));for(var s=e;s>i;--s)t[s]=t[s-1];return t[i]=this,void(null!=n&&n("success"))}}null!=n&&n("调整顺序失败")},down:function(n){if(!(this instanceof GeoBeans.Layer.DBLayer))return void(null!=n&&n("不支持此操作"));for(var t=this.map.groupLayer.getLayers(),e=0;e<t.length;++e){var a=t[e];if(a==this){var i=e+1,r=t[i];if(null==r)return void(null!=n&&n("已经是顶层图层"));for(var s=e;i>s;++s)t[s]=t[s+1];return t[i]=this,void(null!=n&&n("success"))}}null!=n&&n("调整顺序失败")},CLASS_NAME:"GeoBeans.Layer"}),GeoBeans.Layer.Flag={READY:"ready",LOADED:"loaded",ERROR:"error"};
GeoBeans.Map=GeoBeans.Class({TOLERANCE:20,mapDiv:null,canvas:null,events:null,controls:null,viewer:null,center:null,level:null,resolution:null,layers:null,baseLayer:null,overlayLayer:null,srid:4326,minScale:null,maxScale:null,width:null,height:null,renderer:null,bgColor:"rgba(255,255,255,1)",tolerance:5,transformation:null,dragable:!0,snap:null,groupLayer:null,mapWorkspace:null,server:null,tracker:null,queryLayer:null,queryTrackLayer:null,queryGeometry:null,infoWindow:null,totalFlag:!0,panoramaLayer:null,initialize:function(e,t,r,a,n,i){var s=document.getElementById(t);if(null==s)return null;if(s.innerHTML="",null!=e&&null!=t&&null!=r){null!=a?this.extent=a:this.extent=new GeoBeans.Envelope(-180,-90,180,90),null!=n&&(this.srid=n),null!=i?this.viewer=i:this.viewer=this.extent,this.server=e,this.id=t,this.name=r,this.mapWorkspace=new GeoBeans.MapWorkspace(this.server,this),this.layers=[],this.mapDiv=$("#"+t);var l=this.id+"_canvas",o="<canvas id='"+l+"' height='"+$("#"+t).height()+"' width='"+$("#"+t).width()+"'></canvas>";$("#"+t).append(o),this.canvas=document.getElementById(l),this.width=$("#"+t).width(),this.height=$("#"+t).height(),this.center=new GeoBeans.Geometry.Point(0,0),this.transformation=new GeoBeans.Transformation(this),this.renderer=new GeoBeans.Renderer(this.canvas),this.controls=new GeoBeans.Control.Controls(this);var h=new GeoBeans.Control.DragMapControl(this);h.enable(!0),this.controls.add(h);var u=new GeoBeans.Control.SrollMapControl(this);u.enable(!0),this.controls.add(u);var y=new GeoBeans.Control.TrackControl;this.tracker=y,this.controls.add(y),null==this.mapNavControl&&(this.mapNavControl=new GeoBeans.Control.MapNavControl(this)),this.overlayLayer=new GeoBeans.Layer.OverlayLayer("overlay"),this.overlayLayer.setMap(this),this.groupLayer=new GeoBeans.Layer.GroupLayer(this.server,this.name),this.groupLayer.setMap(this),this.panoramaLayer=new GeoBeans.Layer.PanoramaLayer("panorama"),this.panoramaLayer.setMap(this),null!=this.viewer&&this.setViewer(this.viewer);var c,v=this;window.onresize=function(e){clearTimeout(c),c=setTimeout(function(){var t=v.mapDiv.height(),r=v.mapDiv.width();if(0!=t&&0!=r){console.log("before:height["+v.canvas.height+"]"),v.canvas.height=t,v.canvas.width=r,console.log("after:height["+v.canvas.height+"]"),v.height=t,v.width=r;var a=v.viewer;if(null!=a){var n=a.xmin,i=a.xmax,s=a.ymin,l=a.ymax;if(!($.isNumeric(n)&&$.isNumeric(i)&&$.isNumeric(s)&&$.isNumeric(l)))return}if(null!=v.viewer){if(null!=v.baseLayer){var o=v.baseLayer.canvas;null!=o&&(o.height=t,o.width=r),v.baseLayer.scale=1;var h=v.level;v.resolution=v.baseLayer.getResolution(h),v.updateMapExtent(v.resolution);var u=v.center;v.setCenter(u)}var y=null;y="width"==e?v.scaleViewWidth(v.viewer):"height"==e?v.scaleViewHeight(v.viewer):v.scaleView(v.viewer),v.viewer=y,console.log(v.viewer.toString()),v.transformation.update();for(var c=v.getLayers(),p=0;p<c.length;++p){var d=c[p];if(null!=d){var f=d.canvas;null!=f&&(f.height=t,f.width=r);var L=d.bufferCanvas;null!=L&&(L.height=t,L.width=r)}}var g=v.groupLayer;null!=g&&(g.canvas.height=t,g.canvas.width=r,g.flag=GeoBeans.Layer.Flag.READY),v.draw()}}},250)};var p=window.onresize;p.apply(window,[]),this.queryLayer=new GeoBeans.Layer.FeatureLayer.QueryLayer("query"),this.queryLayer.setMap(this);var d="<div class='infoWindow' data-toggle='popover' title='Info' data-content=''></div>";$("#"+t).append(d),this.infoWindow=this.mapDiv.find(".infoWindow"),void 0!=this.infoWindow&&void 0!=this.infoWindow.popover&&this.infoWindow.popover({animation:!1,trigger:"manual",placement:"top",html:!0})}},destroy:function(){this.canvas=null,this.renderer=null,this.layers=null,this.transformation=null,this.controls.cleanup(),this.controls=null},resize:function(e){var t=window.onresize;t.apply(window,[e])},getLayers:function(){for(var e=[],t=this.groupLayer.getLayers(),r=0;r<t.length;++r)e.push(t[r]);for(var r=0;r<this.layers.length;++r)e.push(this.layers[r]);return e},getLayer:function(e){if(null!=e){for(var t=null,r=this.groupLayer.getLayers(),a=null,n=0;n<r.length;++n)if(a=r[n],a.name==e)return a;for(var n=0;n<this.layers.length;++n){var t=this.layers[n];if(t.name==e)return t}}},addLayer:function(e,t){if(null==e)return void(null!=t&&t("layer is null"));var r=this.getLayer(e.name);if(null!=r)return void(null!=t&&t("this map has ["+e.name+"] layer"));if(null!=e)if(e instanceof GeoBeans.Layer.DBLayer)this.mapWorkspace.registerLayer(e,this.addLayer_callback,t);else if(e instanceof GeoBeans.Layer.WMTSLayer)if(e.setMap(this),null==this.baseLayer){if(this.setBaseLayer(e),null==this.level){var a=this.getLevel(this.viewer);this.setLevel(a)}}else this.layers.push(e);else this.layers.push(e),e.setMap(this),null!=t&&t("success")},insertLayer:function(e,t){if(null==e)return void(null!=t&&t("layer is null"));var r=this.getLayer(e.name);if(null!=r)return void(null!=t&&t("this map has ["+e.name+"] layer"));if(null!=e)if(e instanceof GeoBeans.Layer.DBLayer)this.mapWorkspace.registerLayer(e,this.insertLayer_callback,t);else if(e instanceof GeoBeans.Layer.WMTSLayer){if(e.setMap(this),null!=this.baseLayer)return void(null!=t&&t("this map has another base layer"));if(this.setBaseLayer(e),null==this.level){var a=this.getLevel(this.viewer);this.setLevel(a)}null!=t&&t("success")}else this.layers.unshift(e),e.setMap(this),null!=t&&t("success")},addLayer_callback:function(e,t,r,a){e instanceof GeoBeans.Layer?(e instanceof GeoBeans.Layer.DBLayer&&(t.groupLayer.addLayer(e),e.setMap(t)),null!=a&&a("success"),t.draw()):null!=a&&a(e)},insertLayer_callback:function(e,t,r,a){e instanceof GeoBeans.Layer?(e instanceof GeoBeans.Layer.DBLayer&&(t.groupLayer.insertLayer(e),e.setMap(t)),null!=a&&a("success",r),t.draw()):null!=a&&a(e)},removeLayer:function(e,t){if(null!=e){var r=this.getLayer(e);if(null!=r)if(r instanceof GeoBeans.Layer.DBLayer)this.mapWorkspace.unRegisterLayer(e,this.unRegisterLayer_callback,t);else for(var a=this.layers,n=0;n<a.length;++n)r.name==a[n].name&&(this.layers.splice(n,1),r.cleanup(),void 0!=t&&t("success"))}},unRegisterLayer_callback:function(e,t,r,a){var n=t.getLayer(r);"success"==e?(n instanceof GeoBeans.Layer.DBLayer&&t.groupLayer.removeLayer(n),t.draw(),null!=a&&a(e)):null!=a&&a(e)},setStyle:function(e,t,r){var a=this.getLayer(e);a instanceof GeoBeans.Layer.FeatureDBLayer?this.mapWorkspace.setStyle(e,t,this.setStyle_callback,r):a instanceof GeoBeans.Layer.WFSLayer&&(a.setStyle(t),r("set "+a.name+"style "))},setStyle_callback:function(e,t,r,a,n){var i=t.getLayer(r);i instanceof GeoBeans.Layer.DBLayer&&(t.groupLayer.update(),i.update()),"success"==e?(i.setStyle(a),n(e)):n(e)},removeBaseLayer:function(){this.baseLayer=null,this.level=null},setViewer:function(e){null!=e&&(this.viewer=this.scaleView(e),this.transformation.update())},getViewer:function(){return this.viewer},setCenter:function(e){if(null!=this.viewer){var t=e.x-this.center.x,r=e.y-this.center.y;this.viewer.offset(t,r),this.center=e,this.transformation.update()}else this.center=e},offset:function(e,t){null!=this.viewer?(this.viewer.offset(e,t),this.center.x+=e,this.center.y+=t,this.transformation.update()):(this.center.x+=e,this.center.y+=t)},setLevel:function(e){this.level=e,null!=this.baseLayer&&(this.baseLayer.scale=1,this.resolution=this.baseLayer.getResolution(e),this.updateMapExtent(this.resolution),this.transformation.update())},formulateExtent:function(e){},setResolution:function(e){this.resolution=e},setBaseLayer:function(e){this.baseLayer=e,null!=this.baseLayer&&this.baseLayer.setMap(this)},updateMapExtent:function(e){var t=this.center.x,r=this.center.y,a=this.width,n=this.height,i=e*a/2,s=e*n/2,l=t-i,o=t+i,h=r-s,u=r+s;null!=this.viewer?(this.viewer.xmin=l,this.viewer.xmax=o,this.viewer.ymin=h,this.viewer.ymax=u):this.viewer=new GeoBeans.Envelope(l,h,o,u)},getLevel:function(e){var t=e.getCenter().x,r=e.getCenter().y,a=this.width,n=(this.height,t-e.xmin),i=(r-e.ymin,2*n/a);if(null==this.baseLayer)return null;var s=this.baseLayer.getLevel(i);return null==s?1:s},setDrawLayerSingle:function(e){e?this.totalFlag=!1:this.totalFlag=!0},draw:function(){this.renderer.save(),null!=this.baseLayer?this.baseLayer.visible?(this.baseLayer.preDraw(),this.baseLayer.loadingTiles(this.drawBaseLayerCallback)):this.drawLayersAll():(this.drawLayersAll(),this.renderer.restore()),this.mapNavControl.setZoomSlider(this.level)},drawBaseLayerCallback:function(e){e.drawLayersAll(),e.renderer.restore()},drawHitLayer:function(){this.renderer.clearRect(0,0,this.canvas.width,this.canvas.height),null!=this.baseLayer&&this.renderer.drawImage(this.baseLayer.canvas,0,0,this.baseLayer.canvas.width,this.baseLayer.canvas.height);for(var e=0;e<this.layers.length;++e){var t=this.layers[e],r=t.canvas;this.renderer.drawImage(r,0,0,r.width,r.height);var a=t.hitCanvas;null!=a&&this.renderer.drawImage(a,0,0,a.width,a.height)}},drawLayersAll:function(){0!=this.groupLayer.getLayers().length&&(this.totalFlag?this.groupLayer.loadTotal():this.groupLayer.load());for(var e=0;e<this.layers.length;++e){var t=this.layers[e];t.visible&&t.load()}if(this.overlayLayer.load(),this.queryLayer.load(),this.panoramaLayer.load(),0==this.groupLayer.getLayers().length||this.groupLayer.flag!=GeoBeans.Layer.Flag.READY){for(var e=0;e<this.layers.length;++e)if(t.visible&&t.flag!=GeoBeans.Layer.Flag.LOADED)return;var r=this.overlayLayer.getLoadFlag();if(r==GeoBeans.Layer.Flag.LOADED&&this.queryLayer.flag==GeoBeans.Layer.Flag.LOADED){var a=this.panoramaLayer.getLoadFlag();if(a==GeoBeans.Layer.Flag.LOADED){if(this.renderer.clearRect(0,0,this.canvas.width,this.canvas.height),null!=this.baseLayer&&this.baseLayer.visible&&this.renderer.drawImage(this.baseLayer.canvas,0,0,this.baseLayer.canvas.width,this.baseLayer.canvas.height),0!=this.groupLayer.getLayers().length&&this.groupLayer.visible&&this.groupLayer.flag==GeoBeans.Layer.Flag.LOADED){var n=this.groupLayer.canvas;this.renderer.drawImage(n,0,0,n.width,n.height);for(var i=this.groupLayer.getLayers(),e=0;e<i.length;++e){var s=i[e],l=s.heatMapLayer;if(null!=l){var o=l.canvas;null!=o&&l.visible&&s.visible&&this.renderer.drawImage(o,0,0,o.width,o.height)}}}for(var e=0;e<this.layers.length;++e){var t=this.layers[e];if(t.visible){var o=t.canvas;null!=o&&this.renderer.drawImage(o,0,0,o.width,o.height);var h=t.hitCanvas;null!=h&&this.renderer.drawImage(h,0,0,h.width,h.height);var u=t.bufferCanvas;null!=u&&this.renderer.drawImage(u,0,0,u.width,u.height),t instanceof GeoBeans.Layer.ChartLayer&&t.showLegend()}else t instanceof GeoBeans.Layer.ChartLayer&&t.hideLegend()}var o=this.overlayLayer.canvas;this.renderer.drawImage(o,0,0,o.width,o.height);var y=this.overlayLayer.hitCanvas;null!=y&&this.renderer.drawImage(y,0,0,y.width,y.height);var c=this.overlayLayer.editCanvas;null!=c&&this.renderer.drawImage(c,0,0,c.width,c.height);var v=this.queryLayer.canvas;null!=v&&this.renderer.drawImage(v,0,0,v.width,v.height);var p=this.panoramaLayer.canvas;null!=p&&this.renderer.drawImage(p,0,0,p.width,p.height);var d=this;if(null!=this.infoWindow){var f=this.mapDiv.find(".popover");if(1==f.length){var L=this.infoWindow.attr("x"),g=this.infoWindow.attr("y");if(!this.viewer.contain(L,g))return this.infoWindow.popover("hide"),void d.queryLayer.clearFeatures();var w=this.transformation.toScreenPoint(L,g);this.infoWindow.css("left",w.x+"px"),this.infoWindow.css("top",w.y+"px"),this.infoWindow.popover("hide").popover("show"),this.mapDiv.find(".popover-title").append('<button type="button" class="close">&times;</button>'),this.mapDiv.find(".popover-title .close").click(function(){$(this).parents(".popover").popover("hide")})}}}}}},drawCache:function(){this.drawBackground(),null!=this.baseLayer&&this.baseLayer.drawCache()},drawBackground:function(){var e=this.renderer.context;e.fillStyle=this.bgColor,e.fillRect(0,0,this.width,this.height)},enableDrag:function(e){var t=this.controls.find(GeoBeans.Control.Type.DRAG_MAP);t>=0&&this.controls.get(t).enable(e)},addEventListener:function(e,t){var r=this;this.canvas.addEventListener(e,function(e){var a=e.layerX,n=e.layerY;if(null!=r.transformation){var i=r.transformation.toMapPoint(a,n),s=new GeoBeans.Event.MouseArgs;s.buttn=null,s.X=a,s.Y=n,s.mapX=i.x,s.mapY=i.y,t(s)}})},scaleView:function(e){if(null==e)return null;var t=e.getWidth()/e.getHeight(),r=this.width/this.height;this.center=e.getCenter();var a=null;if(t>r){var n=e.getWidth()/2,i=n/r;a=new GeoBeans.Envelope(e.xmin,this.center.y-i,e.xmax,this.center.y+i)}else{var i=e.getHeight()/2,n=i*r;a=new GeoBeans.Envelope(this.center.x-n,e.ymin,this.center.x+n,e.ymax)}return a},scaleViewWidth:function(e){if(null==e)return null;this.center=e.getCenter();var t=this.width/this.height,r=e.getHeight()/2,a=r*t,n=new GeoBeans.Envelope(this.center.x-a,e.ymin,this.center.x+a,e.ymax);return n},scaleViewHeight:function(e){if(null==e)return null;this.center=e.getCenter();var t=this.width/this.height,r=e.getWidth()/2,a=r/t,n=new GeoBeans.Envelope(e.xmin,this.center.y-a,e.xmax,this.center.y+a);return n},screenCopy:function(){var e=this.renderer.context.getImageData(0,0,this.canvas.width,this.canvas.height);return e},saveSnap:function(){this.snap=this.renderer.context.getImageData(0,0,this.canvas.width,this.canvas.height)},restoreSnap:function(){null!=this.snap&&this.renderer.context.putImageData(this.snap,0,0)},putSnap:function(e,t){"undefined"==e&&(e=0),"undefined"==t&&(t=0),null!=this.snap&&this.renderer.context.putImageData(this.snap,e,t)},cleanupSnap:function(){this.snap=null},drawBaseLayerSnap:function(e){var t=(this.center.x,this.center.y,null),r=null,a=null,n=null,i=e-this.level,s=Math.pow(2,i);if(a=this.width*s,n=this.height*s,t=0-.5*((Math.pow(2,i)-1)*this.width),r=0-.5*((Math.pow(2,i)-1)*this.height),null!=this.snap){var l=$("<canvas>").attr("width",this.snap.width).attr("height",this.snap.height)[0];l.getContext("2d").putImageData(this.snap,0,0),this.renderer.context.drawImage(l,t,r,a,n)}},drawLayersSnap:function(e){var t=(this.center.x,this.center.y,null),r=null,a=null,n=null;if(a=this.width/e,n=this.height/e,t=this.width/2-.5*a,r=this.height/2-.5*n,null!=this.snap){var i=$("<canvas>").attr("width",this.snap.width).attr("height",this.snap.height)[0];i.getContext("2d").putImageData(this.snap,0,0),this.renderer.context.drawImage(i,t,r,a,n)}},setNavControl:function(e){null==this.mapNavControl&&(this.mapNavControl=new GeoBeans.Control.MapNavControl(this)),this.mapNavControl.setEnable(e)},addOverlay:function(e){this.overlayLayer.addOverlay(e)},addOverlays:function(e){this.overlayLayer.addOverlays(e)},removeOverlay:function(e){this.overlayLayer.removeOverlay(e)},removeOverlayObj:function(e){this.overlayLayer.removeOverlayObj(e)},removeOverlays:function(e){this.overlayLayer.removeOverlays(e)},clearOverlays:function(){this.overlayLayer.clearOverlays()},getOverlays:function(){return this.overlayLayer.overlays},getOverlay:function(e){return this.overlayLayer.overlays[e]},getOverlayIndex:function(e){return this.overlayLayer.getOverlayIndex(e)},setFitView:function(e){var t=e.getExtent();this.viewer=this.scaleView(t),this.transformation.update();var r=this.getLevel(this.viewer);this.setLevel(r),this.draw()},registerOverlayEvent:function(){this.overlayLayer.registerHitEvent()},unregisterOverlayEvent:function(){this.overlayLayer.unregisterHitEvent()},drawGeometry:function(){},queryByRect:function(e,t){if(null!=e){var r=this.getLayer(e);null!=r&&r.type==GeoBeans.Layer.DBLayer.Type.Feature&&(this.queryLayer.clearFeatures(),this.queryTrackLayer=null,this.queryGeometry=null,this.tracker.trackRect(this.trackRect_callback,this,r,t))}},trackRect_callback:function(e,t,r,a){null!=e&&(t.tracker.end(),t.queryGeometry=e,t.queryTrackLayer=r,t.queryLayer.setLayer(r),r.getFeatureCount(e,a))},queryByRectPage:function(e,t){if(null!=this.queryTrackLayer&&null!=this.queryGeometry){var r=this.queryTrackLayer.getFeatureBBoxGet(this.queryGeometry,e,t);return this.queryLayer.setFeatures(r),this.drawLayersAll(),r}return null},queryByRectOutput:function(e,t){if(null!=this.queryTrackLayer&&null!=this.queryGeometry){var r=this.queryTrackLayer.getFeautureBBoxGetOutput(this.queryGeometry,e,t);return r}return null},setFeatureBlink:function(e,t){null!=e&&null!=t&&this.queryLayer.setFeatureBlink(e,t)},addHeatMap:function(e,t,r){var a=this.getLayer(e);null!=a&&a instanceof GeoBeans.Layer.DBLayer&&a.addHeatMap(t,r)},removeHeatMap:function(e){var t=this.getLayer(e);null!=t&&t.removeHeatMap()},setHeatMapVisible:function(e,t){var r=this.getLayer(e);null!=r&&r.setHeatMapVisible(t)},queryByClick:function(e,t){if(this.endQuery(),null!=e){var r=this.getLayer(e);null!=r&&r.type==GeoBeans.Layer.DBLayer.Type.Feature&&this.tracker.trackInfo(this.queryByClick_callback,r,this,t)}},queryByClick_callback:function(e,t,r,a){if(null!=e&&null!=t){var n=r.transformation.toMapPoint(e.x,e.y),i=new GeoBeans.Geometry.Point(e.x-r.tolerance/2,e.y-r.tolerance/2),s=new GeoBeans.Geometry.Point(e.x+r.tolerance/2,e.y+r.tolerance/2),l=r.transformation.toMapPoint(i.x,i.y),o=r.transformation.toMapPoint(s.x,s.y),h=new GeoBeans.Envelope(l.x,o.y,o.x,l.y),u=null;if(u=t.geomType==GeoBeans.Geometry.Type.POLYGON||t.geomType==GeoBeans.Geometry.Type.MULTIPOLYGON?t.getFeaturesWithin(n):t.getFeatureBBoxGet(h,null,null),null==u||0==u.length)return r.infoWindow.popover("hide"),void r.queryLayer.clearFeatures();var y=u[0];null!=a&&a(t,y,n),r.queryLayer.setLayer(t),r.queryLayer.setFeatures([y]),r.drawLayersAll()}},queryByPolygon:function(e,t){if(null!=e){var r=this.getLayer(e);null!=r&&r.type==GeoBeans.Layer.DBLayer.Type.Feature&&(this.queryLayer.clearFeatures(),this.queryTrackLayer=null,this.queryGeometry=null,this.tracker.trackPolygon(this.trackPolygon_callback,this,r,t))}},trackPolygon_callback:function(e,t,r,a){if(null!=e&&null!=t&&null!=r){t.tracker.end(),t.queryGeometry=e,t.queryTrackLayer=r,t.queryLayer.setLayer(r);var n=new GeoBeans.SpatialFilter;n.geometry=e,n.operator=GeoBeans.SpatialFilter.OperatorType.SpOprIntersects;var i=r.getFeatureType(),s=i.geomFieldName;n.propName=s,r.getFeatureFilterCountAsync(n,a)}},queryByPolygonPage:function(e,t){if(null!=this.queryTrackLayer&&null!=this.queryGeometry){var r=new GeoBeans.SpatialFilter;r.geometry=this.queryGeometry,r.operator=GeoBeans.SpatialFilter.OperatorType.SpOprIntersects;var a=this.queryTrackLayer.getFeatureType(),n=a.geomFieldName;r.propName=n;var i=this.queryTrackLayer.getFeatureFilter(r,e,t,null);return this.queryLayer.setFeatures(i),this.drawLayersAll(),i}return null},queryByPolygonOutput:function(e,t){if(null!=this.queryTrackLayer&&null!=this.queryGeometry){var r=new GeoBeans.SpatialFilter;r.geometry=this.queryGeometry,r.operator=GeoBeans.SpatialFilter.OperatorType.SpOprIntersects;var a=this.queryTrackLayer.getFeatureType(),n=a.geomFieldName;r.propName=n;var i=this.queryByFilterOutput(this.queryTrackLayer.name,r,e,t);return i}return null},queryByLine:function(e,t){if(null!=e){var r=this.getLayer(e);null!=r&&r.type==GeoBeans.Layer.DBLayer.Type.Feature&&(this.queryLayer.clearFeatures(),this.queryTrackLayer=null,this.queryGeometry=null,this.tracker.trackLine(this.trackLine_callback,this,r,t))}},trackLine_callback:function(e,t,r,a){if(null!=e&&null!=t&&null!=r){t.tracker.end(),t.queryGeometry=e,t.queryTrackLayer=r,t.queryLayer.setLayer(r);var n=new GeoBeans.SpatialFilter;n.geometry=e,n.operator=GeoBeans.SpatialFilter.OperatorType.SpOprIntersects;var i=r.getFeatureType(),s=i.geomFieldName;n.propName=s,r.getFeatureFilterCountAsync(n,a)}},queryByLinePage:function(e,t){if(null!=this.queryTrackLayer&&null!=this.queryGeometry){var r=new GeoBeans.SpatialFilter;r.geometry=this.queryGeometry,r.operator=GeoBeans.SpatialFilter.OperatorType.SpOprIntersects;var a=this.queryTrackLayer.getFeatureType(),n=a.geomFieldName;r.propName=n;var i=this.queryTrackLayer.getFeatureFilter(r,e,t,null);return this.queryLayer.setFeatures(i),this.drawLayersAll(),i}return null},queryByLineOutput:function(e,t){if(null!=this.queryTrackLayer&&null!=this.queryGeometry){var r=new GeoBeans.SpatialFilter;r.geometry=this.queryGeometry,r.operator=GeoBeans.SpatialFilter.OperatorType.SpOprIntersects;var a=this.queryTrackLayer.getFeatureType(),n=a.geomFieldName;r.propName=n;var i=this.queryByFilterOutput(this.queryTrackLayer.name,r,e,t);return i}return null},endQuery:function(){this.tracker.end(),this.queryLayer.clearFeatures(),this.infoWindow.popover("hide")},openInfoWindow:function(e,t){if(null!=e&&null!=t){var r=t.x,a=t.y,n=this.transformation.toScreenPoint(r,a),i=n.x,s=n.y;this.infoWindow.attr("x",r),this.infoWindow.attr("y",a),this.infoWindow.css("left",i+"px"),this.infoWindow.css("top",s+"px");var l=e.getTitle(),o=e.getContent();this.infoWindow.popover("hide").attr("data-content",o).attr("data-original-title",l).popover("show"),this.mapDiv.find(".popover-title").append('<button type="button" class="close">&times;</button>'),this.mapDiv.find(".popover-title .close").click(function(){$(this).parents(".popover").popover("hide")})}},closeInfoWindow:function(){null!=this.infoWindow&&this.infoWindow.popover("hide")},zoomToLayer:function(e){if(null!=e){var t=this.getLayer(e);if(null!=t){t instanceof GeoBeans.Layer.DBLayer&&t.update();var r=t.getExtent();if(null!=r){if(null!=this.baseLayer){var a=this.getLevel(r);if(null==a)return;var n=r.getCenter();this.setLevel(a),this.setCenter(n)}else this.setViewer(r);this.draw()}}}},zoomToBaseLayer:function(){if(null!=this.baseLayer){var e=this.baseLayer.extent;if(null!=e||(this.baseLayer instanceof GeoBeans.Layer.QSLayer&&(e=new GeoBeans.Envelope(-180,-90,180,90)),null!=e)){var t=this.getLevel(e);if(null!=t){this.setLevel(t);var r=e.getCenter();null!=r&&(this.setCenter(r),this.draw())}}}},getFeatures:function(e,t,r){if(null==e)return null;var a=this.getLayer(e);if(null!=a&&a instanceof GeoBeans.Layer.DBLayer){var n=a.getFeatureBBoxGet(null,t,r);return n}return null},getFeatureFilter:function(e,t,r,a){var n=this.getLayer(e);if(null==n)return null;this.queryLayer.setLayer(n);var i=n.getFeatureFilter(t,r,a);return this.queryLayer.setFeatures(i),this.drawLayersAll(),i},getFeatureFilterCount:function(e,t){var r=this.getLayer(e);if(null==r)return null;var a=r.getFeatureFilterCount(t);return a},queryByFilterOutput:function(e,t,r,a){var n=this.getLayer(e);if(null==n)return null;var i=n.getFeatureFilterOutput(t,r,a);return i},getRangeChartStyle:function(e,t,r,a,n,i,s,l){if(null==e||null==t||null==r||null==a||null==n||null==i||null==s||null==l)return null;var o=new GeoBeans.Layer.ChartLayer("tmp",e,t,r,a,n,[i]);o.setMap(this);var h=o.chartFeatures;if(null==h||0==h.length)return null;var u=h[0].featureType,y=u.getFieldIndex(i),c=this.getRangeChartNodes(h,y,s);if(null==c||0==c.length)return null;var v=new GeoBeans.StyleManager(this.server),p=v.getColorMap(l,s),d=this.getRangeChartStyleByNodes(h,y,c,p);return null!=d&&(d.nodes=c),d},getRangeChartNodes:function(e,t,r){if(null==e||null==t||null==r)return null;for(var a=null,n=null,i=null,s=0;s<e.length;++s){if(a=e[s],null==a)return;var l=a.values,o=l[t];o=parseFloat(o),null!=o&&(n=null==n?o:n>o?o:n,i=null==i?o:o>i?o:i)}if(null==i||null==n||i==n)return null;for(var h=(i-n)/r,u=[],s=0;r>s;++s){var y=n+h*s;u.push(y)}return u.push(i),u},getRangeChartStyleByNodes:function(e,t,r,a){for(var n=new GeoBeans.Style.FeatureStyle("chart",GeoBeans.Style.FeatureStyle.GeomType.Polygon),i=[],s=0;s<r.length-1;++s){var l=r[s],o=r[s+1],h=a[s],u=new GeoBeans.Symbolizer.PolygonSymbolizer,y=new GeoBeans.Color;y.setByHex(h,1),u.fill.color=y,y=new GeoBeans.Color,y.setByHex("#cccccc",1),u.stroke.color=y;for(var c=new GeoBeans.IDFilter,v=0;v<e.length;++v){var p=e[v];if(null!=p){var d=p.values;if(null!=d){var f=d[t];if(null!=f&&f>=l&&o>=f){var L=p.gid;c.addID(L)}}}}var g=new GeoBeans.Rule;g.filter=c,g.name=s,g.symbolizer=u,i.push(g)}return n.rules=i,n},close:function(){this.mapDiv.find(".chart-legend").remove(),this.mapDiv.find("canvas").remove(),this.renderer.clearRect(0,0,this.canvas.width,this.canvas.height),this.setNavControl(!1),this.controls.cleanup(),this.infoWindow.popover("destroy"),this.infoWindow=null,this.destroy()},describeLayer:function(e,t){return null==e?void(null!=t&&t("layername is null")):void this.mapWorkspace.describeLayer(e,this.describeLayer_callback,t)},describeLayer_callback:function(e,t){null!=t&&t(e)},refresh:function(){},addPanorama:function(e,t,r,a){this.panoramaLayer.addMarker(e,t,r,a)},removePanorama:function(e){this.panoramaLayer.removeMarker(e)},clearPanoramas:function(){this.panoramaLayer.clearMarkers()}});
GeoBeans.MapManager=GeoBeans.Class({service:"ims",version:"1.0.0",server:null,maps:null,getMap_u_id:null,getMap_u_map:null,createMap_u_id:null,createMap_u_name:null,createMap_u_extent:null,createMap_u_srid:null,removeMap_u_callback:null,initialize:function(e){this.server=e+"/mgr",this.maps=[]},getMaps:function(e){var a=this,r="service="+this.service+"&version="+this.version+"&request=describeMap";$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(r,t){a.maps=a.parseMaps(r),void 0!=e&&e(a.maps)},complete:function(e,a){},error:function(){}})},getMap:function(e,a){if(null!=e&&null!=a&&""!=a){this.getMap_u_id=e;var r=this,t="service="+this.service+"&version="+this.version+"&request=describeMap&name="+a;return $.ajax({type:"get",url:this.server,data:encodeURI(t),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,a){var t=r.parseMap(e);r.getMap_u_map=t},complete:function(e,a){},error:function(){}}),r.getMap_u_map}},createMap:function(e,a,r,t,n){if(null!=a&&null!=r&&null!=t){this.createMap_u_id=e,this.createMap_u_name=a,this.createMap_u_extent=r,this.createMap_u_srid=t,this.createMap_u_callback=n;var i=r.toString(),s=this,l="service="+this.service+"&version="+this.version+"&request=CreateMap&name="+a+"&extent="+i+"&srid="+t;$.ajax({type:"get",url:this.server,data:encodeURI(l),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,a){var r=s.parseCreateMap(e);s.createMap_callback(r)},complete:function(e,a){},error:function(){}})}},removeMap:function(e){if(null!=e&&""!=e){var a=this,r="service="+this.service+"&version="+this.version+"&request=RemoveMap&name="+e;return this.removeMapResult=null,$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,r){var t=a.parseRemoveMap(e);a.removeMapResult=t},complete:function(e,a){},error:function(){}}),this.removeMapResult}},parseMaps:function(e){var a=[],r=this;return $(e).find("Map").each(function(){var e=new Object,t=$(this).find("Name").text(),n=$(this).find("Srid").text(),i=$(this).find("BoundingBox"),s=r.parseBoundingBox(i),l=$(this).find("Thumbnail").attr("xlink");e.name=t,e.srid=n,e.extent=s,l.length-l.lastIndexOf(".png")==4&&(e.thumbnail=l),a.push(e)}),a},parseMap:function(e){var a=$(e).find("ExceptionText").text();if(""!=a)return console.log(a),null;var r=this,t=$(e).find("Name:first").text(),n=$(e).find("Srid:first").text(),i=$(e).find("BoundingBox:first"),s=r.parseBoundingBox(i),l=$(e).find("Viewer:first"),u=r.parseBoundingBox(l),o=new GeoBeans.Map(r.server,r.getMap_u_id,t,s,n,u);return $(e).find("Capability>Layer").each(function(){var e=r.parseLayer(this);if(e instanceof GeoBeans.Layer.GroupLayer)for(var a=e.getLayers(),t=0;t<a.length;++t){var n=a[t];n.setMap(o),o.groupLayer.addLayer(n)}else o.addLayer(e)}),o},parseBoundingBox:function(e){if(null==e)return null;var a=parseFloat($(e).attr("minx")),r=parseFloat($(e).attr("miny")),t=parseFloat($(e).attr("maxx")),n=parseFloat($(e).attr("maxy"));return $.isNumeric(a)&&$.isNumeric(t)&&$.isNumeric(r)&&$.isNumeric(n)?new GeoBeans.Envelope(a,r,t,n):null},parseLayer:function(e){if(null==e)return null;var a=null,r=$(e).find("Type").first().text();return"Group"==r&&(a=this.parseGroupLayer(e)),a},parseGroupLayer:function(e){if(null==e)return null;var a=this,r=$(e).find("Name:first").text(),t=$(e).find("BoundingBox:first"),n=this.parseBoundingBox(t),i=new GeoBeans.Layer.GroupLayer(r);return i.extent=n,$(e).find("Layer").each(function(){var e=a.parseDBLayer(this);i.addLayer(e)}),i},parseDBLayer:function(e){if(null==e)return null;var a=null,r=$(e).attr("id"),t=$(e).find("Name:first").text(),n=parseInt($(e).attr("queryable")),i=parseInt($(e).attr("visible"));i=1==i?!0:!1;var s=$(e).find("Type").first().text(),l=null;switch(s.toLowerCase()){case"raster":l=GeoBeans.Layer.DBLayer.Type.Raster;break;case"feature":l=GeoBeans.Layer.DBLayer.Type.Feature}var u=$(e).find("BoundingBox:first"),o=this.parseBoundingBox(u);if(l==GeoBeans.Layer.DBLayer.Type.Raster)a=new GeoBeans.Layer.RasterDBLayer(t,parseInt(r),null,null,n,i,null),a.extent=o;else if(l==GeoBeans.Layer.DBLayer.Type.Feature){var p=$(e).find("Style>Name").text(),c=$(e).find("GeometryType").text(),f=null;switch(c.toUpperCase()){case"POINT":f=GeoBeans.Geometry.Type.POINT;break;case"LINESTRING":f=GeoBeans.Geometry.Type.LINESTRING;break;case"POLYGON":f=GeoBeans.Geometry.Type.POLYGON;break;case"MULTIPOINT":f=GeoBeans.Geometry.Type.MULTIPOINT;break;case"MULTILINESTRING":f=GeoBeans.Geometry.Type.MULTILINESTRING;break;case"MULTIPOLYGON":f=GeoBeans.Geometry.Type.MULTIPOLYGON}a=new GeoBeans.Layer.FeatureDBLayer(t,parseInt(r),null,null,n,i,p),a.extent=o,a.geomType=f}return a},parseCreateMap:function(e){var a=$(e).find("CreateMap").text();if("success"==a.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},createMap_callback:function(e){if(null!=this.createMap_u_callback){if("success"!=e)return void this.createMap_u_callback(null,e);var a=new GeoBeans.Map(this.server,this.createMap_u_id,this.createMap_u_name,this.createMap_u_extent,this.createMap_u_srid);this.createMap_u_callback(a,e)}},parseRemoveMap:function(e){var a=$(e).find("RemoveMap").text();if("success"==a.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},removeMap_callback:function(e){null!=this.removeMap_u_callback&&this.removeMap_u_callback(e)},saveMap:function(e,a){if(null==e&&null!=a)return void a("map is null");var r=this.buildSaveMapXML(e);if(null==r&&null!=a)return void a("map is null");var t=this;$.ajax({type:"post",url:this.server,data:r,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var n=t.parseSaveMap(e);null!=a&&a(n)},complete:function(e,a){},error:function(){}})},buildSaveMapXML:function(e){if(null==e)return null;var a=$.parseXML('<?xml version="1.0"?><SaveMap service="ims" version="1.0.0" user="user1"/>'),r=e.name,t=a.createElement("Name");$(t).text(r),$("SaveMap",a).append(t);var n=e.srid,i=a.createElement("Srid");$(i).text(n),$("SaveMap",a).append(i);var s=e.extent;if(null!=s){var l=a.createElement("Extent");$(l).attr("xmin",s.xmin),$(l).attr("ymin",s.ymin),$(l).attr("xmax",s.xmax),$(l).attr("ymax",s.ymax),$("SaveMap",a).append(l)}var u=e.viewer;if(null!=u){var o=a.createElement("Viewer");$(o).attr("xmin",u.xmin),$(o).attr("ymin",u.ymin),$(o).attr("xmax",u.xmax),$(o).attr("ymax",u.ymax),$("SaveMap",a).append(o)}for(var p=a.createElement("Layers"),c=e.getLayers(),f=null,v=0;v<c.length;++v)if(f=c[v],null!=f&&f instanceof GeoBeans.Layer.DBLayer){var d=a.createElement("Layer"),r=f.name;null!=r&&$(d).attr("name",r);var m=f.id;null!=m&&$(d).attr("id",m);var y=f.visible;y=y?1:0,$(d).attr("visible",y),$(p).append(d)}if($("SaveMap",a).append(p),null!=a){var h=(new XMLSerializer).serializeToString(a);return h}return null},parseSaveMap:function(e){var a=$(e).find("SaveMap").text();if("success"==a.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},getMapByName:function(e){if(null==e)return null;if(null==this.maps)return null;for(var a=null,r=null,t=0;t<this.maps.length;++t)if(a=this.maps[t],null!=a&&(r=a.name,r==e))return a;return null},getMapByNameChar:function(e){if(null==e)return[];if(null==this.maps)return[];for(var a=null,r=null,t=[],n=0;n<this.maps.length;++n)a=this.maps[n],null!=a&&(r=a.name,0==r.indexOf(e)&&t.push(a));return t},getMapObj:function(e,a,r){var t="service="+this.service+"&version="+this.version+"&request=describeMap&name="+e,n=this;n.getMapObj_u=r,$.ajax({type:"get",url:this.server,data:encodeURI(t),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var t=n.parseMapObj(e);void 0!=a&&a(t,n.refreshMapObj,n.getMapObj_u)},complete:function(e,a){},error:function(){}})},parseMapObj:function(e){var a=$(e).find("ExceptionText").text();if(""!=a)return console.log(a),null;var r=this,t=$(e).find("Name:first").text(),n=$(e).find("Srid:first").text(),i=$(e).find("BoundingBox:first"),s=this.parseBoundingBox(i),l=$(e).find("Viewer:first"),u=this.parseBoundingBox(l),o=[],p=null;return $(e).find("Capability>Layer").each(function(){var e=r.parseLayer(this);if(e instanceof GeoBeans.Layer.GroupLayer)for(var a=e.getLayers(),t=0;t<a.length;++t){var n=a[t];o.push(n)}}),{name:t,srid:n,extent:s,viewer:u,groupLayer:p,layers:o}},refreshMap:function(e,a){if(null==e)return void(null!=a&&a("map is null"));this.refreshMapObj=e;this.getMapObj(e.name,this.refreshMap_callback,a)},refreshMap_callback:function(e,a,r){if(null==e)return void r("refreshMap failed");var t=e.layers;if(null==t)return void r("refreshMap failed");var n=a.getLayers(),i=null,s=null,l=new GeoBeans.Layer.GroupLayer(a.server,a.name);l.setMap(a);for(var u=0;u<t.length;++u){s=t[u];for(var o=0;o<n.length;++o)if(i=n[o],i.name==s.name){i.styleName=s.styleName,i.extent=s.extent,l.addLayer(i);break}l.hasLayer(s.name)||(s.setMap(a),l.addLayer(s))}a.groupLayer=l,null!=r&&r("success")},zoomToGlobeMap:function(e,a){return null==e?void(null!=a&&a("map is null")):null!=e.baseLayer?(e.zoomToBaseLayer(),void a("success")):(this.refreshMapObj=e,void this.getMapObj(e.name,this.zoomToGlobeMap_callback,a))},zoomToGlobeMap_callback:function(e,a,r){if(null==e)return void r("zoom to  map failed");var t=e.layers;if(null==t)return void r("zoom to  map  failed");var n=a.getLayers(),i=null,s=null,l=new GeoBeans.Layer.GroupLayer(a.server,a.name);l.setMap(a);for(var u=0;u<t.length;++u){s=t[u];for(var o=0;o<n.length;++o)if(i=n[o],i.name==s.name){i.styleName=s.styleName,i.extent=s.extent,l.addLayer(i);break}l.hasLayer(s.name)||(s.setMap(a),l.addLayer(s))}a.groupLayer=l,a.extent=e.extent,a.setViewer(a.extent),a.draw(),r("success")}});
GeoBeans.MapWorkspace=GeoBeans.Class({server:null,service:"ims",version:"1.0.0",mapName:null,map:null,registerLayer_layer:null,registerLayer_callback_m:null,registerLayer_callback_u:null,setStyle_typeName:null,setStyle_style:null,setStyle_callback_m:null,setStyle_callback_u:null,initialize:function(e,t){this.server=e,this.map=t},registerLayer:function(e,t,a){if(null==e)return void(null!=t&&t("layer in null"));var r=e.type;this.type=r,r==GeoBeans.Layer.DBLayer.Type.Feature?this.registerFeatureDBLayer(e,t,a):r==GeoBeans.Layer.DBLayer.Type.Raster&&this.registerRasterDBLayer(e,t,a)},registerFeatureDBLayer:function(e,t,a){if(null!=e){var r=e.name,n=e.dbName,s=e.typeName;if(null==r||null==n||null==s)return void(null!=t&&t("params is invalid"));this.registerLayer_layer=e,this.registerLayer_callback_m=t,this.registerLayer_callback_u=a;var i=this,l=this.map.name,u="service="+this.service+"&version="+this.version+"&request=RegisterLayer&mapName="+l+"&datasource="+n+"&layerName="+r+"&tableName="+s+"&layertype=Feature";$.ajax({type:"get",url:this.server,data:encodeURI(u),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var a=i.parseRegisterLayer(e);null!=i.registerLayer_callback_m&&i.registerLayer_callback_m(a,i.map,i.registerLayer_layer,i.registerLayer_callback_u)},complete:function(e,t){},error:function(){}})}},registerRasterDBLayer:function(e,t,a){if(null==e)return void(null!=t&&t("layer in null"));var r=e.name,n=e.typeName,s=e.rasterPath,i=e.dbName;if(null==r||null==n||null==s||null==i)return void(null!=t&&t("params is invalid"));var l=this;this.registerLayer_layer=e,this.registerLayer_callback_m=t,this.registerLayer_callback_u=a;var u=this.map.name,y="service="+this.service+"&version="+this.version+"&request=RegisterLayer&mapName="+u+"&datasource="+i+"&rasterName="+n+"&rasterPath="+s+"&layerName="+r+"&layerType=Raster";$.ajax({type:"get",url:this.server,data:encodeURI(y),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var a=l.parseRegisterLayer(e);null!=l.registerLayer_callback_m&&l.registerLayer_callback_m(a,l.map,l.registerLayer_layer,l.registerLayer_callback_u)},complete:function(e,t){},error:function(){}})},unRegisterLayer:function(e,t,a){if(null!=e){this.unRegisterLayer_name=e,this.unRegisterLayer_callback_m=t,this.unRegisterLayer_callback_u=a;var r=this,n=this.map.name,s="service="+this.service+"&version="+this.version+"&request=UnRegisterLayer&mapName="+n+"&layerName="+e;$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var a=r.parseUnRegisterLayer(e);null!=r.unRegisterLayer_callback_m&&r.unRegisterLayer_callback_m(a,r.map,r.unRegisterLayer_name,r.unRegisterLayer_callback_u)},complete:function(e,t){},error:function(){}})}},describeLayer:function(e,t,a){if(null==e)return void(null!=t&&t("layername is null"));var r=this,n=this.map.name;this.describeLayer_callback_u=a;var s="service="+this.service+"&version="+this.version+"&request=DescribeLayer&mapName="+n+"&layerName="+e;$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,a){var n=r.parseDescribeLayer(e);null!=t&&t(n,r.describeLayer_callback_u)},complete:function(e,t){},error:function(){}})},parseDescribeLayer:function(e){var t=$(e).find("ExceptionText").text();if(""!=t)return t;var a=new Object,r=$(e).find("Name").first().text();a.name=r;var n=$(e).find("Type").first().text();if(a.type=n,"Feature"==n){var s=$(e).find("Feature").first(),i=$(s).find("Name").text(),l=$(s).find("GeometryType").text(),u=$(s).find("FeatureCount").text();a.featureName=i,a.geomType=l,a.count=u}else if("Raster"==n){var y=$(e).find("Raster").first(),c=$(y).find("Name").text(),o=$(y).find("Bands").text(),f=$(y).find("Format").text(),m=$(y).find("PixelType").text(),p=$(y).find("PixelSize").text(),d=$(y).find("Resolution_X").text(),L=$(y).find("Resolution_Y").text(),v=$(y).find("Width").text(),_=$(y).find("Height").text();a.rasterName=c,a.bands=o,a.format=f,a.pixelType=m,a.pixelSize=p,a.resolutionX=d,a.resolutionY=L,a.width=v,a.height=_}var x=$(e).find("EX_GeographicBoundingBox"),h=$(x).find("westBoundLongitude").text(),g=$(x).find("eastBoundLongitude").text(),b=$(x).find("southBoundLatitude").text(),T=$(x).find("northBoundLatitude").text(),B=new GeoBeans.Envelope(h,b,g,T);return a.extent=B,a},parseRegisterLayer:function(e){var t=$(e).find("ExceptionText").text();if(null!=t&&""!=t)return t;var a=null,r=$(e).find("ID").text(),n=$(e).find("Name:first").text(),s=null,i=$(e).find("Type").first().text(),i=this.type,l=null;switch(i.toLowerCase()){case"raster":l=GeoBeans.Layer.DBLayer.Type.Raster;break;case"feature":l=GeoBeans.Layer.DBLayer.Type.Feature}var u=$(e).find("BoundingBox:first"),y=this.parseBoundingBox(u);if(l==GeoBeans.Layer.DBLayer.Type.Raster)a=new GeoBeans.Layer.RasterDBLayer(n,parseInt(r),null,null,s,!0,null),a.extent=y;else if(l==GeoBeans.Layer.DBLayer.Type.Feature){var c=$(e).find("Style>Name").text(),o=$(e).find("GeometryType").text(),f=null;switch(o.toUpperCase()){case"POINT":f=GeoBeans.Geometry.Type.POINT;break;case"LINESTRING":f=GeoBeans.Geometry.Type.LINESTRING;break;case"POLYGON":f=GeoBeans.Geometry.Type.POLYGON;break;case"MULTIPOINT":f=GeoBeans.Geometry.Type.MULTIPOINT;break;case"MULTILINESTRING":f=GeoBeans.Geometry.Type.MULTILINESTRING;break;case"MULTIPOLYGON":f=GeoBeans.Geometry.Type.MULTIPOLYGON}a=new GeoBeans.Layer.FeatureDBLayer(n,parseInt(r),null,null,s,!0,c),a.extent=y,a.geomType=f}return a},parseBoundingBox:function(e){if(null==e)return null;var t=parseFloat($(e).attr("minx")),a=parseFloat($(e).attr("miny")),r=parseFloat($(e).attr("maxx")),n=parseFloat($(e).attr("maxy"));return new GeoBeans.Envelope(t,a,r,n)},parseUnRegisterLayer:function(e){var t=$(e).find("UnRegisterLayer").text();if("success"==t.toLowerCase())return"success";var a=$(e).find("ExceptionText").text();return a},setStyle:function(e,t,a,r){if(null!=e&&null!=t){this.setStyle_typeName=e,this.setStyle_style=t,this.setStyle_callback_m=a,this.setStyle_callback_u=r;var n=t.name,s=this,i=this.map.name,l="service="+this.service+"&version="+this.version+"&request=SetStyle&map="+i+"&layer="+e+"&style="+n;$.ajax({type:"get",url:this.server,data:encodeURI(l),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var a=s.parseSetStyle(e);null!=s.setStyle_callback_m&&s.setStyle_callback_m(a,s.map,s.setStyle_typeName,s.setStyle_style,s.setStyle_callback_u)},complete:function(e,t){},error:function(){}})}},parseSetStyle:function(e){var t=$(e).find("SetStyle").text();if("success"==t.toLowerCase())return"success";var a=$(e).find("ExceptionText").text();return a}});
GeoBeans.Marker=GeoBeans.Class({title:null,icon:null,mapX:null,mapY:null,offsetX:null,offsetY:null,image:null,layer:null,initialize:function(i,t,e,a){this.title=i,this.icon=t,this.mapX=e,this.mapY=a,this.offsetX=0,this.offsetY=0,this.image=new Image},destory:function(){},setLayer:function(i){this.layer=i},draw:function(){if(null==this.image?(this.image=new Image,this.image.src=this.icon):0==this.image.src.length&&(this.image.src=this.icon),this.image.complete)this.drarMaker();else{var i=this;this.image.onload=function(){i.drarMaker()}}},drarMaker:function(){var i=this.layer.map.transformation,t=i.toScreenPoint(this.mapX,this.mapY),e=this.layer.map.renderer;e.context.drawImage(this.image,t.x,t.y)}});
GeoBeans.Overlay=GeoBeans.Class({geometry:null,symbolizer:null,name:null,layer:null,loadFlag:null,visible:!0,isEdit:!1,isHit:!1,kvMap:{},htmlPath:null,initialize:function(e,i,t){this.name=e,this.geometry=i,this.symbolizer=t,this.loadFlag=GeoBeans.Overlay.Flag.READY,this.visible=!0,this.kvMap={}},setLayer:function(e){this.layer=e},draw:function(){if(this.visible){this.loadFlag=GeoBeans.Overlay.Flag.LOADED;var e=this.layer.map.transformation;if(this.layer.renderer.setSymbolizer(this.symbolizer),this.layer.renderer.drawOverlay(this,this.symbolizer,e),this.isHit){var i=this.layer.getHitOverlaySymbolizer(this);this.layer.drawHitOverlay(this,i)}if(this.isEdit){var i=this.layer.getEditOverlaySymbolizer(this);this.layer.drawEditOverlay(this,i)}}},setVisible:function(e){this.visible=e},beginEdit:function(){var e=this.layer.getEditOverlaySymbolizer(this);this.layer.drawEditOverlay(this,e),this.isEdit=!0},endEdit:function(){this.isHit=!1,this.isEdit=!1,this.layer.editOverlay=null,this.layer.editRenderer.clearRect(),this.layer.map.drawLayersAll()},getKeyValueMap:function(){return this.kvMap},hasKey:function(e){return e in this.kvMap?!0:!1},getValue:function(e){return this.hasKey(e)?this.kvMap[e]:null},removeKey:function(e){this.hasKey(e)&&delete this.kvMap[e]},addKeyValue:function(e,i){this.hasKey(e)||(this.kvMap[e]=i)},removeKeys:function(){for(var e in this.kvMap)this.removeKey(e);this.kvMap={}},clone:function(){var e=new GeoBeans.Geometry;e=this.geometry;var i=new GeoBeans.Style.Symbolizer;i=this.symbolizer;var t={},a=this.name,s=new GeoBeans.Overlay(a,e,i);s.visible=this.visible,s.isEdit=this.isEdit,s.isHit=this.isHit;for(var r in this.kvMap){var l=this.kvMap[r];t[r]=l}return s.kvMap=t,s},getExtent:function(){var e=this.geometry,i=null;if(this.type==GeoBeans.Overlay.Type.MARKER){var t=e.x,a=e.y;i=new GeoBeans.Envelope(t-1,a-1,t+1,a+1)}else i=e.extent;return i}}),GeoBeans.Overlay.Type={MARKER:"Marker",PLOYLINE:"Polyline",CIRCLE:"Circle",POLYGON:"Polygon"},GeoBeans.Overlay.Flag={READY:"ready",LOADED:"loaded"};
GeoBeans.Renderer=GeoBeans.Class({canvas:null,context:null,initialize:function(e){this.canvas=e,this.context=e.getContext("2d")},draw:function(e,t,n){var o=e.geometry;null!=o&&this.drawGeometry(o,t,n)},save:function(){this.canvas.save()},restore:function(){this.canvas.restore()},getGlobalAlpha:function(){return this.context.globalAlpha},setGlobalAlpha:function(e){this.context.globalAlpha=e},drawGeometry:function(e,t,n){switch(e.type){case GeoBeans.Geometry.Type.POINT:this.drawPoint(e,t,n);break;case GeoBeans.Geometry.Type.MULTIPOINT:this.drawMultiPoint(e,t,n);break;case GeoBeans.Geometry.Type.LINESTRING:this.drawLineString(e,t,n);break;case GeoBeans.Geometry.Type.MULTILINESTRING:this.drawMultiLineString(e,t,n);break;case GeoBeans.Geometry.Type.POLYGON:this.drawPolygon(e,t,n);break;case GeoBeans.Geometry.Type.MULTIPOLYGON:this.drawMultiPolygon(e,t,n);break;case GeoBeans.Geometry.Type.CIRCLE:this.drawCircle(e,t,n)}},drawPoint:function(e,t,n){var o,i=t.size;o=n.toScreenPoint(e.x,e.y),this.context.beginPath(),this.context.arc(o.x,o.y,i,0,2*Math.PI,!1),this.context.closePath(),this.context.fill(),null!=t.stroke&&this.context.stroke()},drawLineString:function(e,t,n){if(!(e.points.length<1)){var o=null,i=null,l=this.context;l.beginPath(),o=e.points[0],i=n.toScreenPoint(o.x,o.y),l.moveTo(i.x,i.y);for(var r=1,a=e.points.length;a>r;r++)o=e.points[r],i=n.toScreenPoint(o.x,o.y),l.lineTo(i.x,i.y);l.stroke()}},drawPolygon:function(e,t,n){var o,i,l=null,r=null,a=0,s=0,c=this.context;for(c.beginPath(),a=e.rings.length,o=0;a>o;o++)for(r=e.rings[o],s=r.points.length,l=r.points[0],spt=n.toScreenPoint(l.x,l.y),c.moveTo(spt.x,spt.y),i=1;s>i;i++)l=r.points[i],spt=n.toScreenPoint(l.x,l.y),c.lineTo(spt.x,spt.y);null!=t.fill&&c.fill(),t.stroke&&c.stroke(),c.closePath()},drawMultiPoint:function(e,t,n){points=e.points;for(var o=null,i=0,l=points.length;l>i;i++)o=points[i],this.drawPoint(o,t,n)},drawMultiLineString:function(e,t,n){lines=e.lines;for(var o=null,i=0,l=lines.length;l>i;i++)o=lines[i],this.drawLineString(o,t,n)},drawMultiPolygon:function(e,t,n){polygons=e.polygons;for(var o=null,i=0,l=polygons.length;l>i;i++)o=polygons[i],this.drawPolygon(o,t,n)},drawCircle:function(e,t,n){var o=e.center,i=e.radius;if(!(0>=i)){var l=this.context;l.beginPath();var r=n.toScreenPoint(o.x,o.y),a=n.toScreenPoint(o.x+i,o.y),s=Math.sqrt((r.x-a.x)*(r.x-a.x)+(r.y-a.y)*(r.y-a.y));l.arc(r.x,r.y,s,0,2*Math.PI,!0),null!=t.fill&&l.fill(),t.stroke&&l.stroke(),l.closePath()}},drawIcons:function(e,t,n){if(0!=e.length)if(null==t.icon?(t.icon=new Image,t.icon.src=t.symbol.icon):t.icon.src!=t.symbol.icon&&(t.icon=null,t.icon=new Image,t.icon.src=t.symbol.icon),t.icon.complete)for(var o=e.length,i=0;o>i;i++){var l=e[i].geometry,r=n.toScreenPoint(l.x,l.y);this.drawIcon(t.icon,r.x,r.y,t)}else{var a=this;t.icon.onload=function(){for(var o=e.length,i=0;o>i;i++){var l=e[i].geometry,r=n.toScreenPoint(l.x,l.y);a.drawIcon(t.icon,r.x,r.y,t)}mapObj.drawLayersAll()}}},drawIcon:function(e,t,n,o){var i,l;i=o.icon_width>0?o.icon_width:e.width,l=o.icon_height>0?o.icon_height:e.height;var r=Math.ceil(t-i/2)+o.icon_offset_x,a=Math.ceil(n-l/2)+o.icon_offset_y;this.context.drawImage(e,r,a,i,l)},label:function(e,t,n,o){switch(e.type){case GeoBeans.Geometry.Type.POINT:this.labelPoint(e,t,n,o);break;case GeoBeans.Geometry.Type.MULTIPOINT:this.labelMultiPoint(e,t,o);break;case GeoBeans.Geometry.Type.LINESTRING:this.labelLineString(e,t,o);break;case GeoBeans.Geometry.Type.MULTILINESTRING:this.labelMultiLineString(e,t,o);break;case GeoBeans.Geometry.Type.POLYGON:this.labelPolygon(e,t,o);break;case GeoBeans.Geometry.Type.MULTIPOLYGON:this.labelMultiPolygon(e,t,o)}},labelPoint:function(e,t,n,o){var i;i=o.toScreenPoint(e.x,e.y),null!=n.fill&&this.context.fillText(t,i.x,i.y)},drawLabel:function(e){var t=e.pos,n=e.textSymbolizer;null!=n.fill&&this.context.fillText(e.text,t.x,t.y),null!=n.stroke&&this.context.strokeText(e.text,t.x,t.y)},labelLineString:function(e,t,n,o){},labelPolygon:function(e,t,n,o){},labelMultiPoint:function(e,t,n,o){},labelMultiLineString:function(e,t,n,o){},labelMultiPolygon:function(e,t,n,o){},getTextExtent:function(e,t){var n=this.context.measureText(e).width;null==t&&(t=12);var o=new GeoBeans.Envelope(0,0,n,t);return o},drawImage:function(e,t,n,o,i){try{this.context.drawImage(e,t,n,o,i)}catch(l){console.log("drawImage failed: "+l)}},setSymbolizer:function(e){if(e instanceof GeoBeans.Symbolizer.PointSymbolizer)this.context.fillStyle=e.fill.color.getRgba(),null!=e.stroke&&(null!=e.stroke.width&&(this.context.lineWidth=e.stroke.width),null!=e.stroke.color&&(this.context.strokeStyle=e.stroke.color.getRgba()));else if(e instanceof GeoBeans.Symbolizer.LineSymbolizer){var t=e.stroke;null!=t&&(this.context.strokeStyle=t.color.getRgba(),null!=t.width&&(this.context.lineWidth=t.width),null!=t.lineCap&&(this.context.lineCap=t.lineCap),null!=t.lineJoin&&(this.context.lineJoin=t.lineJoin))}else if(e instanceof GeoBeans.Symbolizer.PolygonSymbolizer){var n=e.fill;null!=n&&(this.context.fillStyle=n.color.getRgba());var t=e.stroke;null!=t&&(this.context.strokeStyle=t.color.getRgba(),null!=t.width&&(this.context.lineWidth=t.width),null!=t.lineCap&&(this.context.lineCap=t.lineCap),null!=t.lineJoin&&(this.context.lineJoin=t.lineJoin))}else if(e instanceof GeoBeans.Symbolizer.TextSymbolizer){var o=e.font;null!=o&&(this.context.font=o.style+" "+o.weight+" "+o.size+"px "+o.family);var n=e.fill;null!=n&&(this.context.fillStyle=n.color.getRgba());var t=e.stroke;null!=t&&(this.context.strokeStyle=t.color.getRgba(),null!=t.width&&(this.context.lineWidth=t.width),null!=t.lineCap&&(this.context.lineCap=t.lineCap),null!=t.lineJoin&&(this.context.lineJoin=t.lineJoin))}e.showShadow&&(this.context.shadowBlur=e.shadowBlur,this.context.shadowColor=e.shadowColor,this.context.shadowOffsetX=e.shadowOffsetX,this.context.shadowOffsetY=e.shadowOffsetY)},fillCircle:function(e,t,n,o){},strokeCircle:function(e,t,n,o){},clear:function(e,t,n,o){switch(e.type){case GeoBeans.Geometry.Type.POINT:this.clearPoint(e,t,n,o);break;case GeoBeans.Geometry.Type.MULTIPOINT:this.clearMultiPoint(e,t,n,o);break;case GeoBeans.Geometry.Type.LINESTRING:this.clearLineString(e,t,o);break;case GeoBeans.Geometry.Type.MULTILINESTRING:this.clearMultiLineString(e,t,o);break;case GeoBeans.Geometry.Type.POLYGON:this.clearPolygon(e,t,o);break;case GeoBeans.Geometry.Type.MULTIPOLYGON:this.clearMultiPolygon(e,t,o)}},clearPoint:function(e,t,n,o){var i;i=o.toScreenPoint(e.x,e.y),this.context.fillStyle=t,this.context.beginPath(),this.context.arc(i.x,i.y,n,0,2*Math.PI,!1),this.context.closePath(),this.context.fill()},clearLineString:function(e,t,n){if(!(e.points.length<1)){var o=null,i=null,l=this.context;l.strokeStyle=t,l.beginPath(),o=e.points[0],i=n.toScreenPoint(o.x,o.y),l.moveTo(i.x,i.y);for(var r=1,a=e.points.length;a>r;r++)o=e.points[r],i=n.toScreenPoint(o.x,o.y),l.lineTo(i.x,i.y);l.stroke()}},clearPolygon:function(e,t,n){var o,i,l=null,r=null,a=0,s=0,c=this.context;for(c.fillStyle=t,c.beginPath(),a=e.rings.length,o=0;a>o;o++)for(r=e.rings[o],s=r.points.length,l=r.points[0],spt=n.toScreenPoint(l.x,l.y),c.moveTo(spt.x,spt.y),i=1;s>i;i++)l=r.points[i],spt=n.toScreenPoint(l.x,l.y),c.lineTo(spt.x,spt.y);c.closePath(),c.fill()},clearMultiPoint:function(e,t,n,o){points=e.points;for(var i=null,l=0,r=points.length;r>l;l++)i=points[l],this.clearPoint(i,symbolizer,n,o)},clearMultiLineString:function(e,t,n){lines=e.lines;for(var o=null,i=0,l=lines.length;l>i;i++)o=lines[i],this.clearLineString(o,t,n)},clearMultiPolygon:function(e,t,n){polygons=e.polygons;for(var o=null,i=0,l=polygons.length;l>i;i++)o=polygons[i],this.clearPolygon(o,t,n)},save:function(){this.context.save()},restore:function(){this.context.restore()},clearRect:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},drawOverlay:function(e,t,n){var o=!1,i=e.type;switch(i){case GeoBeans.Overlay.Type.MARKER:o=this.drawMarker(e,t,n);break;default:this.drawGeometry(e.geometry,t,n),o=!0}return o},drawMarker:function(e,t,n){var o=this,i=t.icon_url,l=e.geometry.x,r=e.geometry.y,a=n.toScreenPoint(l,r);return null==t.image&&(t.image=new Image,t.image.src=i),t.image.complete?(e.loadFlag=GeoBeans.Overlay.Flag.LOADED,this.drawIcon(t.image,a.x,a.y,t),!0):void(t.image.onload=function(){e.loadFlag=GeoBeans.Overlay.Flag.LOADED,o.drawIcon(t.image,a.x,a.y,t),e.layer.draw()})},drawTip:function(e,t,n,o){if(null==e||null==t||null==n)return null;var i=n.symbolizer;if(null==i)return null;this.setSymbolizer(i);var l=12,r=n.textSymbolizer;null!=r&&null!=r.font&&null!=r.font.size&&(l=r.font.size);var a=r.labelText;if(null==a)return null;var s=34,c=26,y=this.context.measureText(a).width;y>40&&(s=y+10);var h=e.x,x=e.y,u=t.toScreenPoint(h,x),f=6,g=5,G=new GeoBeans.Geometry.Point(u.x-f,u.y-f),m=new GeoBeans.Geometry.Point(u.x-s/2+g,u.y-f),P=new GeoBeans.Geometry.Point(u.x-s/2,u.y-f),w=new GeoBeans.Geometry.Point(u.x-s/2,u.y-f-g),p=new GeoBeans.Geometry.Point(u.x-s/2,u.y-c+g),T=new GeoBeans.Geometry.Point(u.x-s/2,u.y-c),b=new GeoBeans.Geometry.Point(u.x-s/2+g,u.y-c),d=(new GeoBeans.Geometry.Point(u.x+s/2-g,u.y-c),new GeoBeans.Geometry.Point(u.x+s/2,u.y-c)),v=(new GeoBeans.Geometry.Point(u.x+s/2,u.y-c+g),new GeoBeans.Geometry.Point(u.x+s/2,u.y-f-g),new GeoBeans.Geometry.Point(u.x+s/2,u.y-f)),S=(new GeoBeans.Geometry.Point(u.x+s/2-g,u.y-f),new GeoBeans.Geometry.Point(u.x+f,u.y-f)),B=this.context;B.beginPath(),B.moveTo(u.x,u.y),B.lineTo(G.x,G.y),B.lineTo(m.x,m.y),B.arcTo(P.x,P.y,w.x,w.y,g),B.lineTo(p.x,p.y),B.arcTo(T.x,T.y,b.x,b.y,g),B.lineTo(d.x,d.y),B.lineTo(v.x,v.y),B.lineTo(S.x,S.y),B.lineTo(u.x,u.y),null!=i.stroke&&B.stroke(),null!=i.fill&&B.fill();var r=n.textSymbolizer;null!=r&&this.setSymbolizer(r);var k=u.x-y/2,I=u.y-f-6;if(null!=r.fill&&B.fillText(a,k,I),null==o)return null;var L=o.textSymbolizer,M=o.symbolizer;null!=M&&this.setSymbolizer(M);var O=L.labelText;if(null==O)return null;O.length>=5&&(O=O.slice(0,5));var z=4,N=this.context.measureText(O).width;N+=2*z;var C=new GeoBeans.Geometry.Point(d.x+N-g,d.y),R=new GeoBeans.Geometry.Point(d.x+N,d.y),E=new GeoBeans.Geometry.Point(d.x+N,d.y+g),J=new GeoBeans.Geometry.Point(v.x+N,v.y-g),U=new GeoBeans.Geometry.Point(v.x+N,v.y),_=new GeoBeans.Geometry.Point(v.x+N-g,v.y);B.beginPath(),B.moveTo(d.x,d.y),B.lineTo(C.x,C.y),B.arcTo(R.x,R.y,E.x,E.y,g),B.lineTo(J.x,J.y),B.arcTo(U.x,U.y,_.x,_.y,g),B.lineTo(v.x,v.y),B.lineTo(d.x,d.y),null!=M.stroke&&B.stroke(),null!=M.fill&&B.fill(),null!=L&&this.setSymbolizer(L);var A=u.x+s/2+z,Y=u.y-f-6;B.fillText(O,A,Y,N);var D=new GeoBeans.Envelope(T.x,T.y,U.x,U.y);return D}});
GeoBeans.Style=GeoBeans.Class({name:null,type:null,initialize:function(e){this.name=e}}),GeoBeans.Style.Type={FeatureType:"featureType",RasterType:"rasterType"};
GeoBeans.Symbolizer=GeoBeans.Class({type:null,initialize:function(){},clone:function(){}}),GeoBeans.Symbolizer.Type={Point:"point",Line:"line",Polygon:"polygon",Text:"text",Raster:"raster"};
GeoBeans.Transformation=GeoBeans.Class({map:null,win_w:null,win_h:null,win_cx:null,win_cy:null,view_w:null,view_h:null,view_c:null,scale:null,initialize:function(i){this.map=i},toMapPoint:function(i,t){var e=(i-this.win_cx)/this.scale+this.view_c.x,n=(this.win_cy-t)/this.scale+this.view_c.y,s=new GeoBeans.Geometry.Point(e,n);return s},toScreenPoint:function(i,t){var e=this.scale*(i-this.view_c.x)+this.win_cx,n=this.win_cy-this.scale*(t-this.view_c.y),s=new GeoBeans.Geometry.Point(e,n);return s},update:function(){var i=this.map.viewer,t=this.map.width,e=this.map.height;this.win_w=parseFloat(t),this.win_h=parseFloat(e),this.win_cx=t/2,this.win_cy=e/2,this.view_w=i.getWidth(),this.view_h=i.getHeight(),this.view_c=i.getCenter();var n=this.win_w/this.view_w,s=this.win_h/this.view_h;this.scale=s>n?n:s,this.map.tolerance=this.map.TOLERANCE/this.scale}});
GeoBeans.User=GeoBeans.Class({name:null,server:null,mapManager:null,styleManager:null,dbsManager:null,tileDBManager:null,fileManager:null,rasterDBManager:null,gpsManager:null,tileDBManager:null,poiManager:null,subManager:null,initialize:function(e){this.name=e,this.server="/ows/"+this.name+"/mgr";var a="/ows/"+this.name;this.mapManager=new GeoBeans.MapManager(a),this.styleManager=new GeoBeans.StyleManager(a),this.dbsManager=new GeoBeans.DBSManager(a),this.fileManager=new GeoBeans.FileManager(a),this.tileDBManager=new GeoBeans.TileDBManager(a),this.rasterDBManager=new GeoBeans.RasterDBManager(a),this.gpsManager=new GeoBeans.GPSManager(a),this.poiManager=new GeoBeans.PoiManager(a),this.subManager=new GeoBeans.SubManager(a)},logout:function(){this.mapManager=null,this.styleManager=null,this.dbsManager=null,this.fileManager=null,this.tileDBManager=null,this.rasterDBManager=null,this.gpsManager=null},getMapManager:function(){return this.mapManager},getStyleManager:function(){return this.styleManager},getDBSManager:function(){return this.dbsManager},getFileManager:function(){return this.fileManager},getTileDBManager:function(e){return null==e?null:(this.tileDBManager.setName(e),this.tileDBManager)},getRasterDBManager:function(){return this.rasterDBManager},getGPSManager:function(){return this.gpsManager},getPoiManager:function(){return this.poiManager},getSubManager:function(){return this.subManager}});
GeoBeans.Workspace=GeoBeans.Class({name:null,initialize:function(n){this.name=n},destory:function(){this.name=null}});
GeoBeans.AQIIndexChart=GeoBeans.Class({name:null,container:null,dbName:null,tableName:null,chartFields:null,filterField:null,filterFieldValue:null,timeField:null,startTime:null,endTime:null,map:null,features:null,featureType:null,initialize:function(e,t,i,a,r,l,s,n,o,h){this.name=e,this.container=t,this.dbName=i,this.tableName=a,this.chartFields=r,this.filterField=l,this.filterFieldValue=s,this.timeField=n,this.startTime=o,this.endTime=h},setMap:function(e){this.map=e},setChartFields:function(e){this.chartFields=e},cleanup:function(){this.chart.clear()},show:function(){null!=this.container&&null!=this.dbName&&null!=this.tableName&&null!=this.chartFields&&null!=this.filterField&&null!=this.filterFieldValue&&null!=this.timeField&&null!=this.startTime&&null!=this.endTime&&null!=this.map&&this.getFeatures()},getFeatures:function(){var e=new GeoBeans.BinaryLogicFilter;e.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd;var t=new GeoBeans.BinaryComparisionFilter;t.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var i=new GeoBeans.PropertyName;i.setName(this.filterField);var a=new GeoBeans.Literal;a.setValue(this.filterFieldValue),t.expression1=i,t.expression2=a,e.addFilter(t);var r=new GeoBeans.BinaryLogicFilter;r.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd;var l=new GeoBeans.BinaryComparisionFilter;l.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThanOrEqual,i=new GeoBeans.PropertyName,i.setName(this.timeField),a=new GeoBeans.Literal,a.setValue(this.startTime),l.expression1=i,l.expression2=a;var s=new GeoBeans.BinaryComparisionFilter;s.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprLessThanOrEqual,i=new GeoBeans.PropertyName,i.setName(this.timeField),a=new GeoBeans.Literal,a.setValue(this.endTime),s.expression1=i,s.expression2=a,r.addFilter(l),r.addFilter(s),e.addFilter(r);var n=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0"),o=new GeoBeans.FeatureType(n,this.tableName);this.featureType=o,this.featureType.getFeaturesFilterAsync2(null,this.dbName,e,null,null,[this.timeField].concat(this.chartFields),this.timeField,this,this.getFeatures_callback)},getFeatures_callback:function(e,t){if(null!=e&&null!=t)if(e.features=t,null==e.chart){var i=e.getChartOption(),a=echarts.init(e.container);e.chart=a,a.setOption(i)}else{e.chart.clear();var i=e.getChartOption();e.chart.setOption(i)}},getChartOption:function(){if(null!=this.features&&null!=this.featureType){for(var e=[],t=[],i=0;i<this.chartFields.length;++i){var a=this.featureType.getFieldIndex(this.chartFields[i]);e.push(a),t[i]=[]}for(var r=[],l=this.featureType.getFieldIndex(this.timeField),s=null,n=null,i=0;i<this.features.length;++i)if(s=this.features[i],null!=s&&(n=s.values,null!=n)){for(var o=0;o<e.length;++o){var a=e[o],h=n[a];h=parseFloat(h),t[o].push(h)}var u=n[l];r.push(u)}for(var p=[],i=0;i<this.chartFields.length;++i){var d={name:this.chartFields[i],type:"line",smooth:!0,data:t[i]};p.push(d)}var F={toolbox:{show:!0,x:0,y:"top",feature:{dataView:{show:!0,readOnly:!0},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},grid:{x:"130px"},tooltip:{trigger:"axis"},legend:{data:this.chartFields,x:"184px",y:"top"},calculable:!0,xAxis:[{type:"value",boundaryGap:[0,.01]}],yAxis:[{type:"category",data:r}],series:p};return F}}});
GeoBeans.AQIStatCompChart=GeoBeans.Class({name:null,container:null,dbName:null,tableName:null,chartFields:null,stationCodeField:null,stationCodes:null,timeField:null,startTime:null,endTime:null,positionField:null,map:null,features:null,featureType:null,chart:null,initialize:function(e,t,i,l,a,s,n,r,o,h,u){this.name=e,this.container=t,this.dbName=i,this.tableName=l,this.chartFields=a,this.stationCodeField=s,this.stationCodes=n,this.timeField=r,this.startTime=o,this.endTime=h,this.positionField=u},setMap:function(e){this.map=e},cleanup:function(){null!=this.chart&&this.chart.clear()},show:function(){null!=this.container&&null!=this.dbName&&null!=this.tableName&&null!=this.chartFields&&null!=this.stationCodeField&&null!=this.stationCodes&&null!=this.timeField&&null!=this.startTime&&null!=this.endTime&&null!=this.map&&this.getFeatures()},getFeatures:function(){var e=new GeoBeans.BinaryLogicFilter;e.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd;var t=new GeoBeans.BinaryLogicFilter;t.operator=GeoBeans.LogicFilter.OperatorType.LogicOprOr;var i=null,l=new GeoBeans.PropertyName;l.setName(this.stationCodeField);for(var a=0;a<this.stationCodes.length;++a)if(i=this.stationCodes[a],null!=i){var s=new GeoBeans.BinaryComparisionFilter;s.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var n=new GeoBeans.Literal;n.setValue(i),s.expression1=l,s.expression2=n,t.addFilter(s)}var r=new GeoBeans.BinaryLogicFilter;r.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd;var o=new GeoBeans.BinaryComparisionFilter;o.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThanOrEqual;var h=new GeoBeans.PropertyName;h.setName(this.timeField),literal=new GeoBeans.Literal,literal.setValue(this.startTime),o.expression1=h,o.expression2=literal;var u=new GeoBeans.BinaryComparisionFilter;u.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprLessThanOrEqual,literal=new GeoBeans.Literal,literal.setValue(this.endTime),u.expression1=h,u.expression2=literal,r.addFilter(o),r.addFilter(u),e.addFilter(t),e.addFilter(r);var d=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0"),p=new GeoBeans.FeatureType(d,this.tableName);this.featureType=p,this.featureType.getFeaturesFilterAsync2(null,this.dbName,e,null,null,[this.timeField,this.stationCodeField,this.positionField].concat(this.chartFields),this.timeField,this,this.getFeatures_callback)},getFeatures_callback:function(e,t){if(null!=e&&null!=t){e.features=t;var i=e.getChartOption(),l=echarts.init(e.container);l.setOption(i),e.chart=l}},getChartOption:function(){if(null==this.features||null==this.featureType)return null;for(var e=this.getTimePointsList(),t=this.featureType.getFieldIndex(this.timeField),i=[],l=[],a=0;a<this.chartFields.length;++a){var s=this.featureType.getFieldIndex(this.chartFields[a]);i.push(s),l[a]=[]}for(var n=this.featureType.getFieldIndex(this.stationCodeField),r=null,o=null,h=null,u=null,d=null,p=null,F=null,c=[],f=[],a=0;a<this.stationCodes.length;++a)if(u=this.stationCodes[a],null!=u){c[a]=[];for(var m=0;m<this.chartFields.length;++m)null!=this.chartFields[m]&&(c[a][m]=[])}for(var a=0;a<this.features.length;++a)if(r=this.features[a],null!=r&&(o=r.values,null!=o)){h=o[n],p=o[t];for(var m=0;m<this.stationCodes.length;++m)if(u=this.stationCodes[m],null!=u&&h==u)for(var g=0;g<e.length;++g)if(d=e[g],null!=d&&d==p)for(var y=0;y<this.chartFields.length;++y)F=this.chartFields[y],null!=F&&(chartFieldValue=o[i[y]],chartFieldValue=parseFloat(chartFieldValue),c[m][y].push(chartFieldValue))}for(var f=this.getPositionNames(),v=[],C=[],T=null,B=null,G=null,a=0;a<c.length;++a)if(T=c[a],null!=T)for(var m=0;m<T.length;++m)B=T[m],null!=B&&(G={name:f[a]+"--"+this.chartFields[m],type:"line",smooth:!0,data:B},C.push(G),v.push(f[a]+"--"+this.chartFields[m]));var x={toolbox:{show:!0,x:0,y:"top",feature:{dataView:{show:!0,readOnly:!0},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},tooltip:{trigger:"axis"},legend:{data:v,x:"140px",y:"top"},calculable:!0,yAxis:[{type:"value",boundaryGap:[0,.01]}],xAxis:[{type:"category",data:e}],series:C};return x},getTimePointsList:function(){for(var e=[],t=null,i=null,l=null,a=this.featureType.getFieldIndex(this.timeField),s=0;s<this.features.length;++s)i=this.features[s],null!=i&&(l=i.values,null!=l&&(t=l[a],null!=t&&-1==e.indexOf(t)&&e.push(t)));return e},getPositionNames:function(){for(var e=this.featureType.getFieldIndex(this.positionField),t=[],i=this.featureType.getFieldIndex(this.stationCodeField),l=0;l<this.stationCodes.length;++l)for(var a=this.stationCodes[l],s=0;s<this.features.length;++s){var n=this.features[s];if(null!=n){var r=n.values;if(null!=r){var o=r[i];if(a==o){var h=r[e];if(null==t[l]){t.push(h);break}}}}}return t}});
GeoBeans.AQITimePointList=GeoBeans.Class({map:null,name:null,dbName:null,tableName:null,timeField:null,startTime:null,endTime:null,initialize:function(e,i,r,t,a,l){this.name=e,this.dbName=i,this.tableName=r,this.timeField=t,this.startTime=a,this.endTime=l},setMap:function(e){this.map=e},getTimeList:function(){if(null==this.map)return null;var e=new GeoBeans.BinaryLogicFilter;e.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd;var i=new GeoBeans.BinaryComparisionFilter;i.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThanOrEqual,prop=new GeoBeans.PropertyName,prop.setName(this.timeField),literal=new GeoBeans.Literal,literal.setValue(this.startTime),i.expression1=prop,i.expression2=literal;var r=new GeoBeans.BinaryComparisionFilter;r.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprLessThan,prop=new GeoBeans.PropertyName,prop.setName(this.timeField),literal=new GeoBeans.Literal,literal.setValue(this.endTime),r.expression1=prop,r.expression2=literal,e.addFilter(i),e.addFilter(r);var t=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0"),a=new GeoBeans.FeatureType(t,this.tableName),l=new GeoBeans.OrderBy;l.addField(this.timeField),l.setOrder(GeoBeans.OrderBy.OrderType.OrderAsc);var n=a.getFeaturesFilter(null,this.dbName,e,null,null,[this.timeField],l);if(null==n)return null;for(var s=[],o=null,p=null,m=null,u=a.getFieldIndex(this.timeField),d=0;d<n.length;++d)o=n[d],null!=o&&(p=o.values,null!=p&&(m=p[u],s.push(m)));return s}});
GeoBeans.TimeLineBar=GeoBeans.Class({slider:null,wrapper:null,broadcastIntervalId:null,initialized:!1,boardcast:null,layer:null,map:null,timePoints:null,initialize:function(i){if(null!=i){this.layer=i;var t=this.layer.map;if(null!=t){this.map=t,this.map.mapDiv.find("#slider").remove();var a='<div class="slider-wrap" id="slider">	<button class="timeline-play" id="slider_player">		<img src="../images/timeline-play.png">	</button>   <div class="timeline"></div>	  <div class="label-div"></div></div>';this.map.mapDiv.append(a);var s=i.getTimePoints();this.timePoints=s;var e=this;if(!this.initialized){this.wrapper=this.map.mapDiv.find("#slider"),this.slider=this.wrapper.find(".timeline"),this.slider.noUiSlider({start:0,range:{min:0,max:s.length-1},step:1});for(var l=1,r=1;r<s.length-1;r++){var n=r/(s.length-1)*100,d=$('<span class="ui-slider-segment"></span>');d.attr("data-content",l+r).css("left",n+"%"),this.slider.append(d)}this.boardcast=this.wrapper.find(".timeline-play"),this.boardcast.click(function(i){var t=$(this).find("img"),a=t.attr("src");/play/.test(a)?t.attr("src",a.replace("play","pause")):t.attr("src",a.replace("pause","play")),e.broadcast()}),this.slider.on("set",function(){var i=parseInt($(this).val());e.layer.currentLayerID=i,e.layer.map.drawLayersAll()}),this.addLabels(),this.initialized=!0}}}},show:function(){this.wrapper.css("display","block")},hide:function(){this.wrapper.css("display","none")},broadcast:function(){var i=this;null!=this.broadcastIntervalId?(clearInterval(this.broadcastIntervalId),this.broadcastIntervalId=null):this.broadcastIntervalId=setInterval(function(){var t=i.slider.val();t=parseInt(t),t===i.timePoints.length-1?i.slider.val(0):i.slider.val(t+1)},this.layer.interval)},cleanup:function(){this.map.mapDiv.find("#slider").remove(),clearInterval(this.broadcastIntervalId),this.broadcastIntervalId=null,this.slider=null,this.wrapper=null,this.initialized=!1,this.boardcast=null},addLabels:function(){if(!(null==this.timePoints||this.timePoints.length<2)){var i=this.timePoints.length,t=this.timePoints[0],a=document.createElement("canvas"),s=a.getContext("2d");s.font="12px Arial, Verdana, sans-seri";var e=s.measureText(t).width,l=this.slider.width(),r=l/(i-1),n="";if(r>e){var d=e/2*-1;this.wrapper.find(".label-div").css("margin-left",d).css("width","calc(100% + "+e+"px)");for(var p=0;i>p;++p){var h=0;h=0==p?0:r-e,n+="<div class='time-label' style='padding-left:"+h+"px'>"+this.timePoints[p]+"</div>"}this.wrapper.find(".label-div").html(n)}else{for(var c=Math.ceil(e/r),p=0;i>p+c;p+=c){var h=0;h=0==p?0:c*r-e,n+="<div class='time-label' style='padding-left:"+h+"px'>"+this.timePoints[p]+"</div>"}h+=(i-1-p)*r,n+="<div class='time-label' style='padding-left:"+h+"px'>"+this.timePoints[i-1]+"</div>";var d=e/2*-1;this.wrapper.find(".label-div").css("margin-left",d).css("width","calc(100% + "+e+"px)"),this.wrapper.find(".label-div").html(n)}}}});
GeoBeans.AuthManager=GeoBeans.Class({server:null,service:"was",version:"1.0.0",initialize:function(e){this.server=e},createUser:function(e,n,t,r,s,i){if(null==e||null==n||null==t||null==r||null==s)return void(null==i&&i("params is invalid"));var o=this,a="service="+this.service+"&version="+this.version+"&request=createUser&name="+e+"&alias="+n+"&password="+t+"&email="+r+"&role="+s;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var t=o.parseCreateUser(e);null!=i&&i(t)},complete:function(e,n){},error:function(){}})},parseCreateUser:function(e){var n=$(e).find("CreateUser").text();if("success"==n.toLowerCase())return"success";var t=$(e).find("ExceptionText").text();return t},login:function(e,n,t){if(null==e||null==n)return void(null!=t&&t("params is invalid"));var r=this,s="service="+this.service+"&version="+this.version+"&request=login&name="+e+"&password="+n;$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var s=r.parseLogin(e);null!=t&&t(s)},complete:function(e,n){},error:function(){}})},parseLogin:function(e){var n=$(e).find("Login").text();if("success"==n.toLowerCase())return"success";var t=$(e).find("ExceptionText").text();return t},logout:function(e,n){if(null==e)return void(null!=n&&n("name is null"));var t=this,r="service="+this.service+"&version="+this.version+"&request=logout&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var s=t.parseLogout(e);null!=n&&n(s)},complete:function(e,n){},error:function(){}})},parseLogout:function(e){var n=$(e).find("Logout").text();if("success"==n.toLowerCase())return"success";var t=$(e).find("ExceptionText").text();return t},getUser:function(e,n){if(null==e)return void(null!=n&&n("name is null"));var t=this,r="service="+this.service+"&version="+this.version+"&request=GetUser&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var s=t.parseGetUser(e);null!=n&&n(s)},complete:function(e,n){},error:function(){}})},parseGetUser:function(e){var n=$(e).find("ExceptionText").text();if(""!=n)return n;var t=null;return $(e).find("User").each(function(){var e=$(this).find("Name").text(),n=$(this).find("Alias").text(),r=$(this).find("Email").text(),s=$(this).find("Role").text();null!=e&&(t={name:e,alias:n,email:r,role:s})}),t},getUserList:function(e,n,t){var r=this,s="service="+this.service+"&version="+this.version+"&request=GetUser";null!=e&&(s+="&count="+e),null!=n&&(s+="&offset="+n),$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var s=r.parseGetUserList(e);null!=t&&t(s)},complete:function(e,n){},error:function(){}})},parseGetUserList:function(e){var n=[];return $(e).find("Users>User").each(function(){var e=$(this).find("Name").text(),t=$(this).find("Alias").text(),r=$(this).find("Email").text(),s=$(this).find("Role").text();if(null!=e){var i={name:e,alias:t,email:r,role:s};n.push(i)}}),n},getUserCount:function(e){var n=this,t="service="+this.service+"&version="+this.version+"&request=GetUserCount";$.ajax({type:"get",url:this.server,data:encodeURI(t),dataType:"xml",async:!0,beforeSend:function(e){},success:function(t,r){var s=n.parseGetUserCount(t);null!=e&&e(s)},complete:function(e,n){},error:function(){}})},parseGetUserCount:function(e){var n=$(e).find("UserCount").text();return n},getOnlineUser:function(e,n,t){var r=this,s="service="+this.service+"&version="+this.version+"&request=GetOnlineUser";null!=e&&(s+="&count="+e),null!=n&&(s+="&offset="+n),$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var s=r.parseGetOnlineUserList(e);null!=t&&t(s)},complete:function(e,n){},error:function(){}})},parseGetOnlineUserList:function(e){var n=[];return $(e).find("Users>User").each(function(){var e=$(this).find("Name").text();n.push(e)}),n},removeUser:function(e,n){if(null==e&&null!=n)return void n("name is null");var t=this,r="service="+this.service+"&version="+this.version+"&request=RemoveUser&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var s=t.parseRemoveUser(e);null!=n&&n(s)},complete:function(e,n){},error:function(){}})},parseRemoveUser:function(e){var n=$(e).find("RemoveUser").text(),t="";return"SUCCESS"==n.toUpperCase()?t="success":""!=$(e).find("ExceptionText").text()&&(t=$(e).find("ExceptionText").text()),t},getLoginCount:function(e){var n=this,t="service="+this.service+"&version="+this.version+"&request=GetLoginCount";$.ajax({type:"get",url:this.server,data:encodeURI(t),dataType:"xml",async:!0,beforeSend:function(e){},success:function(t,r){var s=n.parseGetLoginCount(t);null!=e&&e(s)},complete:function(e,n){},error:function(){}})},parseGetLoginCount:function(e){var n=$(e).find("LoginCount").text();return n}});
GeoBeans.Control.DragMapControl=GeoBeans.Class(GeoBeans.Control,{onmousedown:null,initialize:function(e){GeoBeans.Control.prototype.initialize.apply(this,arguments),this.map=e,this.type="DragMapControl";var t=this,o=function(e){if(t.enabled){e.preventDefault();var o,n,a,s,r=t.map,i=r.saveSnap(),p=0,l=0;r.width,r.height;o=e.layerX,n=e.layerY;var d=r.transformation.toMapPoint(o,n),u=!0,v=function(e){if(e.preventDefault(),u){document.body.style.cursor="pointer",p+=e.layerX-o,l+=e.layerY-n,r.drawBackground(),r.putSnap(p,l);var t=r.infoWindow;if(null!=t){var a=r.mapDiv.find(".popover");if(1==a.length){var s=(t.attr("x"),t.attr("y"),r.width),i=r.height,d=t.css("left"),v=t.css("top");d=parseInt(d.slice(0,d.indexOf("px"))),v=parseInt(v.slice(0,v.indexOf("px"))),d+=e.layerX-o,v+=e.layerY-n;var c=a.css("width"),f=a.css("height");c=parseInt(c.slice(0,c.indexOf("px"))),f=parseInt(f.slice(0,f.indexOf("px"))),0>d-c/2||d+c/2>s||0>v-f||v>i?(t.popover("hide"),r.queryLayer.clearFeatures()):(t.css("left",d+"px"),t.css("top",v+"px"),t.popover("hide").popover("show"),a.find(".popover-title").append('<button type="button" class="close">&times;</button>'),a.find(".popover-title").find(".close").click(function(){$(this).parents(".popover").popover("hide")}))}}o=e.layerX,n=e.layerY}},c=function(e){e.preventDefault(),i=null,u=!1;var t=r.transformation.toMapPoint(e.layerX,e.layerY);a=d.x-t.x,s=d.y-t.y,r.offset(a,s),r.draw(),r.cleanupSnap(),document.body.style.cursor="default",r.canvas.removeEventListener("mousemove",v),r.canvas.removeEventListener("mouseup",c)};r.canvas.addEventListener("mousemove",v),r.canvas.addEventListener("mouseup",c)}};this.onmousedown=o,this.map.canvas.addEventListener("mousedown",this.onmousedown)},destory:function(){this.map.canvas.removeEventListener("mousedown",this.onmousedown),GeoBeans.Control.prototype.destory.apply(this,arguments)}});
GeoBeans.Control.FeatureHitControl=GeoBeans.Class(GeoBeans.Control,{map:null,layer:null,onmousemove:null,callback:null,tolerance:10,selection:[],ptsymbol:null,lnsymbol:null,rnsymbol:null,initialize:function(e,o){GeoBeans.Control.prototype.initialize.apply(this,arguments),this.type="FeatureHitControl",this.layer=e,this.map=e.map,this.ptsymbol=this.createPointSymbolizer(),this.lnsymbol=this.createLineSymbolizer(),this.rnsymbol=this.createPolygonSymbolizer(),null!=this.map},destory:function(){this.layer=null,this.enabled(!1),GeoBeans.Control.prototype.destory.apply(this,arguments)},enable:function(e){if(null!=this.map)if(this.enabled=e,this.enabled){var o=null,t=null,n=this;this.onmousemove=function(e){if(null==o)o=e.layerX,t=e.layerY;else{var l=Math.abs(e.layerX-o)+Math.abs(e.layerY-t);if(l>n.tolerance){console.log(l),o=e.layerX,t=e.layerY;var i=n.map.transformation.toMapPoint(e.layerX,e.layerY);n.hit(i.x,i.y,n.callback)}}},this.map.canvas.addEventListener("mousemove",this.onmousemove)}else this.map.canvas.addEventListener("mousemove",this.onmousemove),this.onmousemove=null},hit:function(e,o,t){if(null!=this.layer){var n=this.layer.features;if(null!=n){this.map.renderer,this.map.transformation;this.selection=[],console.log(e+","+o);var l=0,i=null,a=null,s=n.length;for(l=0;s>l;l++)i=n[l],a=i.geometry,null!=a&&a.hit(e,o,this.map.tolerance)&&this.selection.push(i);this.highlight(this.selection),void 0!=t&&t(this.layer,this.selection)}}},highlight:function(e){for(var o=this.map.renderer,t=e.length,n=0;t>n;n++){var l=e[n],i=l.geometry;switch(i.type){case GeoBeans.Geometry.Type.POINT:case GeoBeans.Geometry.Type.MULTIPOINT:o.setSymbolizer(this.ptsymbol),o.drawGeometry(i,this.ptsymbol,this.map.transformation);break;case GeoBeans.Geometry.Type.LINESTRING:case GeoBeans.Geometry.Type.MULTILINESTRING:o.setSymbolizer(this.lnsymbol),o.drawGeometry(i,this.lnsymbol,this.map.transformation);break;case GeoBeans.Geometry.Type.POLYGON:case GeoBeans.Geometry.Type.MULTIPOLYGON:o.setSymbolizer(this.rnsymbol),o.drawGeometry(i,this.rnsymbol,this.map.transformation)}}},createPointSymbolizer:function(){var e;return e=new GeoBeans.Style.PointSymbolizer,e.size=5,e.fillColor="rgba(255,0,0,0.25)",e.outLineWidth=1,e.outLineColor="rgba(255,255,0,0.55)",e.outLineCap=GeoBeans.Style.LineCap.ROUND,e.outLineJoin=GeoBeans.Style.LineJoin.ROUND,e.showOutline=!0,e},createLineSymbolizer:function(){var e;return e=new GeoBeans.Style.LineSymbolizer,e.width=1,e.color="Red",e.lineCap=GeoBeans.Style.LineCap.ROUND,e.lineJoin=GeoBeans.Style.LineJoin.ROUND,e},createPolygonSymbolizer:function(){var e;return e=new GeoBeans.Style.PolygonSymbolizer,e.size=5,e.fillColor="rgba(255,0,0,0.25)",e.outLineWidth=1,e.outLineColor="rgba(255,255,0,0.55)",e.outLineCap=GeoBeans.Style.LineCap.ROUND,e.outLineJoin=GeoBeans.Style.LineJoin.ROUND,e.showOutline=!0,e}});
GeoBeans.Control.MapNavControl=GeoBeans.Class(GeoBeans.Control,{controlDiv:null,initialize:function(a){this.type=GeoBeans.Control.Type.NAV,this.map=a;var o='<div class="map-nav-wrapper">	<div class="map-nav-pan">	<div class="map-nav-pan">		<div class="map-nav-button map-nav-pan-N"></div>		<div class="map-nav-button map-nav-pan-W"></div>		<div class="map-nav-button map-nav-pan-E"></div>		<div class="map-nav-button map-nav-pan-S"></div>	</div>	<div class="map-nav-zoom">		<div class="map-nav-button map-nav-zoom-in"></div>		<div class="map-nav-button map-nav-zoom-out"></div>		<div class="map-nav-zoom-slider">			<div class="map-nav-zoom-slider-top"></div>			<div class="map-nav-zoom-slider-bottom"></div>			<div class="map-nav-zoom-slider-bar"></div>		</div>		<div class="map-nav-zoom-labels">			<div class="map-nav-zoom-label map-nav-zoom-label-street"></div>			<div class="map-nav-zoom-label map-nav-zoom-label-city"></div>			<div class="map-nav-zoom-label map-nav-zoom-label-province"></div>			<div class="map-nav-zoom-label map-nav-zoom-label-country"></div>		</div>	</div></div>';this.map.mapDiv.append(o),this.controlDiv=$(".map-nav-wrapper"),$(".map-nav-pan-N").mouseover(function(){$(this).parent().css("background-position","0 -44px")}),$(".map-nav-pan-W").mouseover(function(){$(this).parent().css("background-position","0 -176px")}),$(".map-nav-pan-E").mouseover(function(){$(this).parent().css("background-position","0 -88px")}),$(".map-nav-pan-S").mouseover(function(){$(this).parent().css("background-position","0 -132px")}),$(".map-nav-pan div").mouseout(function(){$(this).parent().css("background-position","0 0")});var e=this;$(".map-nav-pan-N").click(function(){var a=e.map.center,o=e.map.transformation.toMapPoint(e.width/2,0);e.map.offset(0,a.y-o.y),e.map.draw()}),$(".map-nav-pan-S").click(function(){var a=e.map.center,o=e.map.transformation.toMapPoint(e.width/2,0);e.map.offset(0,o.y-a.y),e.map.draw()}),$(".map-nav-pan-W").click(function(){var a=e.map.center,o=e.map.transformation.toMapPoint(e.map.width,e.map.height/2);e.map.offset(o.x-a.x,0),e.map.draw()}),$(".map-nav-pan-E").click(function(){var a=e.map.center,o=e.map.transformation.toMapPoint(e.map.width,e.map.height/2);e.map.offset(a.x-o.x,0),e.map.draw()}),$(".map-nav-zoom-in").click(function(){var a=e.map.level+1;null==a||1>a||null==e.map.baseLayer||a>e.map.baseLayer.MAX_ZOOM_LEVEL||a<e.map.baseLayer.MIN_ZOOM_LEVEL||(e.map.saveSnap(),e.map.drawBackground(),e.map.drawBaseLayerSnap(a),e.map.setLevel(a),e.map.draw())}),$(".map-nav-zoom-out").click(function(){var a=e.map.level-1;null==a||1>a||null==e.map.baseLayer||a>e.map.baseLayer.MAX_ZOOM_LEVEL||a<e.map.baseLayer.MIN_ZOOM_LEVEL||(e.map.saveSnap(),e.map.drawBackground(),e.map.drawBaseLayerSnap(a),e.map.setLevel(a),e.map.draw())});var n=function(a){a.preventDefault();var o=a.clientX,n=a.clientY,m=!0,p=function(a){if(a.preventDefault(),m){console.log("brefore Y :"+n),console.log("current Y :"+a.clientY);var p=(a.clientX-o,a.clientY-n);console.log("offsetY Y :"+p);var s=$(".map-nav-zoom-slider-bar").css("top"),t=parseFloat(s.slice(0,s.lastIndexOf("px"))),i=t+p;o=a.clientX,n=a.clientY,console.log("topMove:"+i);var r=$(".map-nav-zoom-slider").height(),v=r-i+10,l=$(".map-nav-zoom-slider").height()/18,c=r-l*(e.map.baseLayer.MAX_ZOOM_LEVEL-1),d=r-l*(e.map.baseLayer.MIN_ZOOM_LEVEL-1);20-Math.floor(i/l);if(c>i){var u=l*(e.map.baseLayer.MAX_ZOOM_LEVEL-1)+10;$(".map-nav-zoom-slider-bar").css("top",c+"px"),$(".map-nav-zoom-slider-bottom").css("top",c+"px"),$(".map-nav-zoom-slider-bottom").css("height",u+"px")}else if(i>d){console.log("topMove > minZoomPosition"+i);var b=l*(e.map.baseLayer.MIN_ZOOM_LEVEL-1)+10;$(".map-nav-zoom-slider-bar").css("top",d+"px"),$(".map-nav-zoom-slider-bottom").css("top",d+"px"),$(".map-nav-zoom-slider-bottom").css("height",b+"px")}else $(".map-nav-zoom-slider-bar").css("top",i+"px"),$(".map-nav-zoom-slider-bottom").css("top",i+"px"),$(".map-nav-zoom-slider-bottom").css("height",v+"px")}},s=function(a){a.preventDefault(),$(".map-nav-zoom-slider-bar")[0].removeEventListener("mousemove",p),$(".map-nav-zoom-slider-bar")[0].removeEventListener("mouseup",s),m=!1;var o=$(".map-nav-zoom-slider-bar").css("top"),n=parseFloat(o.slice(0,o.lastIndexOf("px"))),t=$(".map-nav-zoom-slider").height()/18,i=19-Math.ceil(n/t);mapObj.level!=i&&(e.map.drawBackground(),e.map.setLevel(i),e.map.draw())},t=function(a){a.preventDefault(),$(".map-nav-zoom-slider-bar")[0].removeEventListener("mousemove",p),$(".map-nav-zoom-slider-bar")[0].removeEventListener("mouseup",s),m=!1};$(".map-nav-zoom-slider-bar")[0].addEventListener("mousemove",p),$(".map-nav-zoom-slider-bar")[0].addEventListener("mouseup",s),$(".map-nav-zoom-slider-bar")[0].addEventListener("mouseout",t)};$(".map-nav-zoom-slider-bar")[0].addEventListener("mousedown",n),$(".map-nav-zoom").mouseover(function(){$(".map-nav-zoom-labels").css("display","block")}),$(".map-nav-zoom").mouseout(function(){$(".map-nav-zoom-labels").css("display","none")}),$(".map-nav-zoom-label-street").click(function(){18>e.map.baseLayer.MIN_ZOOM_LEVEL&&18<e.map.baseLayer.MAX_ZOOM_LEVEL&&(e.map.drawBackground(),e.map.setLevel(18),e.map.draw())}),$(".map-nav-zoom-label-city").click(function(){12>e.map.baseLayer.MIN_ZOOM_LEVEL&&12<e.map.baseLayer.MAX_ZOOM_LEVEL&&(e.map.drawBackground(),e.map.setLevel(12),e.map.draw())}),$(".map-nav-zoom-label-province").click(function(){8>e.map.baseLayer.MIN_ZOOM_LEVEL&&8<e.map.baseLayer.MAX_ZOOM_LEVEL&&(e.map.drawBackground(),e.map.setLevel(8),e.map.draw())}),$(".map-nav-zoom-label-country").click(function(){4>e.map.baseLayer.MIN_ZOOM_LEVEL&&4<e.map.baseLayer.MAX_ZOOM_LEVEL&&(e.map.drawBackground(),e.map.setLevel(4),e.map.draw())})},setZoomSlider:function(a){if(!(null==a||1>a||null==this.map.baseLayer||a>this.map.baseLayer.MAX_ZOOM_LEVEL||a<this.map.baseLayer.MIN_ZOOM_LEVEL)){var o=$(".map-nav-zoom-slider").height(),e=o/18,n=e*(a-1);$(".map-nav-zoom-slider-bar").css("top",o-n),$(".map-nav-zoom-slider-bottom").css("height",n+10),$(".map-nav-zoom-slider-bottom").css("top",o-n)}},setEnable:function(a){a?0!=this.controlDiv.length&&this.controlDiv.css("display","block"):0!=this.controlDiv.length&&this.controlDiv.css("display","none")}});
GeoBeans.Control.SrollMapControl=GeoBeans.Class(GeoBeans.Control,{onmousewheel:null,count:0,initialize:function(e){GeoBeans.Control.prototype.initialize.apply(this,arguments),this.map=e;var a=this,n=function(a,n){if(a.preventDefault(),null!=e.baseLayer){var o=e.level;a.wheelDelta>0?(o+=n,o>e.baseLayer.MAX_ZOOM_LEVEL&&(o=e.baseLayer.MAX_ZOOM_LEVEL),e.saveSnap(),e.drawBackground(),e.drawBaseLayerSnap(o),e.setLevel(o),e.draw()):(o-=n,o<e.baseLayer.MIN_ZOOM_LEVEL&&(o=e.baseLayer.MIN_ZOOM_LEVEL),e.saveSnap(),e.drawBackground(),e.drawBaseLayerSnap(o),e.setLevel(o),e.draw())}else if(a.wheelDelta>0){var t=1/(1+.2*n);e.saveSnap(),e.drawBackground(),e.drawLayersSnap(t),e.viewer.scale(t),e.transformation.update(),e.draw()}else{var t=1+.2*n;e.saveSnap(),e.drawBackground(),e.drawLayersSnap(t),e.viewer.scale(t),e.transformation.update(),e.draw()}};this.mousewheel=function(e){a.count=a.count+1;var o=a.count;setTimeout(function(){a.count==o&&(console.log("draw:"+a.count),n(e,a.count),a.count=0)},200)},e.canvas.addEventListener("mousewheel",this.mousewheel)},destory:function(){this.map.canvas.removeEventListener("mousewheel",this.mousewheel),GeoBeans.Control.prototype.destory.apply(this,arguments)}});
GeoBeans.Control.TrackControl=GeoBeans.Class(GeoBeans.Control,{map:null,onMouseDown:null,onMouseMove:null,onMouseDClick:null,initialize:function(){this.type=GeoBeans.Control.Type.TRACK},destory:function(){this.end()},trackPoint:function(e,n,a){var t=this;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var o=function(o){if(t.drawPoint(o.layerX,o.layerY),null!=e&&void 0!=e){var r=t.map.transformation.toMapPoint(o.layerX,o.layerY);e(r,n,a)}},r=function(e){t.map.restoreSnap(),t.drawPoint(e.layerX,e.layerY)};this.onMouseDown=o,this.onMouseMove=r,this.map.canvas.addEventListener("mousemove",r),this.map.canvas.addEventListener("mousedown",o)},trackLine:function(e,n,a,t){var o=this,r=[],s=[],i=!1;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var l=function(l){l.preventDefault();for(var u=!1,v=0;v<r.length;++v){var m=r[v],p=m.x,c=m.y;p==l.layerX&&c==l.layerY&&(u=!0)}var y=function(e){o.map.restoreSnap(),o.drawLine(r,e.layerX,e.layerY),o.drawPoints(r,e.layerX,e.layerY)},h=function(l){if(n.canvas.removeEventListener("dblclick",o.onMouseDClick),o.map.canvas.removeEventListener("mousemove",y),o.map.canvas.removeEventListener("dblclick",h),s.length!=r.length){if(0==s.length&&r.forEach(function(e,n){s.push(e)}),l.preventDefault(),o.map.restoreSnap(),null!=e&&"undefined"!=e&&e(o.buildLineString(r),n,a,t),null==e)return o.buildLineString(r);s=[],r=[],i=!1}};0==u&&r.push({x:l.layerX,y:l.layerY}),i||(console.log("add-mousemove"),o.map.canvas.addEventListener("mousemove",y),o.map.canvas.addEventListener("dblclick",h),i=!0),o.onMouseDClick=h,o.onMouseMove=y};this.map.canvas.addEventListener("mousedown",l),this.onMouseDown=l},trackPolygon:function(e,n,a,t){var o=this,r=[],s=!1;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var i=function(i){r.push({x:i.layerX,y:i.layerY});var l=function(e){o.map.restoreSnap(),r.length>1?(o.drawPolygon(r,e.layerX,e.layerY),o.drawPoints(r,e.layerX,e.layerY)):(o.drawLine(r,e.layerX,e.layerY),o.drawPoints(r,e.layerX,e.layerY))},u=function(i){o.map.canvas.removeEventListener("mousemove",l),o.map.canvas.removeEventListener("dblclick",u),r.push({x:i.layerX,y:i.layerY}),o.map.restoreSnap(),null!=e&&"undefined"!=e&&r.length>=3&&e(o.buildPolygon(r),n,a,t),r=[],s=!1};s||(console.log("add-mousemove"),o.map.canvas.addEventListener("mousemove",l),o.map.canvas.addEventListener("dblclick",u),s=!0),o.onMouseDClick=u,o.onMouseMove=l};this.map.canvas.addEventListener("mousedown",i),this.onMouseDown=i},trackCircle:function(e){var n=this,a=null,t=null,o=0;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var r=function(r){r.preventDefault(),a={x:r.layerX,y:r.layerY},n.drawPoints([],r.layerX,r.layerY);var s=function(e){e.preventDefault(),t={x:e.layerX,y:e.layerY},n.map.restoreSnap(),n.drawPoints([],a.x,a.y),o=Math.sqrt((t.x-a.x)*(t.x-a.x)+(t.y-a.y)*(t.y-a.y)),n.drawCircle(a,o)},i=function(o){if(o.preventDefault(),null!=t){n.map.canvas.removeEventListener("mousemove",s),n.map.canvas.removeEventListener("mouseup",i),n.map.restoreSnap(),n.map.enableDrag(!0);var r=n.map.transformation.toMapPoint(a.x,a.y),l=n.map.transformation.toMapPoint(t.x,t.y),u=Math.sqrt((l.x-r.x)*(l.x-r.x)+(l.y-r.y)*(l.y-r.y));if(null!=e&&"undefined"!=e){var v=new GeoBeans.Geometry.Circle(r,u);e(v)}}};n.map.canvas.addEventListener("mousemove",s),n.map.canvas.addEventListener("mouseup",i),n.onMouseMove=s,n.onMouseUp=i};this.map.canvas.addEventListener("mousedown",r),this.onMouseDown=r},trackRect:function(e,n,a,t){var o=this;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var r=null,s=null,i=function(i){i.preventDefault(),r={x:i.layerX,y:i.layerY},o.drawPoints([],i.layerX,i.layerY);var l=function(e){if(e.preventDefault(),null!=r){s={x:e.layerX,y:e.layerY},o.map.restoreSnap();var n=[];n.push(r),n.push({x:s.x,y:r.y}),n.push(s),n.push({x:r.x,y:s.y}),o.drawPolygon(n,r.x,r.y)}},u=function(i){if(i.preventDefault(),null!=s){var v=r.x-s.x,m=r.y-s.y;if(o.map.canvas.removeEventListener("mousemove",l),o.map.canvas.removeEventListener("mouseup",u),o.map.restoreSnap(),!(Math.abs(v)<1e-4&&Math.abs(m)<1e-4)){var p=o.buildRect(r,s);null!=e&&"undefined"!=e&&e(p,n,a,t),r=null,s=null}}};o.map.canvas.addEventListener("mousemove",l),o.map.canvas.addEventListener("mouseup",u),o.onMouseMove=l,o.onMouseUp=u};this.map.canvas.addEventListener("mousedown",i),this.onMouseDown=i},trackInfo:function(e,n,a,t){var o=this,r=null,s=null,i=function(i){r={x:i.layerX,y:i.layerY};var l=function(i){s={x:i.layerX,y:i.layerY};var u=r.x-s.x,v=r.y-s.y;if(Math.abs(u)>1e-4||Math.abs(v)>1e-4)return void o.map.canvas.removeEventListener("mouseup",l);var m=new GeoBeans.Geometry.Point(r.x,r.y);null!=e&&void 0!=e&&(console.log(r.x,r.y),e(m,n,a,t)),o.map.canvas.removeEventListener("mouseup",l)};o.map.canvas.addEventListener("mouseup",l),o.onMouseUp=l};this.map.canvas.addEventListener("mousedown",i),this.onMouseDown=i},cleanup:function(){this.map.canvas.removeEventListener("mousedown",this.onMouseDown),this.map.canvas.removeEventListener("mousemove",this.onMouseMove),this.map.canvas.removeEventListener("dblclick",this.onMouseDClick),this.map.canvas.removeEventListener("mouseup",this.onMouseUp),this.onMouseDown=null,this.onMouseMove=null,this.onMouseDClick=null,this.onMouseUp=null,this.map.restoreSnap()},end:function(){this.cleanup(),this.map.enableDrag(!0)},onMouseDownPoint:function(e){var n=e.layerX,a=e.layerY;this.drawPoint(n,a),this.map.canvas.saveSnap()},onMouseMovePoint:function(e){this.map.restoreSnap();var n=e.layerX,a=e.layerY;this.drawPoint(n,a)},drawPoint:function(e,n){var a=this.map.renderer.context,t=5;a.save(),a.fillStyle="rgba(255,0,0,0.25)",a.strokeStyle="rgba(0,0,0,0.75)",a.lineWidth=1,a.beginPath(),a.arc(e,n,t,0,2*Math.PI,!1),a.closePath(),a.fill(),a.stroke(),a.restore()},drawPoints:function(e,n,a){var t=this.map.renderer.context;t.save();var o=5;t.fillStyle="rgba(255,0,0,0.25)",t.strokeStyle="rgba(255,0,0,0.25)",t.lineWidth=.5,t.beginPath(),t.arc(n,a,o,0,2*Math.PI,!1),t.closePath(),t.fill(),t.stroke();for(var r=e.length,s=0;r>s;s++)t.beginPath(),t.arc(e[s].x,e[s].y,o,0,2*Math.PI,!1),t.closePath(),t.fill(),t.stroke();t.restore()},drawLine:function(e,n,a){var t=this.map.renderer.context;t.save(),t.strokeStyle="rgba(255,0,0,0.25)",t.lineWidth=3,t.beginPath(),t.moveTo(n,a);for(var o=e.length,r=o-1;r>=0;r--)t.lineTo(e[r].x,e[r].y);t.stroke(),t.restore()},drawPolygon:function(e,n,a){var t=this.map.renderer.context;t.save(),t.fillStyle="rgba(255,255,255,0.25)",t.strokeStyle="rgba(0,0,0,1)",t.lineWidth=.5;var o=e.length;for(t.beginPath(),t.moveTo(n,a),i=0;i<o;i++)t.lineTo(e[i].x,e[i].y);t.closePath(),t.fill(),t.stroke(),t.restore()},drawCircle:function(e,n){var a=this.map.renderer.context;a.save(),a.strokeStyle="rgba(255,0,0,0.25)",a.lineWidth=1,a.beginPath(),a.arc(e.x,e.y,n,0,2*Math.PI,!0),a.strokeStyle="#08c",a.stroke(),a.closePath()},buildLineString:function(e){for(var n=null,a=[],t=e.length,o=0;t>o;o++)n=this.map.transformation.toMapPoint(e[o].x,e[o].y),a.push(n);return new GeoBeans.Geometry.LineString(a)},buildMultiLineString:function(e){},buildPolygon:function(e){for(var n=null,a=[],t=e.length,o=0;t>o;o++)n=this.map.transformation.toMapPoint(e[o].x,e[o].y),a.push(n);a.push(a[0]);var r=new GeoBeans.Geometry.LinearRing(a);return new GeoBeans.Geometry.Polygon([r])},buildRect:function(e,n){e=this.map.transformation.toMapPoint(e.x,e.y),n=this.map.transformation.toMapPoint(n.x,n.y);var a=e.x>n.x?n.x:e.x,t=e.x>n.x?e.x:n.x,o=e.y>n.y?n.y:e.y,r=e.y>n.y?e.y:n.y,s=new GeoBeans.Envelope(a,o,t,r);return s}});
GeoBeans.Control.TrackBufferControl=GeoBeans.Class(GeoBeans.Control.TrackControl,{initialize:function(){this.type=GeoBeans.Control.Type.TRACKBUFFER},destory:function(){this.end()},end:function(){this.cleanup(),this.map.enableDrag(!0)},trackBufferCircle:function(e,n,a){var t=this,o=null,s=null,r=0;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var i=function(i){i.preventDefault(),o={x:i.layerX,y:i.layerY},t.drawPoints([],i.layerX,i.layerY);var l=function(e){e.preventDefault(),s={x:e.layerX,y:e.layerY},t.map.restoreSnap(),t.drawPoints([],o.x,o.y),r=Math.sqrt((s.x-o.x)*(s.x-o.x)+(s.y-o.y)*(s.y-o.y)),t.drawCircle(o,r)},u=function(r){if(r.preventDefault(),null!=s){t.map.canvas.removeEventListener("mousemove",l),t.map.canvas.removeEventListener("mouseup",u),t.map.canvas.removeEventListener("mousedown",t.onMouseDown),t.map.restoreSnap(),t.map.enableDrag(!0);var i=t.map.transformation.toMapPoint(o.x,o.y),v=t.map.transformation.toMapPoint(s.x,s.y),c=Math.sqrt((v.x-i.x)*(v.x-i.x)+(v.y-i.y)*(v.y-i.y));null!=n&&"undefined"!=n&&a(e,c,i,n)}};t.map.canvas.addEventListener("mousemove",l),t.map.canvas.addEventListener("mouseup",u),t.onMouseMove=l,t.onMouseUp=u};this.map.canvas.addEventListener("mousedown",i),this.onMouseDown=i},trackBufferLine:function(e,n,a,t){var o=this,s=[],r=[];this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var i=function(i){i.preventDefault();for(var l=!1,u=0;u<s.length;++u){var v=s[u],c=v.x,m=v.y;c==i.layerX&&m==i.layerY&&(l=!0)}0==l&&s.push({x:i.layerX,y:i.layerY});var p=function(e){o.map.restoreSnap(),o.drawLine(s,e.layerX,e.layerY),o.drawPoints(s,e.layerX,e.layerY)},h=function(i){i.preventDefault(),o.map.canvas.removeEventListener("mousemove",p),o.map.canvas.removeEventListener("dblclick",h),o.map.canvas.removeEventListener("click",o.onMouseClick),o.map.enableDrag(!0),r.length!=s.length&&(0==r.length&&s.forEach(function(e,n){r.push(e)}),o.map.restoreSnap(),null!=a&&"undefined"!=a&&t(e,n,o.buildLineString(s),a),r=[],s=[])};o.map.canvas.addEventListener("mousemove",p),o.map.canvas.addEventListener("dblclick",h),o.onMouseMove=p,o.onMouseDBclick=h};this.map.canvas.addEventListener("click",i),this.onMouseClick=i},cleanup:function(){this.map.canvas.removeEventListener("click",this.onMouseClick),this.map.canvas.removeEventListener("mousemove",this.onMouseMove),this.map.canvas.removeEventListener("dblclick",this.onMouseDBclick),this.map.canvas.removeEventListener("mousedown",this.onMouseDown),this.map.canvas.removeEventListener("mouseup",this.onMouseUp),this.onMouseClick=null,this.onMouseMove=null,this.onMouseDBclick=null,this.onMouseDown=null,this.onMouseUp=null}});
GeoBeans.Control.TrackOverlayControl=GeoBeans.Class(GeoBeans.Control.TrackControl,{initialize:function(){this.type=GeoBeans.Control.Type.TRACKOVERLAY},trackMarker:function(e){this.map.overlayLayer.setHitOverlayCallback(e);var a=this;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var n=function(n){if(n.preventDefault(),a.map.canvas.style.cursor="default",a.map.enableDrag(!0),null!=e&&void 0!=e){var o=a.map.transformation.toMapPoint(n.layerX,n.layerY),r=new GeoBeans.Symbolizer.PointSymbolizer;r.icon_url="../images/marker.png",r.icon_offset_x=0,r.icon_offset_y=0;var t=new GeoBeans.Overlay.Marker("maker",o,r);a.map.addOverlay(t),a.map.draw(),e(t)}a.map.canvas.removeEventListener("mousedown",a.onMouseDown),a.map.canvas.style.cursor="default"},o=function(e){e.preventDefault()};this.onMouseDown=n,this.onMouseMove=o,this.map.canvas.addEventListener("mousemove",o),this.map.canvas.addEventListener("mousedown",n)},trackLine:function(e){this.map.overlayLayer.setHitOverlayCallback(e);var a=this,n=[],o=[],r=!1;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var t=function(t){t.preventDefault();for(var l=!1,s=0;s<n.length;++s){var i=n[s],v=i.x,m=i.y;v==t.layerX&&m==t.layerY&&(l=!0)}0==l&&n.push({x:t.layerX,y:t.layerY});var u=function(e){a.map.restoreSnap(),a.drawLine(n,e.layerX,e.layerY),a.drawPoints(n,e.layerX,e.layerY)},p=function(t){if(a.map.enableDrag(!0),a.map.canvas.removeEventListener("mousedown",a.onMouseDown),a.map.canvas.removeEventListener("mousemove",u),a.map.canvas.removeEventListener("dblclick",p),o.length!=n.length){if(0==o.length&&n.forEach(function(e,a){o.push(e)}),t.preventDefault(),a.map.restoreSnap(),null!=e&&"undefined"!=e){var l=a.buildLineString(n),s=new GeoBeans.Symbolizer.LineSymbolizer;s.stroke.color.set(255,0,0,1),s.width=3;var i=new GeoBeans.Overlay.Polyline("polyline",l,s);a.map.addOverlay(i),a.map.draw(),e(i)}if(null==e)return a.buildLineString(n);o=[],n=[],r=!1}};0==l&&n.push({x:t.layerX,y:t.layerY}),r||(console.log("add-mousemove"),a.map.canvas.addEventListener("mousemove",u),a.map.canvas.addEventListener("dblclick",p),r=!0),a.onMouseDClick=p,a.onMouseMove=u};this.map.canvas.addEventListener("mousedown",t),this.onMouseDown=t},trackPolygon:function(e){this.map.overlayLayer.setHitOverlayCallback(e);var a=this,n=[],o=[];this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var r=function(r){r.preventDefault();for(var t=!1,l=0;l<n.length;++l){var s=n[l],i=s.x,v=s.y;i==r.layerX&&v==r.layerY&&(t=!0)}0==t&&n.push({x:r.layerX,y:r.layerY});var m=function(e){a.map.restoreSnap(),n.length>1?(a.drawPolygon(n,e.layerX,e.layerY),a.drawPoints(n,e.layerX,e.layerY)):(a.drawLine(n,e.layerX,e.layerY),a.drawPoints(n,e.layerX,e.layerY))},u=function(r){if(r.preventDefault(),a.map.canvas.removeEventListener("mousemove",m),a.map.canvas.removeEventListener("dblclick",u),a.map.canvas.removeEventListener("mousedown",a.onMouseDown),a.map.enableDrag(!0),o.length!=n.length){if(0==o.length&&n.forEach(function(e,a){o.push(e)}),null!=e&&"undefined"!=e&&n.length>=3){var t=new GeoBeans.Symbolizer.PolygonSymbolizer;t.fill.color.set(255,0,0,1),t.stroke.color.set(255,0,0,.2);var l=a.buildPolygon(n),s=new GeoBeans.Overlay.Polygon("polygon",l,t);a.map.addOverlay(s),a.map.draw(),e(s)}o=[],n=[]}};a.map.canvas.addEventListener("mousemove",m),a.map.canvas.addEventListener("dblclick",u),a.onMouseMove=m,a.onMouseDBclick=u};this.map.canvas.addEventListener("mousedown",r),this.onMouseDown=r}});
GeoBeans.Control.TrackControl.TrackTransactionControl=GeoBeans.Class(GeoBeans.Control.TrackControl,{initialize:function(){this.type=GeoBeans.Control.Type.TRACKTRANSACTION},trackPoint:function(e,n,a){var o=this;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var t=function(t){if(o.drawPoint(t.layerX,t.layerY),o.map.enableDrag(!0),null!=e&&void 0!=e){var r=o.map.transformation.toMapPoint(t.layerX,t.layerY);e(r,n,a)}o.map.canvas.removeEventListener("mousemove",o.onMouseMove),o.map.canvas.removeEventListener("mousedown",o.onMouseDown)},r=function(e){o.map.restoreSnap(),o.drawPoint(e.layerX,e.layerY)};this.onMouseDown=t,this.onMouseMove=r,this.map.canvas.addEventListener("mousemove",r),this.map.canvas.addEventListener("mousedown",t)},trackLine:function(e,n,a,o){var t=this,r=[],s=[];this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var i=function(i){i.preventDefault();for(var l=!1,v=0;v<r.length;++v){var c=r[v],m=c.x,u=c.y;m==i.layerX&&u==i.layerY&&(l=!0)}0==l&&r.push({x:i.layerX,y:i.layerY}),console.log("mouseclick"),console.log(r);var p=function(e){t.map.restoreSnap(),t.drawLine(r,e.layerX,e.layerY),t.drawPoints(r,e.layerX,e.layerY)},d=function(i){if(i.preventDefault(),t.map.canvas.removeEventListener("mousemove",p),t.map.canvas.removeEventListener("dblclick",d),t.map.canvas.removeEventListener("click",t.onMouseClick),t.map.enableDrag(!0),s.length!=r.length){if(0==s.length&&r.forEach(function(e,n){s.push(e)}),i.preventDefault(),console.log("mousedbclick"),t.map.canvas.removeEventListener("mousemove",p),t.map.canvas.removeEventListener("dblclick",d),null!=e&&"undefined"!=e)if(o){var l=[t.buildLineString(r)],v=new GeoBeans.Geometry.MultiLineString(l);e(v,n,a)}else e(t.buildLineString(r),n,a);s=[],r=[]}};t.map.canvas.addEventListener("mousemove",p),t.map.canvas.addEventListener("dblclick",d),t.onMouseMove=p,t.onMouseDBclick=d};this.map.canvas.addEventListener("click",i),this.onMouseClick=i},trackPolygon:function(e,n,a,o){var t=this,r=[],s=[];this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var i=function(i){i.preventDefault();for(var l=!1,v=0;v<r.length;++v){var c=r[v],m=c.x,u=c.y;m==i.layerX&&u==i.layerY&&(l=!0)}0==l&&r.push({x:i.layerX,y:i.layerY});var p=function(e){t.map.restoreSnap(),r.length>1?(t.drawPolygon(r,e.layerX,e.layerY),t.drawPoints(r,e.layerX,e.layerY)):(t.drawLine(r,e.layerX,e.layerY),t.drawPoints(r,e.layerX,e.layerY))},d=function(i){if(i.preventDefault(),t.map.canvas.removeEventListener("mousemove",p),t.map.canvas.removeEventListener("dblclick",d),t.map.canvas.removeEventListener("mousedown",t.onMouseDown),t.map.enableDrag(!0),s.length!=r.length){if(0==s.length&&r.forEach(function(e,n){s.push(e)}),null!=e&&"undefined"!=e&&r.length>=3)if(o){var l=[t.buildPolygon(r)],v=new GeoBeans.Geometry.MultiPolygon(l);e(v,n,a)}else e(t.buildPolygon(r),n,a);s=[],r=[]}};t.map.canvas.addEventListener("mousemove",p),t.map.canvas.addEventListener("dblclick",d),t.onMouseMove=p,t.onMouseDBclick=d};this.map.canvas.addEventListener("mousedown",i),this.onMouseDown=i}});
GeoBeans.DataSet=GeoBeans.Class({dataSource:null,name:null,type:null,geometryType:null,srid:null,thumbnail:null,featureType:null,fields:null,count:null,extent:null,initialize:function(e,t,n,i,u,a,l,s){if(this.dataSource=e,this.name=t,this.type=n,this.geometryType=i,this.srid=u,this.thumbnail=a,this.count=l,this.extent=s,null!=this.dataSource){var r=new GeoBeans.WFSWorkspace("tmp",this.dataSource.server,"1.0.0");this.featureType=new GeoBeans.FeatureType(r,this.name)}},getFields:function(){if(null!=this.fields)return this.fields;var e=this.featureType.getFields(null,this.dataSource.name);return this.fields=e,this.fields},getFieldsWithoutGeom:function(){var e=this.getFields();if(null==e)return null;for(var t=[],n=null,i=null,u=0;u<e.length;++u)n=e[u],null!=n&&(i=n.type,i!=GeoBeans.FieldType.GEOMETRY&&t.push(n.name));return t},getFeatures:function(e,t,n,i){this.featureType.getFeaturesFilterAsync(null,this.dataSource.name,null,e,t,n,null,i)},getPreview:function(e,t){var n=this.dataSource.server+"?service="+this.dataSource.service+"&version="+this.dataSource.version+"&request=GetPreview&sourceName="+this.dataSource.name+"&dataSetName="+this.name+"&width="+e+"&height="+t;return n},getFeatureCount:function(){var e=this.featureType.getCount(null,this.dataSource.name,null);return e}});
GeoBeans.DataSource=GeoBeans.Class({server:null,service:"dbs",version:"1.0.0",name:null,engine:null,constr:null,dataSets:null,initialize:function(e,t,a,n){this.server=e,this.name=t,this.engine=a,this.constr=n,this.dataSets=[]},getDataSets:function(e){var t=this,a="service="+this.service+"&version="+this.version+"&request=GetDataSet&sourceName="+this.name;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(a,n){t.dataSets=t.parseDataSets(a),void 0!=e&&e(t.dataSets)},complete:function(e,t){},error:function(){}})},getDataSet:function(e,t){if(null!=e&&""!=e){var a=this,n="service="+this.service+"&version="+this.version+"&request=GetDataSet&sourceName="+this.name+"&dataSetName="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var s=a.parseDataSet(e);void 0!=t&&t(s)},complete:function(e,t){},error:function(){}})}},parseDataSets:function(e){var t=this,a=[];return $(e).find("DataSet").each(function(){var e=t.parseDataSet(this);a.push(e)}),a},parseDataSet:function(e){var t=$(e).find("Name").text(),a=$(e).find("Type:first").text(),n=$(e).find("Geometry>Type").text(),s=null;switch(n.toUpperCase()){case"POINT":s=GeoBeans.Geometry.Type.POINT;break;case"LINESTRING":s=GeoBeans.Geometry.Type.LINESTRING;break;case"POLYGON":s=GeoBeans.Geometry.Type.POLYGON;break;case"MULTIPOINT":s=GeoBeans.Geometry.Type.MULTIPOINT;break;case"MULTILINESTRING":s=GeoBeans.Geometry.Type.MULTILINESTRING;break;case"MULTIPOLYGON":s=GeoBeans.Geometry.Type.MULTIPOLYGON}var r=$(e).find("Geometry>SRID").text();""==r&&(r=null);var i=$(e).find("Thumbnail").attr("xlink");""==i&&(i=null);var o=$(e).find("Count").text();null!=o&&(o=parseInt(o));var c=$(e).find("BoundingBox").attr("minx"),u=$(e).find("BoundingBox").attr("miny"),l=$(e).find("BoundingBox").attr("maxx"),f=$(e).find("BoundingBox").attr("maxy"),v=null;null!=c&&null!=u&&null!=l&&null!=f&&(v=new GeoBeans.Envelope(parseFloat(c),parseFloat(u),parseFloat(l),parseFloat(f)));var d=new GeoBeans.DataSet(this,t,a,s,r,i,o,v);return d},removeDataSet:function(e,t){if(null!=e){var a=this,n="service="+this.service+"&version="+this.version+"&request=RemoveDataSet&sourceName="+this.name+"&dataSetName="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var s=a.parseRemoveDataSet(e);void 0!=t&&t(s)},complete:function(e,t){},error:function(){}})}},parseRemoveDataSet:function(e){var t=$(e).find("RemoveDataSet").text();if("success"==t.toLowerCase())return"success";var a=$(e).find("ExceptionText").text();return a},refresh:function(e,t){if(null==e)return void(null!=t&&t("refresh name is null"));var a=this,n="service="+this.service+"&version="+this.version+"&request=Refresh&sourceName="+this.name+"&dataSetName="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var s=a.parseRefreshDataSet(e);void 0!=t&&t(s)},complete:function(e,t){},error:function(){}})},parseRefreshDataSet:function(e){var t=$(e).find("Refresh").text();if("success"==t.toLowerCase())return"success";var a=$(e).find("ExceptionText").text();return a}});
GeoBeans.DBSManager=GeoBeans.Class({server:null,service:"dbs",version:"1.0.0",dataSources:null,sourceName:null,initialize:function(e){this.server=e+"/mgr",this.dataSources=[]},getDataSources:function(e,t){var r=this,n="service="+this.service+"&version="+this.version+"&request=GetDataSource";null!=t&&(n+="&type="+t),$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(t,n){r.dataSources=r.parseDataSources(t),void 0!=e&&e(r.dataSources)},complete:function(e,t){},error:function(){}})},getDataSource:function(e,t){if(null!=e&&""!=e){var r=this,n="service="+this.service+"&version="+this.version+"&request=GetDataSource&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var i=r.parseDataSource(e);void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})}},unRegisterDataSource:function(e,t){if(null!=e){var r=this,n="service="+this.service+"&version="+this.version+"&request=UnRegisterDataSource&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var i=r.parseUnRegisterDBS(e);void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})}},registerDataSource:function(e,t,r,n,i){if(null==e||null==r||null==t||null==n)return void(null!=i&&i("params is invalid"));var s=this,a="service="+this.service+"&version="+this.version+"&request=RegisterDataSource&name="+e+"&engine="+t+"&uri="+r+"&type="+n;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var r=s.parseRegisterDBS(e);void 0!=i&&i(r)},complete:function(e,t){},error:function(){}})},tryConnection:function(e,t){if(null!=e&&""!=e){var r=this,n="service="+this.service+"&version="+this.version+"&request=TryConnection&engine=Postgres&uri="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var i=r.parseTryConn(e);void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})}},featureImport:function(e,t,r,n,i,s,a){if(null==e||null==t||null==r)return void a("params is invalid");var o="service=gps&vesion=1.0.0&request=FeatureImport&sourcename="+e+"&typeName="+t+"&shppath="+r+"&shpname="+n;o+=null!=i?"&srid="+i:"&srid=4326",o+=null!=s?"&geom="+s:"&geom=shape";var c=this;$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var r=c.parseFeatureImport(e);null!=a&&a(r)},complete:function(e,t){},error:function(){}})},createTileStore:function(e,t,r,n){if(null==e||null==t||null==r)return void(null!=n&&n("params is invalid"));var i=this,s="service="+this.service+"&version="+this.version+"&request=CreateTileStore&sourceName="+e+"&storeName="+t+"&type="+r;$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var r=i.parseCreateTileStore(e);void 0!=n&&n(r)},complete:function(e,t){},error:function(){}})},describeTileStores:function(e,t){if(null==e)return void(null!=t&&t("params is invalid"));var r="service="+this.service+"&version="+this.version+"&request=DescribeTileStore&sourceName="+e;this.sourceName=e;var n=this;$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var i=n.parseDescribeTileStores(e);void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})},describeTileStore:function(e,t,r){if(null==e||null==t)return void(null!=r&&r("params is invalid"));var n=this,i="service="+this.service+"&version="+this.version+"&request=DescribeTileStore&sourceName="+e+"&storeName="+t;this.sourceName=e,$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var i=n.parseDescribeTileStore(e);void 0!=r&&r(i)},complete:function(e,t){},error:function(){}})},removeTileStore:function(e,t,r){if(null==e||null==t)return void(null!=r&&r("params is invalid"));var n="service="+this.service+"&version="+this.version+"&request=RemoveTileStore&sourceName="+e+"&storeName="+t,i=this;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.parseRemoveTileStore(e);void 0!=r&&r(n)},complete:function(e,t){},error:function(){}})},parseCreateTileStore:function(e){var t=$(e).find("CreateTileStore").text();if("success"==t.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},parseDataSources:function(e){var t=[],r=this;return $(e).find("DataSource").each(function(){var e=r.parseDataSource(this);t.push(e)}),t},parseDataSource:function(e){var t=$(e).find("Name").text(),r=$(e).find("Engine").text(),n=$(e).find("ConnectionString").text(),i=new GeoBeans.DataSource(this.server,t,r,n);return i},parseUnRegisterDBS:function(e){var t=$(e).find("UnRegisterDataSource").text();if("success"==t.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},parseRegisterDBS:function(e){var t=$(e).find("RegisterDataSource").text();if("success"==t.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},parseTryConn:function(e){var t=$(e).find("TryConnection").text();if("success"==t.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},parseFeatureImport:function(e){var t=$(e).find("FeatureImport").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},parseDescribeTileStores:function(e){var t=[],r=this;return $(e).find("TileStore").each(function(){var e=r.parseDescribeTileStore(this);t.push(e)}),t},parseDescribeTileStore:function(e){var t=$(e).find("Title").first().text(),r=$(e).find("Format").first().text(),n=$(e).find("TileMatrixSetLink>TileMatrixSet").first().text(),i=$(e).find("LowerCorner").text(),s=$(e).find("UpperCorner").text(),a=i.indexOf(" "),o=i.lastIndexOf(" "),c=i.slice(0,a),u=i.slice(o+1,i.length);a=s.indexOf(" "),o=s.lastIndexOf(" ");var l=s.slice(0,a),f=s.slice(o+1,s.length),v=new GeoBeans.Envelope(parseFloat(c),parseFloat(u),parseFloat(l),parseFloat(f)),d=this.sourceName,p=new GeoBeans.TileStore(t,v,r,n,d);return p},parseRemoveTileStore:function(e){var t=$(e).find("RemoveTileStore").text(),r="";return"SUCCESS"==t.toUpperCase()?r="success":""!=$(e).find("ExceptionText").text()&&(r=$(e).find("ExceptionText").text()),r},createDataSet:function(e,t,r,n){if(null==e||null==t||null==r)return void(null!=n&&n("params is invalid"));var i=this.buildCreateDataSetXML(e,t,r);if(null==i)return void(null!=n&&n("params is invalid"));var s=this;$.ajax({type:"post",url:this.server,data:i,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var r=s.parseCreateDataSet(e);void 0!=n&&n(r)},complete:function(e,t){},error:function(){}})},buildCreateDataSetXML:function(e,t,r){if(null==e||null==t||null==r)return null;var n='<?xml version="1.0" encoding="UTF-8"?><CreateDataSet 	service="dbs" 	version="1.0.0" 	sourceName="'+e+'" 	dataSetName="'+t+'">';if(0!=r.length){n+="<Fields>";for(var i=null,s=null,a=null,o=null,c=0;c<r.length;++c)i=r[c],null!=i&&(o=i.name,s=i.type,a=i.length,n+="<Field><Name>"+o+"</Name><Type>"+s+"</Type>",null!=a&&(n+="<Length>"+a+"</Length>"),n+="</Field>");n+="</Fields>"}return n+="</CreateDataSet>"},parseCreateDataSet:function(e){var t=$(e).find("CreateDataSet").text(),r="";return"SUCCESS"==t.toUpperCase()?r="success":""!=$(e).find("ExceptionText").text()&&(r=$(e).find("ExceptionText").text()),r}});
GeoBeans.GField=GeoBeans.Class({name:null,type:null,length:null,initialize:function(e,t,l){this.name=e,this.type=t,this.length=l}}),GeoBeans.GFieldType={Bool:"bool",Char:"char",Short:"short",Int:"int",Long:"long",Int64:"int64",Float:"float",Double:"double",String:"string",Time:"time",Blob:"blob",Geometry:"geometry"};
GeoBeans.File=GeoBeans.Class({name:null,accessTime:null,lastTime:null,size:null,path:null,parPath:null,initialize:function(i,s,l,a,e,t){this.parPath=i,this.path=s,this.name=l,this.accessTime=a,this.lastTime=e,this.size=t}});
GeoBeans.FileManager=GeoBeans.Class({server:null,service:"ufs",version:"1.0.0",list:null,currentPath:null,initialize:function(e){this.server=e+"/mgr",this.list=[]},getList:function(e,t){if(null==e)return void(null!=t&&t("path is null"));var r=this,n="service="+this.service+"&version="+this.version+"&request=List&path="+e;r.currentPath=e,$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){r.list=r.parseList(e),void 0!=t&&t(r.list.sort(r.sortFile2Folder))},complete:function(e,t){},error:function(){}})},createFolder:function(e,t){if(null==e)return void(null!=t&&t("path is null"));var r=this,n="service="+this.service+"&version="+this.version+"&request=CreateFolder&path="+e;r.currentPath=e,$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var i=r.parseCreateFolder(e);void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})},removeFolder:function(e,t){if(null==e)return void(null!=t&&t("path is null"));var r=this,n="service="+this.service+"&version="+this.version+"&request=RemoveFolder&path="+e;r.currentPath=e,$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var i=r.parseRemoveFolder(e);void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})},removeFile:function(e,t){if(null==e)return void(null!=t&&t("path is null"));var r=this,n="service="+this.service+"&version="+this.version+"&request=RemoveFile&path="+e;r.currentPath=e,$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var i=r.parseRemoveFile(e);void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})},describeCsv:function(e,t){if(null==e)return void(null!=t&&t("path is null"));var r=this,n="service="+this.service+"&version="+this.version+"&request=DescribeCsv&path="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var i=r.parseDescribeCsv(e);void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})},parseList:function(e){var t=this,r=[],n=$(e).find("Files");return n.children().each(function(){if("File"==this.tagName){var e=t.parseFile(this);r.push(e)}else if("Folder"==this.tagName){var n=t.parseFolder(this);r.push(n)}}),r},parseFile:function(e){var t=$(e).attr("name"),r=$(e).attr("access_time"),n=$(e).attr("last_modified_time"),i=$(e).attr("size"),s=null;s="/"==this.currentPath?this.currentPath+t:this.currentPath+"/"+t;var a=new GeoBeans.File(this.currentPath,s,t,r,n,i);return a},parseFolder:function(e){var t=$(e).attr("name"),r=$(e).attr("access_time"),n=$(e).attr("last_modified_time"),i=null;i="/"==this.currentPath?this.currentPath+t:this.currentPath+"/"+t;var s=new GeoBeans.Folder(this.currentPath,i,t,r,n);return s},parseCreateFolder:function(e){var t=$(e).find("CreateFolder").text();if("success"==t.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},parseRemoveFolder:function(e){var t=$(e).find("RemoveFolder").text();if("success"==t.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},parseRemoveFile:function(e){var t=$(e).find("RemoveFile").text();if("success"==t.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},sortFile2Folder:function(e,t){return e instanceof GeoBeans.File&&t instanceof GeoBeans.Folder?1:e instanceof GeoBeans.Folder&&t instanceof GeoBeans.File?-1:e instanceof GeoBeans.File&&t instanceof GeoBeans.File?t-e:e instanceof GeoBeans.Folder&&t instanceof GeoBeans.Folder?t-e:void 0},parseDescribeCsv:function(e){var t=$(e).find("ExceptionText").text();if(null!=t&&""!=t)return t;var r=[];return $(e).find("sequence").find("element").each(function(){var e=$(this).attr("name");r.push(e)}),r}});
GeoBeans.Folder=GeoBeans.Class({name:null,accessTime:null,lastTime:null,path:null,parPath:null,initialize:function(a,l,s,e,i){this.parPath=a,this.path=l,this.name=s,this.accessTime=e,this.lastTime=i}});
GeoBeans.ComparisionFilter=GeoBeans.Class(GeoBeans.Filter,{operator:null,initialize:function(){GeoBeans.Filter.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Filter.Type.FilterComparsion}}),GeoBeans.ComparisionFilter.OperatorType={ComOprEqual:"equal",ComOprNotEqual:"notequal",ComOprLessThan:"lessthan",ComOprGreaterThan:"greaterthan",ComOprLessThanOrEqual:"lessthanorequal",ComOprGreaterThanOrEqual:"greaterthanorequal",ComOprIsLike:"islike",ComOprIsNull:"isnull",ComOprIsBetween:"isbetween"};
GeoBeans.DistanceBufferFilter=GeoBeans.Class(GeoBeans.Class,{propName:null,distance:null,initialize:function(){GeoBeans.SpatialFitler.prototype.initialize.apply(this,arguments),this.operator=GeoBeans.SpatilalFilter.OperatorType.SpOprIntersects}}),GeoBeans.UnitType={Inches:"inches",Points:"points",feet:"feet",yards:"yards",miles:"miles",naticalMiles:"naticalmiles"};
GeoBeans.Expression=GeoBeans.Class({type:null,initialize:function(){},clone:function(){var e=new GeoBeans.Expression;return e.type=this.type,e}}),GeoBeans.Expression.Type={Arithmetic:"arithmetic",PropertyName:"propname",Literal:"literal",Function:"function"};
GeoBeans.FilterReader=GeoBeans.Class({initialize:function(){},read:function(e){var r=null,a=e.children();return 0==a.length?null:r=this.parseFilter(a[0])},parseFilter:function(e){var r=null,a=e.tagName;return a=a.slice(a.lastIndexOf(":")+1,a.length),a=a.toLowerCase(),"bbox"==a?r=this.parseBBox(e):0==a.indexOf("propertyis")?r=this.parseBinaryComparision(a,e):"and"==a||"or"==a?r=this.parseBinaryLogical(a,e):"not"==a?r=this.parseUnaryLogic(e):("gmlobjectid"==a||"featureid"==a)&&(r=this.parseID(e)),r},parseBBox:function(e){var r=this,a=new GeoBeans.BBoxFilter;return $(e).children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),e=e.toLowerCase(),"propertyname"==e){var n=r.parsePropertyName(this);a.propertyName=n}else if("envelope"==e){var t=r.parseEnvelope(this);a.envelope=t}}),a},parseBinaryComparision:function(e,r){var a=new GeoBeans.BinaryComparisionFilter,n=this.parseComparisionOperator(e);if(n==GeoBeans.ComparisionFilter.OperatorType.ComOprIsBetween){var t=this.parseIsBetween(r);return t}a.operator=n;var i=$(r).children();if(null!=i[0]){var o=i[0],s=this.parseExpression(o);null!=s&&(a.expression1=s)}if(null!=i[1]){var l=i[1],p=this.parseExpression(l);null!=p&&(a.expression2=p)}return a},parseIsBetween:function(e){for(var r=new GeoBeans.IsBetweenFilter,a=$(e).children(),n=0;n<a.length;++n){var t=a[n],i=t.tagName;if(i=i.toLowerCase(),"ogc:lowerboundary"==i){var o=$(t).children();if(null!=o[0]){var s=this.parseExpression(o[0]);r.lowerBound=s}}else if("ogc:upperboundary"==i){var l=$(t).children();if(null!=l[0]){var p=this.parseExpression(l[0]);r.upperBound=p}}else{var u=this.parseExpression(t);r.expression=u}}return r},parseBinaryLogical:function(e,r){var a=this,n=new GeoBeans.BinaryLogicFilter;return"and"==e?n.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd:"or"==e&&(n.operator=GeoBeans.LogicFilter.OperatorType.LogicOprOr),$(r).children().each(function(){var e=a.parseFilter(this);null!=e&&n.addFilter(e)}),n},parseUnaryLogic:function(e){var r=new GeoBeans.UnaryLogicFilter,a=$(e).children()[0];if(null!=a){var n=this.parseFilter(a);if(null!=n)return r.filter=n,r}return null},parseID:function(e){for(var r=$(e),a=new GeoBeans.IDFilter;0!=r.length;){var n=r.attr("gml:id");if(null==n&&(n=r.attr("gml:fid")),null!=n){var t=n.slice(n.lastIndexOf(".")+1,n.length);a.addID(parseInt(t))}r=r.next()}return a},parseComparisionOperator:function(e){var r=null;switch(e=e.toLowerCase()){case"propertyisequal":r=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;break;case"propertyisnotequal":r=GeoBeans.ComparisionFilter.OperatorType.ComOprNotEqual;break;case"propertyislessthan":r=GeoBeans.ComparisionFilter.OperatorType.ComOprLessThan;break;case"propertyisgreaterthan":r=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThan;break;case"propertyislessthanorequalto":r=GeoBeans.ComparisionFilter.OperatorType.ComOprLessThanOrEqual;break;case"propertyisgreaterthanorequalto":r=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThanOrEqual;break;case"propertyisislike":r=GeoBeans.ComparisionFilter.OperatorType.ComOprIsLike;break;case"propertyisisnull":r=GeoBeans.ComparisionFilter.OperatorType.ComOprIsNull;break;case"propertyisbetween":r=GeoBeans.ComparisionFilter.OperatorType.ComOprIsBetween;break;default:r=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual}return r},parseExpression:function(e){var r=null,a=e.tagName;return a=a.slice(a.lastIndexOf(":")+1,a.length),a=a.toLowerCase(),"propertyname"==a?r=this.parsePropertyName(e):"literal"==a&&(r=this.parseLiteral(e)),r},parsePropertyName:function(e){var r=$(e).text();if(null!=r){var a=new GeoBeans.PropertyName;return a.name=r,a}return null},parseLiteral:function(e){var r=$(e).text();if(null!=name){var a=new GeoBeans.Literal;return a.value=r,a}return null},parseEnvelope:function(e){var r=null,a=null,n=null,t=null;if($(e).children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),e=e.toLowerCase(),"lowercorner"==e){var i=$(this).text(),o=i.indexOf(" "),s=i.lastIndexOf(" ");r=i.slice(0,o),a=i.slice(s+1,i.length)}else if("uppercorner"==e){var i=$(this).text(),o=i.indexOf(" "),s=i.lastIndexOf(" ");n=i.slice(0,o),t=i.slice(s+1,i.length)}}),null!=r&&null!=a&&null!=n&&null!=t){var i=new GeoBeans.Envelope(parseFloat(r),parseFloat(a),parseFloat(n),parseFloat(t));return i}return null}});
GeoBeans.FilterWriter=GeoBeans.Class({initialize:function(){},write:function(e,r){if(null==r)return null;var t=e.createElement("ogc:Filter"),i=this.writeFilter(e,r);return $(t).append(i),t},writeFilter:function(e,r){var t=r.type,i=null;return t==GeoBeans.Filter.Type.FilterID?i=this.writeIDFilter(e,r):t==GeoBeans.Filter.Type.FilterComparsion?i=this.writeComparsionFilter(e,r):t==GeoBeans.Filter.Type.FilterLogic?i=this.writeLogicFilter(e,r):t==GeoBeans.Filter.Type.FilterSpatial&&(i=this.writeSpatialFilter(e,r)),i},writeIDFilter:function(e,r){},writeComparsionFilter:function(e,r){var t=r.operator,i=null;if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprEqual){i=e.createElement("ogc:PropertyIsEqualTo");var n=r.expression1,o=r.expression2,p=this.writeExpression(e,n),a=this.writeExpression(e,o);$(i).append(p),$(i).append(a)}else if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprNotEqual){i=e.createElement("ogc:PropertyIsNotEqual");var n=r.expression1,o=r.expression2,p=this.writeExpression(e,n),a=this.writeExpression(e,o);$(i).append(p),$(i).append(a)}else if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprLessThan){i=e.createElement("ogc:PropertyIsLessThan");var n=r.expression1,o=r.expression2,p=this.writeExpression(e,n),a=this.writeExpression(e,o);$(i).append(p),$(i).append(a)}else if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThan){i=e.createElement("ogc:PropertyIsGreaterThan");var n=r.expression1,o=r.expression2,p=this.writeExpression(e,n),a=this.writeExpression(e,o);$(i).append(p),$(i).append(a)}else if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprLessThanOrEqual){i=e.createElement("ogc:PropertyIsLessThanOrEqualTo");var n=r.expression1,o=r.expression2,p=this.writeExpression(e,n),a=this.writeExpression(e,o);$(i).append(p),$(i).append(a)}else if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThanOrEqual){i=e.createElement("ogc:PropertyIsGreaterThanOrEqualTo");var n=r.expression1,o=r.expression2,p=this.writeExpression(e,n),a=this.writeExpression(e,o);$(i).append(p),$(i).append(a)}else if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprIsLike){i=e.createElement("ogc:PropertyIsLike"),$(i).attr("escapeChar","!"),$(i).attr("singleChar","#"),$(i).attr("wildCard","*");var s=r.properyName,l=r.literal,c=this.writeExpression(e,s),m=this.writeExpression(e,l);$(i).append(c),$(i).append(m)}else if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprIsNull)i=e.createElement("ogc:PropertyIsIsNull");else if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprIsBetween){i=e.createElement("ogc:PropertyIsBetween");var E=r.expression,x=this.writeExpression(e,E),u=r.lowerBound,w=this.writeExpression(e,u),y=r.upperBound,F=this.writeExpression(e,y),h=e.createElement("ogc:LowerBoundary");$(h).append(w);var B=e.createElement("ogc:UpperBoundary");$(B).append(F),$(i).append(h),$(i).append(B),$(i).append(x)}return i},writeExpression:function(e,r){var t=null,i=r.type;if(i==GeoBeans.Expression.Type.Arithmetic);else if(i==GeoBeans.Expression.Type.PropertyName){t=e.createElement("ogc:PropertyName");var n=r.name;$(t).text(n)}else if(i==GeoBeans.Expression.Type.Literal){t=e.createElement("ogc:Literal");var o=r.value;$(t).text(o)}else i==GeoBeans.Expression.Type.Function;return t},writeLogicFilter:function(e,r){var t=r.operator,i=null;if(t==GeoBeans.LogicFilter.OperatorType.LogicOprAnd)i=e.createElement("ogc:And");else if(t==GeoBeans.LogicFilter.OperatorType.LogicOprOr)i=e.createElement("ogc:Or");else if(t==GeoBeans.LogicFilter.OperatorType.LogicOprNot){i=e.createElement("ogc:Not");var n=r.filter,o=this.writeFilter(e,n);return $(i).append(o),i}for(var p=r.filters,a=0;a<p.length;++a){var n=p[a],o=this.writeFilter(e,n);$(i).append(o)}return i},writeSpatialFilter:function(e,r){var t=r.operator,i=null;return t==GeoBeans.SpatialFilter.OperatorType.SpOprBBox?i=this.writeBBoxFilter(e,r):t==GeoBeans.SpatialFilter.OperatorType.SpOprIntersects&&(i=this.writeSpatialFilterIntersects(e,r)),i},writeBBoxFilter:function(e,r){var t=e.createElement("ogc:BBOX"),i=r.propName,n=this.writeExpression(e,i);$(t).append(n);var o=r.extent,p=this.writeEnvelope(e,o);return $(t).append(p),t},writeEnvelope:function(e,r){var t=r.xmin,i=r.ymin,n=r.xmax,o=r.ymax,p=e.createElement("gml:Envelope"),a=e.createElement("gml:lowerCorner");$(a).text(t+" "+i);var s=e.createElement("gml:upperCorner");return $(s).text(n+" "+o),$(p).append(a),$(p).append(s),p},writeSpatialFilterIntersects:function(e,r){var t=e.createElement("Intersects"),i=r.geometry,n=r.propName,o=new GeoBeans.Geometry.GML.Writer(GeoBeans.Geometry.GML.Version.v_2_0),p=o.write(i),a=e.createElement("PropertyName");return $(a).text(n),$(t).append(a),$(t).append(p),t}});
GeoBeans.IDFilter=GeoBeans.Class(GeoBeans.Filter,{ids:null,initialize:function(){GeoBeans.Filter.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Filter.Type.FilterID,this.ids=[]},addID:function(i){this.ids.push(i)}});
GeoBeans.Literal=GeoBeans.Class(GeoBeans.Expression,{value:null,initialize:function(){GeoBeans.Expression.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Expression.Type.Literal},setValue:function(e){this.value=e},clone:function(){var e=new GeoBeans.Literal;return e.value=this.value,e.type=this.type,e}});
GeoBeans.LogicFilter=GeoBeans.Class(GeoBeans.Filter,{operator:null,initialize:function(){GeoBeans.Filter.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Filter.Type.FilterLogic}}),GeoBeans.LogicFilter.OperatorType={LogicOprAnd:"and",LogicOprOr:"or",LogicOprNot:"not"};
GeoBeans.OrderBy=GeoBeans.Class({fields:null,order:null,initialize:function(){this.fields=[]},destory:function(){this.fields=null},addField:function(e){null!=e&&this.fields.push(e)},getField:function(e){return 0>e||e>=this.fields.length?null:this.fields[e]},getFieldCount:function(){return this.fields.length},setOrder:function(e){this.order=e},isAsc:function(){return this.order==GeoBeans.OrderBy.OrderType.OrderAsc}}),GeoBeans.OrderBy.OrderType={OrderAsc:"asc",OrderDesc:"desc"};
GeoBeans.PropertyName=GeoBeans.Class({name:null,initialize:function(){this.type=GeoBeans.Expression.Type.PropertyName},clone:function(){var e=new GeoBeans.PropertyName;return e.name=this.name,e},setName:function(e){this.name=e}});
GeoBeans.SpatialFilter=GeoBeans.Class(GeoBeans.Filter,{operator:null,propName:null,geometry:null,initialize:function(){GeoBeans.Filter.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Filter.Type.FilterSpatial}}),GeoBeans.SpatialFilter.OperatorType={SpOprIntersects:"intersects",SpOprDWithin:"dwithin",SpOprEquals:"equals",SpOprDisjoint:"disjoint",SpOprTouchs:"touchs",SpOprCrosses:"crosses",SpOprByond:"byond",SpOprContains:"contains",SpOprOverlaps:"overlaps",SpOprBBox:"bbox"};
GeoBeans.UnaryLogicFilter=GeoBeans.Class(GeoBeans.LogicFilter,{filter:null,initialize:function(){GeoBeans.LogicFilter.prototype.initialize.apply(this,arguments),this.operator=GeoBeans.LogicFilter.OperatorType.LogicOprNot}});
GeoBeans.BinaryComparisionFilter=GeoBeans.Class(GeoBeans.ComparisionFilter,{expression1:null,expression2:null,initialize:function(){GeoBeans.ComparisionFilter.prototype.initialize.apply(this,arguments)},clone:function(){var e=new GeoBeans.BinaryComparisionFilter;return e.type=this.type,null!=this.expression1&&(e.expression1=this.expression1.clone()),null!=this.expression2&&(e.expression2=this.expression2.clone()),null!=this.operator&&(e.operator=this.operator),e}});
GeoBeans.IsBetweenFilter=GeoBeans.Class(GeoBeans.ComparisionFilter,{expression:null,lowerBound:null,upperBound:null,initialize:function(){GeoBeans.ComparisionFilter.prototype.initialize.apply(this,arguments),this.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprIsBetween},clone:function(){var e=new GeoBeans.IsBetweenFilter;return e.type=this.type,null!=this.expression&&(e.expression=this.expression.clone()),null!=this.lowerBound&&(e.lowerBound=this.lowerBound.clone()),null!=this.upperBound&&(e.upperBound=this.upperBound.clone()),e}});
GeoBeans.IsLikeFilter=GeoBeans.Class(GeoBeans.ComparisionFilter,{properyName:null,literal:null,initialize:function(){GeoBeans.ComparisionFilter.prototype.initialize.apply(this,arguments),this.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprIsLike}});
GeoBeans.IsNullFilter=GeoBeans.Class(GeoBeans.ComparisionFilter,{properyName:null,initialize:function(){GeoBeans.ComparisionFilter.prototype.initialize.apply(this,arguments),this.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprIsNull}});
GeoBeans.BinaryLogicFilter=GeoBeans.Class(GeoBeans.LogicFilter,{filters:null,initialize:function(){GeoBeans.LogicFilter.prototype.initialize.apply(this,arguments),this.filters=[]},addFilter:function(i){this.filters.push(i)}});
GeoBeans.BBoxFilter=GeoBeans.Class(GeoBeans.SpatialFilter,{propName:null,extent:null,initialize:function(){GeoBeans.SpatialFilter.prototype.initialize.apply(this,arguments),this.operator=GeoBeans.SpatialFilter.OperatorType.SpOprBBox},setExtent:function(e,t,a,i){}});
GeoBeans.BinarySpatialFilter=GeoBeans.Class(GeoBeans.SpatialFilter,{propName:null,envelope:null,unitType:null,initialize:function(){GeoBeans.SpatialFitler.prototype.initialize.apply(this,arguments)}});
GeoBeans.Geometry.Circle=GeoBeans.Class(GeoBeans.Geometry,{center:null,radius:null,type:GeoBeans.Geometry.Type.CIRCLE,initialize:function(e,n){this.center=e,this.radius=n}});
GeoBeans.Geometry.GeometryCollection=GeoBeans.Class(GeoBeans.Geometry,{components:null,initialize:function(n){this.components=[]},addComponents:function(n){n instanceof Array||(n=[n]);for(var o=0,e=n.length;e>o;o++)this.addComponent(n[o])},addComponent:function(n){this.components.push(n)}});
GeoBeans.Geometry.GML=GeoBeans.Class({initialize:function(e){this.name=e},destory:function(){GeoBeans.Class.prototype.destory.apply(this,arguments)}}),GeoBeans.Geometry.GML.Version={v_2_0:"2.0",v_3_1_1:"3.1.1",v_3_2_1:"3.2.1"},GeoBeans.Geometry.GML.Type={Point:"gml:Point",LineString:"gml:LineString",Polygon:"gml:Polygon",MultiPoint:"gml:MultiPoint",MultiLineString:"gml:MultiLineString",MultiPolygon:"gml:MultiPolygon"},GeoBeans.Geometry.GML.Writer=GeoBeans.Class({version:null,initialize:function(e){this.version=e},destory:function(){GeoBeans.Class.prototype.destory.apply(this,arguments)},write:function(e){if(null==e)return null;var n="",t=e.type;switch(t){case GeoBeans.Geometry.Type.POINT:n=this.writePoint(e);break;case GeoBeans.Geometry.Type.LINESTRING:n=this.writeLineString(e);break;case GeoBeans.Geometry.Type.POLYGON:n=this.writePolygon(e);break;case GeoBeans.Geometry.Type.MULTIPOINT:break;case GeoBeans.Geometry.Type.MULTILINESTRING:n=this.writeMultiLinestring(e);break;case GeoBeans.Geometry.Type.MULTIPOLYGON:n=this.writeMultiPolygon(e)}return n},writePoint:function(e){var n="";return n+=' <gml:Point><gml:coordinates xmlns:gml="http://www.opengis.net/gml" decimal="." cs="," ts=" ">',n+=e.x,n+=",",n+=e.y,n+="</gml:coordinates></gml:Point>"},writeLineString:function(e){var n="",t=e.points;n+="<LineString><coordinates>";for(var r=0;r<t.length;++r){var i=t[r],o=i.x,l=i.y;n+=o,n+=",",n+=l+" "}return n+="</coordinates></LineString>"},writePolygon:function(e){var n="",t=e.rings;n+="<gml:Polygon>";for(var r=0;r<t.length;++r){n+="<gml:outerBoundaryIs>",n+="<gml:LinearRing>",n+='<gml:coordinates xmlns:gml="http://www.opengis.net/gml" decimal="." cs="," ts=" ">';for(var i=t[r],o=i.points,l=0;l<o.length;++l){var a=o[l],s=a.x,g=a.y;n+=s,n+=",",n+=g+" "}n+="</gml:coordinates>",n+="</gml:LinearRing>",n+="</gml:outerBoundaryIs>"}return n+="</gml:Polygon>"},writeMultiLinestring:function(e){var n="",t=e.lines;n+="<gml:MultiLineString>";for(var r=0;r<t.length;++r){var i=t[r].points;n+="<gml:lineStringMember>",n+="<gml:LineString>",n+='<gml:coordinates xmlns:gml="http://www.opengis.net/gml" decimal="." cs="," ts=" ">';for(var o=0;o<i.length;++o){var l=i[o],a=l.x,s=l.y;n+=a,n+=",",n+=s+" "}n+="</gml:coordinates>",n+="</gml:LineString></gml:lineStringMember>"}return n+="</gml:MultiLineString>"},writeMultiPolygon:function(e){var n="",t=e.polygons;n+="<gml:MultiPolygon>";for(var r=0;r<t.length;++r){var i=t[r],o=i.rings;n+="<gml:polygonMember>",n+="<gml:Polygon>";for(var l=0;l<o.length;++l){n+="<gml:outerBoundaryIs>",n+="<gml:LinearRing>",n+='<gml:coordinates xmlns:gml="http://www.opengis.net/gml" decimal="." cs="," ts=" ">';for(var a=o[l],s=a.points,g=0;g<s.length;++g){var y=s[g],u=y.x,m=y.y;n+=u,n+=",",n+=m+" "}n+="</gml:coordinates>",n+="</gml:LinearRing>",n+="</gml:outerBoundaryIs>"}n+="</gml:Polygon>",n+="</gml:polygonMember>"}return n+="</gml:MultiPolygon>"}}),GeoBeans.Geometry.GML.Reader=GeoBeans.Class({version:null,initialize:function(e){this.version=e},destory:function(){GeoBeans.Class.prototype.destory.apply(this,arguments)},read:function(e){var n=null,t=e.tagName;switch(t){case GeoBeans.Geometry.GML.Type.Point:n=this.readPoint(e);break;case GeoBeans.Geometry.GML.Type.LineString:n=this.readLineString(e);break;case GeoBeans.Geometry.GML.Type.Polygon:n=this.readPolygon(e);break;case GeoBeans.Geometry.GML.Type.MultiPoint:break;case GeoBeans.Geometry.GML.Type.MultiLineString:n=this.readMultiLineString(e);break;case GeoBeans.Geometry.GML.Type.MultiPolygon:n=this.readMultiPolygon(e)}return n},readPoint:function(e){return this.parsePoint($(e).children().first())},readLineString:function(e){var n=this.parsePoints($(e).children().first());return 0==n.length?null:new GeoBeans.Geometry.LineString(n)},readPolygon:function(e){var n=this,t=null,r=new Array,i=new Array;return $(e).find("LinearRing").each(function(e,o){i=n.parsePoints($(this).children().first()),t=new GeoBeans.Geometry.LinearRing(i),r.push(t)}),0==r.length?null:new GeoBeans.Geometry.Polygon(r)},readMultiLineString:function(e){var n=this,t=null,r=new Array;return $(e).find("LineString").each(function(e,i){t=n.readLineString(this),r.push(t)}),0==r.length?null:new GeoBeans.Geometry.MultiLineString(r)},readMultiPolygon:function(e){var n=this,t=null,r=new Array;return $(e).find("Polygon").each(function(e,i){t=n.readPolygon(this),null!=t&&r.push(t)}),new GeoBeans.Geometry.MultiPolygon(r)},parsePoint:function(e){var n=($(e).attr("ts"),$(e).attr("cs")),t=($(e).attr("dc"),$(e).text()),r=t.split(n),i=new GeoBeans.Geometry.Point(parseFloat(r[0]),parseFloat(r[1]));return i},parsePoints:function(e){for(var n,t,r=$(e).attr("ts"),i=$(e).attr("cs"),o=($(e).attr("dc"),$(e).text()),l=o.split(r),a=l.length,s=new Array,g=0;a>g;g++)t=l[g].split(i),n=new GeoBeans.Geometry.Point(parseFloat(t[0]),parseFloat(t[1])),s.push(n);return s}});
GeoBeans.Geometry.LineString=GeoBeans.Class(GeoBeans.Geometry,{points:null,type:GeoBeans.Geometry.Type.LINESTRING,initialize:function(t){this.points=t,this.extent=this.computeExtent(this.points)},destory:function(){this.points=null},hit:function(t,n,e){if(!this.extent.contain(t,n))return!1;for(var s=this.points.length-1,a=null,i=null,o=0,h=0;s>h;h++)if(a=this.points[h],i=this.points[h+1],o=this.distance2segment(t,n,a.x,a.y,i.x,i.y),e>o)return!0;return!1},distance:function(t,n){for(var e=this.points.length-1,s=null,a=null,i=0,o=0,h=0;e>h;h++)s=this.points[h],a=this.points[h+1],o=this.distance2segment(t,n,s.x,s.y,a.x,a.y),i>o&&(o=i);return i},distance2segment:function(t,n,e,s,a,i){var o=0;if(Math.abs(e-a)<Math.ESPLON){var h=i>s?s:i,r=s>i?s:i;n>h&&r>n?o=Math.abs(t-e):h>n?o=Math.sqrt(Math.pow(t-e,2)+Math.pow(n-h,2)):n>r&&(o=Math.sqrt(Math.pow(t-e,2)+Math.pow(n-r,2)))}else if(Math.abs(s-i)<Math.ESPLON){var p=a>e?e:a,M=e>a?e:a;t>p&&M>t?o=Math.abs(n-s):p>t?o=Math.sqrt(Math.pow(n-s,2)+Math.pow(t-p,2)):n>r&&(o=Math.sqrt(Math.pow(n-s,2)+Math.pow(t-M,2)))}else{var l=-(a-e)/(i-s),u=-1/l,y=s-u*e,f=n-l*t,w=l-u,x=(y-f)/w,c=l*x+f,p=a>e?e:a,M=e>a?e:a;if(x>p&&M>x||c>h&&r>c)o=Math.sqrt(Math.pow(n-c,2)+Math.pow(t-x,2));else{var v=Math.sqrt(Math.pow(s-c,2)+Math.pow(e-x,2)),G=Math.sqrt(Math.pow(i-c,2)+Math.pow(a-x,2));o=G>v?v:G}}return o},computeExtent:function(t){var n=t.length;if(0==n)return null;for(var e=t[0],s=e.x,a=e.y,i=e.x,o=e.y,h=1;n>h;h++)e=t[h],e.x<s&&(s=e.x),e.x>i&&(i=e.x),e.y<a&&(a=e.y),e.y>o&&(o=e.y);return new GeoBeans.Envelope(s,a,i,o)},getCentroid:function(){for(var t,n=0,e=0,s=0,a=0;a<this.points.length;++a)t=this.points[a],n+=t.x,e+=t.y;n/=s,e/=s;var t=new GeoBeans.Geometry.Point(n,e);return t}});
GeoBeans.Geometry.MultiLineString=GeoBeans.Class(GeoBeans.Geometry,{lines:null,type:GeoBeans.Geometry.Type.MULTILINESTRING,initialize:function(e){this.lines=e,this.extent=this.computeExtent()},destory:function(){this.lines=null},hit:function(e,n,t){if(!this.extent.contain(e,n))return!1;for(var i=this.lines.length,r=0;i>r;r++){var s=this.lines[r];if(s.hit(e,n,t))return!0}return!1},computeExtent:function(){var e=null,n=this.lines.length;if(1>n)return null;var t=this.lines[0];e=new GeoBeans.Envelope(t.extent.xmin,t.extent.ymin,t.extent.xmax,t.extent.ymax);for(var i=1;n>i;i++)t=this.lines[i],e.union(t.extent);return e},getCentroid:function(){for(var e=0,n=0,t=0,i=0;i<this.lines.length;++i){var r=this.lines[i],s=r.points;t+=s.length;for(var o=0;o<s.length;++o){var l=s[o];e+=l.x,n+=l.y}}e/=t,n/=t;var l=new GeoBeans.Geometry.Point(e,n);return l}});
GeoBeans.Geometry.MultiPoint=GeoBeans.Class(GeoBeans.Geometry,{points:null,type:GeoBeans.Geometry.Type.MULTIPOINT,initialize:function(t){this.points=t,this.extent=this.computeExtent(this.points)},destory:function(){this.points=null},hit:function(t,e,n){for(var i=this.points.length,o=0;i>o;o++){var s=this.points[o];if(s.hit(t,e,n))return truel}return!1},computeExtent:function(t){var e=t.length;if(0==e)return null;for(var n=t[0],i=n.x,o=n.y,s=n.x,r=n.y,u=1;e>u;u++)n=t[u],n.x<i&&(i=n.x),n.x>s&&(s=n.x),n.y<o&&(o=n.y),n.y>r&&(r=n.y);return new GeoBeans.Envelope(i,o,s,r)}});
GeoBeans.Geometry.MultiPolygon=GeoBeans.Class(GeoBeans.Geometry,{polygons:null,type:GeoBeans.Geometry.Type.MULTIPOLYGON,initialize:function(n){this.polygons=n,this.extent=this.computeExtent()},destory:function(){this.polygons=null},hit:function(n,t,e){if(!this.extent.contain(n,t))return!1;for(var o=null,r=this.polygons.length,i=0;r>i;i++)if(o=this.polygons[i],o.hit(n,t))return!0;return!1},computeExtent:function(){var n=null,t=this.polygons.length;if(1>t)return null;var e=this.polygons[0];n=new GeoBeans.Envelope(e.extent.xmin,e.extent.ymin,e.extent.xmax,e.extent.ymax);for(var o=1;t>o;o++)e=this.polygons[o],n.union(e.extent);return n},getCentroid:function(){for(var n,t,e,o,r=0,i=0,s=0,l=0;l<this.polygons.length;++l){n=this.polygons[l],t=n.rings;for(var a=0;a<t.length;++a){e=t[a],o=e.points,s+=o.length;for(var y=0;y<o.length;++y)h=o[y],r+=h.x,i+=h.y}}r/=s,i/=s;var h=new GeoBeans.Geometry.Point(r,i);return h},toPointsArray:function(){for(var n=[],t=0;t<this.polygons.length;++t){var e=this.polygons[t];if(null!=e){var o=e.toPointsArray();n=n.concat(o)}}return n}});
GeoBeans.Geometry.Point=GeoBeans.Class(GeoBeans.Geometry,{x:null,y:null,type:GeoBeans.Geometry.Type.POINT,initialize:function(e,t){this.x=parseFloat(e),this.y=parseFloat(t),this.extent=new GeoBeans.Envelope(this.x,this.y,this.x,this.y)},hit:function(e,t,n){var s=Math.abs(this.x-e)+Math.abs(this.y-t);return n>s},getCentroid:function(){return new GeoBeans.Geometry.Point(this.x,this.y)}});
GeoBeans.Geometry.Polygon=GeoBeans.Class(GeoBeans.Geometry,{rings:null,type:GeoBeans.Geometry.Type.POLYGON,initialize:function(t){this.rings=t,this.extent=this.computeExtent()},hit:function(t,n,e){if(!this.extent.contain(t,n))return!1;for(var r=0,i=this.rings.length,s=0;i>s;s++)for(var o,a,h=this.rings[s],u=h.points,g=u.length-1,l=0;g>l;l++)o=u[l],a=u[l+1],this.isSegmentShooted(t,n,o,a)&&r++;var f=r%2;return 0!=f},computeExtent:function(){var t=null,n=this.rings.length;if(1>n)return null;var e=this.rings[0];t=new GeoBeans.Envelope(e.extent.xmin,e.extent.ymin,e.extent.xmax,e.extent.ymax);for(var r=1;n>r;r++)e=this.rings[r],t.union(e.extent);return t},getCrossedSegments:function(){},isSegmentShooted:function(t,n,e,r){if(Math.abs(e.y-r.y)<Number.EPSILON){if(Math.abs(n-e.y)<Number.EPSILON)return!1;if(Math.abs(n-r.y)<Number.EPSILON)return!1}else if((n>e.y&&n<r.y||n>r.y&&n<e.y)&&t<e.x&&t<r.x)return!0;return!1},getCentroid:function(){for(var t=0,n=0,e=0,r=0;r<this.rings.length;++r){var i=this.rings[r];if(null!=i){var s=i.points;e+=s.length;for(var o=0;o<s.length;++o){var a=s[o];t+=a.x,n+=a.y}}}t/=e,n/=e;var a=new GeoBeans.Geometry.Point(t,n);return a},toPointsArray:function(){for(var t=[],n=0;n<this.rings.length;++n){var e=this.rings[n];if(null!=e)for(var r=e.points,i=0;i<r.length;++i){var s=r[i],o=s.x,a=s.y;t.push(o),t.push(a)}}return t}});
GeoBeans.Geometry.LinearRing=GeoBeans.Class(GeoBeans.Geometry.LineString,{points:null,initialize:function(e){GeoBeans.Geometry.LineString.prototype.initialize.apply(this,arguments)},destory:function(){GeoBeans.Geometry.LineString.prototype.destory.apply(this,arguments)},numPoints:function(){return this.points.length}});
GeoBeans.GPSManager=GeoBeans.Class({server:null,service:"gps",version:"1.0.0",initialize:function(e){this.server=e+"/mgr"},getCapabilities:function(e){var t=this,n="service="+this.service+"&version="+this.version+"&request=GetCapabilities";$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(n,r){var u=t.parseGetCapabilities(n);null!=e&&e(u)},complete:function(e,t){},error:function(){}})},parseGetCapabilities:function(e){var t=[];return $(e).find("OperationsSet").each(function(){var e=$(this),n=e.attr("type"),r=e.attr("description"),u={type:n,description:r},s=[];e.find("Operation").each(function(){var e=$(this).find("Name").first().text(),t=$(this).find("Alias").first().text(),n={name:e,alias:t};s.push(n)}),u.operList=s,t.push(u)}),t},clusterKmean:function(e,t,n,r,u,s){if(null==e||null==t||null==n||null==r||null==u)return void(null!=s&&s("params is invalid"));var i=this,a="service="+this.service+"&version="+this.version+"&request=KMean&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r+"&clusters="+u;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.parseClusterKmean(e);null!=s&&s(n)},complete:function(e,t){},error:function(){}})},parseClusterKmean:function(e){var t=$(e).find("KMean").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},featureProject:function(e,t,n,r,u,s){if(null==e||null==t||null==n||null==r)return void(null!=s&&s("params is invalid"));var i=this,a="service=gps&vesion=1.0.0&request=FeatureProject&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r+"&outputSrid="+u,i=this;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.parseFeatureProject(e);null!=s&&s(n)},complete:function(e,t){},error:function(){}})},parseFeatureProject:function(e){var t=$(e).find("FeatureProject").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},featureImport:function(e,t,n,r,u,s,i){if(null==e||null==t||null==n)return void(null!=i&&i("params is invalid"));var a="service=gps&vesion=1.0.0&request=FeatureImport&sourcename="+e+"&typeName="+t+"&shppath="+n+"&shpname="+r;a+=null!=u?"&srid="+u:"&srid=4326",a+=null!=s?"&geom="+s:"&geom=shape";var o=this;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=o.parseFeatureImport(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseFeatureImport:function(e){var t=$(e).find("FeatureImport").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},getSpatialReferenceList:function(e,t,n){var r=this,u="service="+this.service+"&version="+this.version+"&request=GetSpatialReference";null!=e&&(u+="&count="+e),null!=t&&(u+="&offset="+t),$.ajax({type:"get",url:this.server,data:encodeURI(u),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var u=r.parseSpatialReferences(e);null!=n&&n(u)},complete:function(e,t){},error:function(){}})},parseSpatialReferences:function(e){var t=[],n=this;return $(e).find("SpatialReference").each(function(){var e=n.parseSpatialReference(this);t.push(e)}),t},parseSpatialReference:function(e){var t=$(e).find("srid").text(),n=$(e).find("srtext").text(),r=$(e).find("proj4").text(),u=null;return null!=t&&(u=new GeoBeans.SpatialReference(t,n,r)),u},getSpatialReferenceBySrid:function(e,t){if(null==e)return void(null!=t&&t("srid is null"));var n=this,r="service="+this.service+"&version="+this.version+"&request=GetSpatialReference&srid="+e;$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var u=n.parseSpatialReferences(e);null!=t&&t(u)},complete:function(e,t){},error:function(){}})},getSpatialReferenceCount:function(e){var t=this,n="service="+this.service+"&version="+this.version+"&request=GetSpatialReferenceCount";$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(n,r){var u=t.parseGetSpatialReferenceCount(n);null!=e&&e(u)},complete:function(e,t){},error:function(){}})},parseGetSpatialReferenceCount:function(e){var t=$(e).find("Count").text();return t=parseInt(t)},rasterReverse:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=RasterReverse&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseRasterReverse(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseRasterReverse:function(e){var t=$(e).find("RasterReverse").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterGraylize:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=RasterGraylize&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseRasterGraylize(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseRasterGraylize:function(e){var t=$(e).find("RasterGraylize").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterSmooth:function(e,t,n,r,u,s,i,a){if(null==e||null==t||null==r||null==u||null==i)return void(null!=a&&a("params is invalid"));var o=this,l="service="+this.service+"&version="+this.version+"&request=RasterSmooth&inputSourceName="+e+"&inputRasterName="+t+"&operator="+r+"&outputSourceName="+u+"&outPutRasterName="+s;null!=n&&(l+="&inputPath="+n),null!=i&&(l+="&outputPath="+i),$.ajax({type:"get",url:this.server,data:encodeURI(l),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=o.parseRasterSmooth(e);null!=a&&a(n)},complete:function(e,t){},error:function(e,t,n){a(n)}})},parseRasterSmooth:function(e){var t=$(e).find("RasterSmooth").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterStretch:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=RasterStretch&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseRasterStretch(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseRasterStretch:function(e){var t=$(e).find("RasterStretch").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterSubtract:function(e,t,n,r,u,s,i,a,o,l){if(null==e||null==t||null==r||null==u||null==i||null==a)return void(null!=l&&l("params is invalid"));var c=this,p="service="+this.service+"&version="+this.version+"&request=RasterSubtract&inputSourceName_1="+e+"&inputRasterName_1="+t;null!=n&&(p+="&inputPath_1="+n),p+="&inputSourceName_2="+r+"&inputRasterName_2="+u,null!=s&&(p+="&inputPath_2="+s),p+="&outputSourceName="+i+"&outPutRasterName="+a,null!=o&&(p+="&outputPath="+o),$.ajax({type:"get",url:this.server,data:encodeURI(p),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=c.parseRasterSubtract(e);null!=l&&l(n)},complete:function(e,t){},error:function(){}})},parseRasterSubtract:function(e){var t=$(e).find("RasterSubtract").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterPixelBlend:function(e,t,n,r,u,s,i,a,o,l){if(null==e||null==t||null==r||null==u||null==i||null==a)return void(null!=l&&l("params is invalid"));var c=this,p="service="+this.service+"&version="+this.version+"&request=RasterPixelBlend&inputSourceName_1="+e+"&inputRasterName_1="+t;null!=n&&(p+="&inputPath_1="+n),p+="&inputSourceName_2="+r+"&inputRasterName_2="+u,null!=s&&(p+="&inputPath_2="+s),p+="&outputSourceName="+i+"&outPutRasterName="+a,null!=o&&(p+="&outputPath="+o),$.ajax({type:"get",url:this.server,data:encodeURI(p),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=c.parseRasterPixelBlend(e);null!=l&&l(n)},complete:function(e,t){},error:function(){}})},parseRasterPixelBlend:function(e){var t=$(e).find("RasterPixelBlend").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterEdgeDetect:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=RasterEdgeDetect&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseRasterEdgeDetect(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseRasterEdgeDetect:function(e){var t=$(e).find("RasterEdgeDetect").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterExtractByRectangle:function(e,t,n,r,u,s,i,a){if(null==e||null==t||null==r||null==s||null==i)return void(null!=a&&a("params is invalid"));var o=this,l=i.toString(),c="service="+this.service+"&version="+this.version+"&request=RasterExtractByRectangle&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u+"&extent="+l;null!=n&&(c+="&inputPath="+n),null!=s&&(c+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(c),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=o.parseRasterExtractByRectangle(e);null!=a&&a(n)},complete:function(e,t){},error:function(){}})},parseRasterExtractByRectangle:function(e){var t=$(e).find("RasterExtractByRectangle").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterSepiaTone:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=RasterSepiaTone&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseRasterSepiaTone(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseRasterSepiaTone:function(e){var t=$(e).find("RasterSepiaTone").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},getArea:function(e,t,n,r,u){if(null==e||null==t||null==n||null==r)return void(null!=u&&u("params is invalid"));var s=this,i="service="+this.service+"&version="+this.version+"&request=GetArea&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.praseGetArea(e);null!=u&&u(n)},complete:function(e,t){},error:function(){}})},praseGetArea:function(e){var t=$(e).find("GetArea").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},getLength:function(e,t,n,r,u){if(null==e||null==e||null==n||null==r)return void(null!=u&&u("params is invalid"));var s=this,i="service="+this.service+"&version="+this.version+"&request=GetLength&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.praseGetLength(e);null!=u&&u(n)},complete:function(e,t){},error:function(){}})},praseGetLength:function(e){var t=$(e).find("GetLength").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},getBuffer:function(e,t,n,r,u,s,i){if(null==e||null==t||null==u||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=Buffer&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+u+"&outputTypeName="+s;null!=n&&(o+="&distance="+n),null!=r&&(o+="&distanceField="+r),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.praseGetBuffer(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},praseGetBuffer:function(e){var t=$(e).find("Buffer").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},getCentroid:function(e,t,n,r,u){if(null==e||null==e||null==n||null==r)return void(null!=u&&u("params is invalid"));var s=this,i="service="+this.service+"&version="+this.version+"&request=Centroid&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.praseGetCentroid(e);null!=u&&u(n)},complete:function(e,t){},error:function(){}})},praseGetCentroid:function(e){var t=$(e).find("Centroid").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},convexHull:function(e,t,n,r,u){if(null==e||null==e||null==n||null==r)return void(null!=u&&u("params is invalid"));var s=this,i="service="+this.service+"&version="+this.version+"&request=ConvexHull&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.praseConvexHull(e);null!=u&&u(n)},complete:function(e,t){},error:function(){}})},praseConvexHull:function(e){var t=$(e).find("ConvexHull").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},buildPyramid:function(e,t,n,r,u,s){if(null==e||null==t||null==n||null==r||null==u)return void(null!=s&&s("params is invalid"));var i=this,a="service="+this.service+"&version="+this.version+"&request=BuildPyramid&mapName="+e+"&sourceName="+t+"&tileStore="+n+"&start="+r+"&end="+u;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.praseBuildPyramid(e);null!=s&&s(n)},complete:function(e,t){},error:function(e,t,n){s(n)}})},praseBuildPyramid:function(e){var t=$(e).find("BuildPyramid").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},updateTile:function(e,t,n,r,u,s,i){if(null==e||null==t||null==n||null==r||null==u||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=updateTile&mapName="+e+"&sourceName="+t+"&tileStore="+n+"&level="+r+"&row="+u+"&col="+s;$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseUpdateTile(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseUpdateTile:function(e){var t=$(e).find("UpdateTile").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},rasterHisEqual:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=RasterHistogramEqualization&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseRasterHisEqual(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseRasterHisEqual:function(e){var t=$(e).find("RasterHistogramEqualization").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},demSlope:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=DemSlope&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseDemSlope(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseDemSlope:function(e){var t=$(e).find("DemSlope").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},demAspect:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=DemAspect&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseDemAspect(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseDemAspect:function(e){var t=$(e).find("DemAspect").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},demStretch:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==u)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=DemStretch&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseDemStretch(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseDemStretch:function(e){var t=$(e).find("DemStretch").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},demHillshade:function(e,t,n,r,u,s,i,a,o,l){if(null==e||null==t||null==r||null==u||null==i||null==a||null==o)return void(null!=l&&l("params is invalid"));var c=this,p="service="+this.service+"&version="+this.version+"&request=DemHillshade&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u+"&Azimuth="+i+"&zenith="+a+"&zfactor="+o;null!=n&&(p+="&inputPath="+n),null!=s&&(p+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(p),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=c.parseDemHillshade(e);null!=l&&l(n)},complete:function(e,t){},error:function(){}})},parseDemHillshade:function(e){var t=$(e).find("DemHillshade").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},delaunay:function(e,t,n,r,u,s){if(null==e||null==t||null==r||null==u)return void(null!=s&&s("params is invalid"));var i=this,a="service="+this.service+"&version="+this.version+"&request=Delaunay&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+r+"&outputTypeName="+u;null!=n&&(a+="&inputZField="+n),$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.praseDelaunay(e);null!=s&&s(n)},complete:function(e,t){},error:function(){}})},praseDelaunay:function(e){var t=$(e).find("Delaunay").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterThreshold:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=rasterThreshold&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseRasterThreshold(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseRasterThreshold:function(e){var t=$(e).find("RasterThreshold").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},lineToPoints:function(e,t,n,r,u){if(null==e||null==t||null==n||null==r)return void(null!=u&&u("params is invalid"));var s=this,i="service="+this.service+"&version="+this.version+"&request=LineToPoints&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.praseLineToPoints(e);null!=u&&u(n)},complete:function(e,t){},error:function(){}})},praseLineToPoints:function(e){var t=$(e).find("LineToPoints").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},multiPointToPoints:function(e,t,n,r,u){if(null==e||null==t||null==n||null==r)return void(null!=u&&u("params is invalid"));var s=this,i="service="+this.service+"&version="+this.version+"&request=MultiPointToPoints&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.praseMultiPointToPoints(e);null!=u&&u(n)},complete:function(e,t){},error:function(){}})},praseMultiPointToPoints:function(e){var t=$(e).find("MultiPointToPoints").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},polygonToPoints:function(e,t,n,r,u){if(null==e||null==t||null==n||null==r)return void(null!=u&&u("params is invalid"));var s=this,i="service="+this.service+"&version="+this.version+"&request=PolygonToPoints&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.prasePolygonToPoints(e);null!=u&&u(n)},complete:function(e,t){},error:function(){}})},prasePolygonToPoints:function(e){var t=$(e).find("PolygonToPoints").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},polygonToLine:function(e,t,n,r,u){if(null==e||null==t||null==n||null==r)return void(null!=u&&u("params is invalid"));var s=this,i="service="+this.service+"&version="+this.version+"&request=PolygonToLine&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.prasePolygonToLine(e);null!=u&&u(n)},complete:function(e,t){},error:function(){}})},prasePolygonToLine:function(e){var t=$(e).find("PolygonToLine").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},generateRandomPoints:function(e,t,n,r,u,s){if(null==e||null==t||null==n||null==r||null==u)return void(null!=s&&s("params is invalid"));var i=this,a="service="+this.service+"&version="+this.version+"&request=GenerateRandomPoints&sourceName="+e+"&typeName="+t+"&extent="+n.toString()+"&srid="+r+"&count="+u;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.praseGenerateRandomPoints(e);null!=s&&s(n)},complete:function(e,t){},error:function(){}})},praseGenerateRandomPoints:function(e){var t=$(e).find("GenerateRandomPoints").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},generateRandomPointsInPolygon:function(e,t,n,r,u,s){if(null==e||null==t||null==n||null==r||null==u)return void(null!=s&&s("params is invalid"));var i=this,a="service="+this.service+"&version="+this.version+"&request=GenerateRandomPointsInPolygon&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r+"&count="+u;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.praseGenerateRandomPointsInPolygon(e);null!=s&&s(n)},complete:function(e,t){},error:function(){}})},praseGenerateRandomPointsInPolygon:function(e){var t=$(e).find("GenerateRandomPointsInPolygon").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},getJob:function(e,t,n,r){if(null==e)return void(null!=r&&r("state is null"));var u=this,s="service="+this.service+"&version="+this.version+"&request=GetJob&state="+e;null!=t&&(s+="&maxJobs="+t),null!=n&&(s+="&offset="+n),$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=u.praseGetJob(e);null!=r&&r(n)},complete:function(e,t){},error:function(){}})},praseGetJob:function(e){var t=[],n=this;return $(e).find("Job").each(function(){var e=n.parseJob(this);null!=e&&t.push(e)}),t},parseJob:function(e){var t=$(e).find("UUID").text();if(null==t)return null;var n=$(e).find("Operation").text(),r=$(e).find("Params").text(),u=$(e).find("Client").text(),s=$(e).find("Server").text(),i=$(e).find("StartTime").text(),a=$(e).find("EndTime").text(),o=new GeoBeans.Job(t,n,r,u,s,i,a,status);return o},csvImport:function(e,t,n,r,u,s){if(null==e||null==t||null==n||null==r)return void(null!=s&&s("params is valid"));var i=this,a="service="+this.service+"&version="+this.version+"&request=CsvImport&sourceName="+e+"&typeName="+t+"&csvPath="+n+"&csvName="+r;null!=u&&(a+="&srid="+u),$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.praseCsvImport(e);null!=s&&s(n)},complete:function(e,t){},error:function(){}})},praseCsvImport:function(e){var t=$(e).find("CsvImport").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n}});
GeoBeans.Job=GeoBeans.Class({uuid:null,oper:null,params:null,client:null,server:null,startTime:null,endTime:null,status:null,initialize:function(s,e,i,n,t,l,u,a){this.uuid=s,this.oper=e,this.params=i,this.client=n,this.server=t,this.startTime=l,this.endTime=u,this.status=a}}),GeoBeans.Job.Status={CANCELED:"Canceled",RUNNING:"Running",FINISHED:"Finished"};
GeoBeans.SpatialReference=GeoBeans.Class({srid:null,srtext:null,proj:null,initialize:function(e,i,s){this.srid=e,this.srtext=i,this.proj=s}});
GeoBeans.PointLabel=GeoBeans.Class(GeoBeans.Label,{pos:null,extent:null,initialize:function(){this.pos=new GeoBeans.Geometry.Point(0,0)},computePosition:function(t,e){var i=this.geometry.getCentroid(),s=e.toScreenPoint(i.x,i.y);this.pos.x=s.x,this.pos.y=s.y;var n=this.textSymbolizer.font.size;this.extent=t.getTextExtent(this.text,parseInt(n)),this.pos.x+=this.textSymbolizer.displaceX,this.pos.y+=this.textSymbolizer.displaceY,this.pos.x-=this.extent.getWidth()*this.textSymbolizer.anchorX,this.pos.y+=this.extent.getHeight()*this.textSymbolizer.anchorY,this.extent.offset(this.pos.x,this.pos.y)},adjustPosition:function(t,e){var i=0,s=0;null!=this.extent&&(this.extent.xmin<0?i=-this.extent.xmin:this.extent.xmax>t&&(i=t-this.extent.xmax-2),this.extent.ymin<0?s=-this.extent.ymin:this.extent.ymax>e&&(s=e-this.extent-2),this.extent.offset(i,s),this.pos+=i,this.pos+=s)},isCollision:function(t){if(null==t)return!1;t.extent;return this.extent.intersects(oterhExtent)}});
GeoBeans.Layer.DBLayer=GeoBeans.Class(GeoBeans.Layer,{id:null,dbName:null,typeName:null,queryable:null,type:null,format:"image/png",transparent:"true",image:null,updateFlag:!1,initialize:function(e,a,t,i,s,r){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.id=a,this.dbName=t,this.typeName=i,this.queryable=s,this.visible=r,this.image=new Image},cleanup:function(){},setMap:function(){GeoBeans.Layer.prototype.setMap.apply(this,arguments)},load:function(){var e=this.map.canvas.width,a=this.map.canvas.height,t=this.map.viewer,i=t.xmin.toFixed(6)+","+t.ymin.toFixed(6)+","+t.xmax.toFixed(6)+","+t.ymax.toFixed(6),s="",r="",n=this.name;if(null!=this.styleName&&(r=this.styleName),null!=n&&this.visible){var l=this.map.mapWorkspace.version;s=this.map.server+"?service=WMS&version="+l+"&request=GetMap&layers="+n+"&styles="+r+"&bbox="+i+"&width="+e+"&height="+a+"&srs="+this.srid+"&format="+this.format+"&transparent="+this.transparent+"&mapName="+this.map.name}if(this.renderer.clearRect(0,0,e,a),this.updateFlag){var h=new Date;this.image.src=s+"&t="+h.getTime(),this.updateFlag=!1}else this.image.src=s;var m=this.heatMapLayer;if(null!=m&&m.load(),this.image.complete){this.updateFlag=!1,this.flag=GeoBeans.Layer.Flag.LOADED,this.renderer.drawImage(this.image,0,0,e,a);var o=this.image.src.lastIndexOf("&t=");-1!=o&&(this.image.src=this.image.src.slice(0,o))}else{var p=this;p.flag=GeoBeans.Layer.Flag.READY,this.image.onload=function(){p.flag!=GeoBeans.Layer.Flag.LOADED&&(p.flag=GeoBeans.Layer.Flag.LOADED,p.renderer.drawImage(p.image,0,0,e,a),p.map.drawLayersAll())},this.image.onerror=function(){p.flag=GeoBeans.Layer.Flag.LOADED,p.map.drawLayersAll()}}},update:function(){this.updateFlag=!0}}),GeoBeans.Layer.DBLayer.Type={Raster:"raster",Feature:"feature"};
GeoBeans.Layer.FeatureDBLayer=GeoBeans.Class(GeoBeans.Layer.DBLayer,{styleName:null,geomType:null,initialize:function(e,t,a,n,u,r,i){GeoBeans.Layer.DBLayer.prototype.initialize.apply(this,arguments),void 0!=i&&(this.styleName=i),this.type=GeoBeans.Layer.DBLayer.Type.Feature},setMap:function(e){GeoBeans.Layer.prototype.setMap.apply(this,arguments)},setStyle:function(e){null!=e&&(this.style=e,this.styleName=e.name)},getFeatureType:function(){if(null!=this.featureType)return this.featureType;if(null!=this.map){var e=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0");return this.featureType=new GeoBeans.FeatureType(e,this.name),null==this.featureType.fields&&(this.featureType.fields=this.featureType.getFields(this.map.name,null)),this.featureType}return null},getFeatureBBoxGet:function(e,t,a){var n=this.getFeatureType(),u=null;return null!=n&&(u=n.getFeatureBBoxGet(this.map.name,null,e,t,a)),u},getFeautureBBoxGetOutput:function(e,t,a){var n=null,u=this.getFeatureType();return null!=u&&(n=u.getFeatureBBoxGetOutput(this.map.name,null,e,t,a)),n},getFeatureCount:function(e,t){var a=this.getFeatureType();if(null!=a){var n=a.getCount(this.map.name,null,e);if(null==t)return n;t(this,n)}else{if(null==t)return 0;t(0)}},getFields:function(){var e=this.getFeatureType(),t=null;return null!=e&&(t=e.getFields(this.map.name,null)),t},getHeatMapLayer:function(){return this.heatMapLayer},addHeatMap:function(e,t){if(null!=e||null!=t){var a=this.getFeatureType(),n=a.getFieldIndex(e);if(!(0>n&&null==t)){if(0>n&&null!=t)return this.heatMapLayer=new GeoBeans.Layer.HeatMapLayer(this.name+"-heatMap"),this.heatMapLayer.setMap(this.map),void this.heatMapLayer.setLayer(this,null,t);this.heatMapLayer=new GeoBeans.Layer.HeatMapLayer(this.name+"-heatMap"),this.heatMapLayer.setMap(this.map),this.heatMapLayer.setLayer(this,e,null)}}},removeHeatMap:function(){null!=this.heatMapLayer&&(this.heatMapLayer.destory(),this.heatMapLayer=null)},setHeatMapVisible:function(e){null!=this.heatMapLayer&&(this.heatMapLayer.visible=e)},getFeaturesWithin:function(e){var t=null,a=this.getFeatureType();return null!=a&&(t=a.getFeaturesWithin(this.map.name,null,e)),t},getFeatureFilter:function(e,t,a,n){var u=this.getFeatureType();return null!=u&&(features=u.getFeaturesFilter(this.map.name,null,e,t,a,n)),features},getFeatureFilterCount:function(e){var t=0,a=this.getFeatureType();return null!=a&&(t=a.getFeatureFilterCount(this.map.name,null,e)),t},getFeatureFilterCountAsync:function(e,t){var a=this.getFeatureType();null!=a?a.getFeatureFilterCountAsync(this.map.name,null,e,this,t):null!=t&&t(0)},getFeatureFilterOutput:function(e,t,a){var n=null,u=this.getFeatureType();return null!=u&&(n=u.getFeatureFilterOutput(this.map.name,null,e,t,a)),n}});
GeoBeans.Layer.FeatureLayer=GeoBeans.Class(GeoBeans.Layer,{features:null,style:null,geometryType:null,featureType:null,enableHit:!1,selection:null,unselection:null,hitControl:null,hitEvent:null,hitTooltipEvent:null,hitCanvas:null,hitRenderer:null,bufferCanvas:null,bufferRenderer:null,bufferFeatures:null,bufferSymbolizer:null,bufferTracker:null,initialize:function(e){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.featureType=null,this.selection=[],this.unselection=[]},destory:function(){this.features=null,this.style=null,this.renderer=null,this.geometryType=null,this.featureType=null,GeoBeans.Layer.prototype.destroy.apply(this,arguments)},addFeature:function(e){null!=e&&this.features.push(e)},addFeatures:function(e){if(null!=features&&features instanceof Array)for(var t=0,r=features.length;r>t;t++){var a=features[t];this.features.push(a)}},getFeature:function(e){return 0>e?null:e>=this.features.length?null:this.features[e]},getFeatureByID:function(e){if(null==this.features)return null;for(var t=null,r=0;r<this.features.length;++r)if(t=this.features[r],null!=t&&t.fid==e)return t;return null},setStyle:function(e){this.style=e},count:function(){return this.features.length},draw:function(){var e=this.style;if(null!=e&&(rules=e.rules,0!=rules.length))for(var t=0;t<rules.length;t++){var r=rules[t],a=this.selectFeatures(r.filter);this.drawFeatures(a,r.symbolizer)}},drawLayer:function(){var e=this.style;if(null==e){if(e=this.getDefaultStyle(),null==e)return;this.style=e}if(rules=e.rules,0!=rules.length)for(var t=0;t<rules.length;t++){var r=rules[t],a=this.selectFeaturesByFilter(r.filter);null!=r.symbolizer&&(null!=r.symbolizer.symbol?this.renderer.drawIcons(a,r.symbolizer,this.map.transformation):this.drawFeatures(a,r.symbolizer)),null!=r.textSymbolizer&&this.labelFeatures(a,r.textSymbolizer)}},getGeomType:function(){var e=this.featureType;if(null==e)return null;var t=e.geomFieldName;if(null==t)return null;var r=e.getFieldIndex(t);if(null==r)return null;var a=e.fields[r];if(null==a)return null;var n=a.geomType;return n},getDefaultStyle:function(){var e=this.getGeomType(),t=null;switch(e){case GeoBeans.Geometry.Type.POINT:case GeoBeans.Geometry.Type.MULTIPOINT:t=new GeoBeans.Style.FeatureStyle("default",GeoBeans.Style.FeatureStyle.GeomType.Point);var r=new GeoBeans.Rule,a=new GeoBeans.Symbolizer.PointSymbolizer;r.symbolizer=a,t.addRule(r);break;case GeoBeans.Geometry.Type.LINESTRING:case GeoBeans.Geometry.Type.MULTILINESTRING:t=new GeoBeans.Style.FeatureStyle("default",GeoBeans.Style.FeatureStyle.GeomType.LineString);var r=new GeoBeans.Rule,a=new GeoBeans.Symbolizer.LineSymbolizer;r.symbolizer=a,t.addRule(r);break;case GeoBeans.Geometry.Type.POLYGON:case GeoBeans.Geometry.Type.MULTIPOLYGON:t=new GeoBeans.Style.FeatureStyle("default",GeoBeans.Style.FeatureStyle.GeomType.Polygon);var r=new GeoBeans.Rule,a=new GeoBeans.Symbolizer.PolygonSymbolizer;r.symbolizer=a,t.addRule(r)}return t},drawFeatures:function(e,t){if(0!=e.length){this.renderer.save(),this.renderer.setSymbolizer(t);for(var r=0,a=e.length;a>r;r++)feature=e[r],null!=t&&"undefined"!=t&&this.renderer.draw(feature,t,this.map.transformation);this.renderer.restore()}},labelFeatures:function(e,t){var r=e.length;if(0!=r){this.renderer.save(),this.renderer.setSymbolizer(t);var a=e[0],n=null,s=t.labelText;if(null==s||0==s.length){var i=t.labelProp;if(null!=i)var l=a.featureType.getFieldIndex(i)}else n=s;for(var u=null,o=null,h=null,f=0,r=e.length;r>f;f++)a=e[f],o=a.geometry,null!=o&&(h=new GeoBeans.PointLabel,h.geometry=o,h.textSymbolizer=t,u=null==n?a.values[l]:n,h.text=u,h.computePosition(this.renderer,this.map.transformation),this.renderer.drawLabel(h));this.renderer.restore()}},drawFeature:function(e,t){for(var r=this.selectRules(e),a=r.length,n=0;a>n;n++){var s=r[n];if((null==t||"undefined"==t)&&(t=s.symbolizer),this.map.renderer.save(),this.map.renderer.setSymbolizer(t),t instanceof GeoBeans.Symbolizer.TextSymbolizer){var i=e.featureType.getFieldIndex(t.field);this.map.renderer.label(e.geometry,e.values[i],t,this.map.transformation)}else this.map.renderer.draw(e,t,this.map.transformation);this.map.renderer.restore()}r=null},clearFeature:function(e){switch(e.geometry.type){case GeoBeans.Geometry.Type.POINT:case GeoBeans.Geometry.Type.MULTIPOINT:var t=this.getSymbolizer(e);this.map.renderer.clear(e.geometry,this.map.bgColor,t.size,this.map.transformation);break;default:this.map.renderer.clear(e.geometry,this.map.bgColor,0,this.map.transformation)}},selectFeatures:function(e){if(null==e)return this.features;var t=e.type;if(t==GeoBeans.Filter.Type.FilterComparsion){var r=null,a=null,n=e.expression1;null!=n&&(n.type==GeoBeans.Expression.Type.PropertyName?r=n.name:n.type==GeoBeans.Expression.Type.Literal&&(a=n.value));var s=e.expression2;null!=s&&(s.type==GeoBeans.Expression.Type.PropertyName?r=s.name:s.type==GeoBeans.Expression.Type.Literal&&(a=s.value))}if(null==r||null==a)return this.features;var i=[],l=this.featureType.getFieldIndex(r);if(l>=0)for(var u=null,o=this.features.length,h=0;o>h;++h)u=this.features[h],fvalue=u.values[l],fvalue==a&&i.push(u);return i},selectFeaturesByFilter:function(e){if(null==e)return this.features;var t=e.type,r=this.features;switch(t){case GeoBeans.Filter.Type.FilterID:r=this.selectFeaturesByIDFilter(e);break;case GeoBeans.Filter.Type.FilterComparsion:r=this.selectFeaturesByComparsion(e);break;case GeoBeans.Filter.Type.FilterLogic:break;case GeoBeans.Filter.Type.FilterSpatial:}return r},selectFeaturesByIDFilter:function(e){if(null==e)return this.features;var t=e.ids;if(null==t)return this.features;for(var r=[],a=0;a<this.features.length;++a){var n=this.features[a],s=n.fid;-1!=t.indexOf(s)&&r.push(n)}return r},selectFeaturesByComparsion:function(e){if(null==e)return this.features;var t=e.operator;if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprEqual){var r=null,a=null,n=e.expression1;null!=n&&(n.type==GeoBeans.Expression.Type.PropertyName?r=n.name:n.type==GeoBeans.Expression.Type.Literal&&(a=n.value));var s=e.expression2;if(null!=s&&(s.type==GeoBeans.Expression.Type.PropertyName?r=s.name:s.type==GeoBeans.Expression.Type.Literal&&(a=s.value)),null==r||null==a)return this.features;var i=[],l=this.featureType.getFieldIndex(r);if(l>=0)for(var u=null,o=this.features.length,h=0;o>h;++h)u=this.features[h],fvalue=u.values[l],fvalue==a&&i.push(u);return i}return this.features},selectRules:function(e){var t=[];if(null!=this.style)for(var r=this.style.rules.length,a=0;r>a;a++){var n=this.style.rules[a];if(null!=n.filter){var s=n.filter.field,i=null,l=this.featureType.getFieldIndex(s);i=e.values[l],i==n.filter.value&&t.push(n)}else t.push(n)}return t},getSymbolizer:function(e){for(var t=this.selectRules(e),r=t.length,a=0;r>a;a++){var n=t[a],s=n.symbolizer;if(!(s instanceof GeoBeans.Style.TextSymbolizer))return s}return null},setHitControl:function(e){null!=e&&"undefined"!=e&&(this.hitControl=null,this.hitControl=e)},init:function(){},enableHit:function(e){this.enableHit=e},hit:function(e,t,r){if(null!=this.features){this.map.renderer,this.map.transformation;this.selection=[];var a=0,n=null,s=null,i=this.features.length;for(a=0;i>a;a++)n=this.features[a],s=n.geometry,null!=s&&s.hit(e,t,this.map.tolerance)&&this.selection.push(n);if(this.hitRenderer.clearRect(0,0,this.hitCanvas.height,this.hitCanvas.width),this.map.drawLayersAll(),void 0!=r){var l=new GeoBeans.Geometry.Point(e,t);r(this,this.selection,l)}}},registerHitEvent:function(e){var t=this.map,r=this,a=null,n=null,s=10;this.hitCanvas=document.createElement("canvas"),this.hitCanvas.width=this.canvas.width,this.hitCanvas.height=this.canvas.height,this.hitRenderer=new GeoBeans.Renderer(this.hitCanvas),this.hitEvent=function(i){if(null==a)a=i.layerX,n=i.layerY;else{var l=Math.abs(i.layerX-a)+Math.abs(i.layerY-n);if(l>s){a=i.layerX,n=i.layerY;var u=t.transformation.toMapPoint(i.layerX,i.layerY);r.hit(u.x,u.y,e)}}},t.canvas.addEventListener("mousemove",this.hitEvent),this.events.addEvent("mousemove",this.hitEvent)},unRegisterHitEvent:function(){this.map.canvas.removeEventListener("mousemove",this.hitEvent),this.hitRenderer.clearRect(0,0,this.hitCanvas.height,this.hitCanvas.width),this.map.drawLayersAll(),this.hitEvent=null},drawHitFeature:function(e,t){for(var r=this.selectRules(e),a=r.length,n=0;a>n;n++){var s=r[n];if((null==t||"undefined"==t)&&(t=s.symbolizer),this.hitRenderer.save(),this.hitRenderer.setSymbolizer(t),t instanceof GeoBeans.Symbolizer.TextSymbolizer){var i=e.featureType.getFieldIndex(t.field);this.hitRenderer.label(e.geometry,e.values[i],t,this.map.transformation)}else this.hitRenderer.draw(e,t,this.map.transformation);this.hitRenderer.restore()}r=null,this.map.drawHitLayer()},cleanup:function(){this.enableHit=!1,this.map.canvas.removeEventListener("mousemove",this.hitEvent),this.map.canvas.removeEventListener("mousemove",this.hitTooltipEvent)},registerHitTooltipEvent:function(e){var t=this.map,r=this,a=null,n=null,s=10;this.hitTooltipEvent=function(t){if(null==a)a=t.layerX,n=t.layerY;else{var i=Math.abs(t.layerX-a)+Math.abs(t.layerY-n);i>s&&(a=t.layerX,n=t.layerY,r.hitTooltip(t.layerX,t.layerY,e))}},t.canvas.addEventListener("mousemove",this.hitTooltipEvent)},unregisterHitTooltipEvent:function(){this.map.canvas.removeEventListener("mousemove",this.hitTooltipEvent),this.hitTooltipEvent=null},hitTooltip:function(e,t,r){if(null!=this.features&&null!=r){var a=this.map,n=a.transformation.toMapPoint(e,t),s=n.x,i=n.y,l=(this.map.renderer,this.map.transformation,0),u=null,o=null,h=this.features.length;for(l=0;h>l;l++)if(u=this.features[l],o=u.geometry,null!=o&&o.hit(s,i,this.map.tolerance))return void r(this,e,t,u);r(this,e,t,null)}},getBufferTracker:function(){if(null==this.bufferTracker){var e=new GeoBeans.Control.TrackBufferControl,t=this.map.controls.find(e.type);-1==t?(this.bufferTracker=e,this.map.controls.add(this.bufferTracker)):this.bufferTracker=this.map.controls.get(t)}return this.bufferTracker},queryByBufferLine:function(e,t){var r=this.getBufferTracker();r.trackBufferLine(this,e,t,this.callbackQueryByBufferTrack)},queryByBufferCircle:function(e){var t=this.getBufferTracker();t.trackBufferCircle(this,e,this.callbackQueryByBufferTrack)},callbackQueryByBufferTrack:function(e,t,r,a){if(!(null==r||0>t)){var n=e.featureType;if(null!=n){var s=e.workspace;null!=s&&s.queryByBuffer(t,r,n,a)}}},drawBufferFeatures:function(e,t){this.bufferFeatures=e,this.bufferSymbolizer=t,this.drawBufferFeaturesCanvas(),this.map.drawLayersAll()},clearBufferFeatures:function(){this.bufferFeatures=null,this.drawBufferFeaturesCanvas(),this.map.drawLayersAll()},drawBufferFeaturesCanvas:function(){if(null==this.bufferCanvas&&(this.bufferCanvas=document.createElement("canvas"),this.bufferCanvas.width=this.canvas.width,this.bufferCanvas.height=this.canvas.height,this.bufferRenderer=new GeoBeans.Renderer(this.bufferCanvas)),this.bufferRenderer.clearRect(0,0,this.bufferCanvas.width,this.bufferCanvas.height),null!=this.bufferFeatures&&0!=this.bufferFeatures.length){this.bufferRenderer.save(),this.bufferRenderer.setSymbolizer(this.bufferSymbolizer);for(var e=0,t=this.bufferFeatures.length;t>e;e++)feature=this.bufferFeatures[e],null!=this.bufferSymbolizer&&"undefined"!=this.bufferSymbolizer&&this.bufferRenderer.draw(feature,this.bufferSymbolizer,this.map.transformation);this.bufferRenderer.restore()}},beginTransaction:function(e){var t=this.featureType.getFieldIndex(this.featureType.geomFieldName),r=this.featureType.fields[t],a=r.geomType,n=this.getTransactionTracker();switch(a){case GeoBeans.Geometry.Type.POINT:n.trackPoint(this.transactionCallback,e,this);break;case GeoBeans.Geometry.Type.LINESTRING:n.trackLine(this.transactionCallback,e,this,!1);break;case GeoBeans.Geometry.Type.MULTILINESTRING:n.trackLine(this.transactionCallback,e,this,!0);break;case GeoBeans.Geometry.Type.POLYGON:n.trackPolygon(this.transactionCallback,e,this,!1);break;case GeoBeans.Geometry.Type.MULTIPOLYGON:n.trackPolygon(this.transactionCallback,e,this,!0)}},transactionCallback:function(e,t,r){t(e,r)},transaction:function(e,t,r){this.workspace.transaction(this.featureType,e,t,r)},getTransactionTracker:function(){var e=null,t=this.map.controls.find(GeoBeans.Control.Type.TRACKTRANSACTION);return-1==t?(e=new GeoBeans.Control.TrackControl.TrackTransactionControl,this.map.controls.add(e)):e=this.map.controls.get(t),e},CLASS_NAME:"GeoBeans.Layer.FeatureLayer"});
GeoBeans.Layer.ChartLayer=GeoBeans.Class(GeoBeans.Layer.FeatureLayer,{baseLayerName:null,baseLayerField:null,dbName:null,tableName:null,tableField:null,chartFields:null,chartFeatureType:null,type:null,chartFeatures:null,initialize:function(e,t,a,i,l,r,n){GeoBeans.Layer.FeatureLayer.prototype.initialize.apply(this,arguments),this.baseLayerName=t,this.baseLayerField=a,this.dbName=i,this.tableName=l,this.tableField=r,this.chartFields=n},cleanup:function(){this.removeLegend(),this.name=null,this.baseLayerName=null,this.baseLayerField=null,this.dbName=null,this.tableName=null,this.tableField=null,this.chartFields=null},setFeatureType:function(e){this.featureType=e},setFeatures:function(e){this.features=e},setMap:function(e){GeoBeans.Layer.prototype.setMap.apply(this,arguments);var t=this.getChartFeatures();null!=t&&(this.chartFeatures=t);var a=this.getBaseLayerExtent();null!=a&&(this.extent=a)},getBaseLayerExtent:function(){var e=this.map.getLayer(this.baseLayerName);if(null!=e){var t=e.getExtent();return t}return null},getChartFeatures:function(){if(null==this.baseLayerName||null==this.baseLayerField||null==this.dbName||null==this.tableName||null==this.tableField)return null;var e=this.map.getLayer(this.baseLayerName);if(null==e)return null;var t=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0"),a=new GeoBeans.FeatureType(t,this.tableName);this.chartFeatureType=a;var i=(a.getFields(null,this.dbName),a.getFeaturesFilter(null,this.dbName,null,null,null,[this.tableField].concat(this.chartFields))),l=a.getFieldIndex(this.tableField);if(-1==l)return null;var r=e.featureType,n=r.geomFieldName,s=null;s=this.type==GeoBeans.Layer.ChartLayer.Type.BAR||this.type==GeoBeans.Layer.ChartLayer.Type.PIE?[this.baseLayerField,n]:[this.baseLayerField];var u=r.getFeaturesFilter(this.map.name,null,null,null,null,s),h=(e.getFields(),r.getFieldIndex(this.baseLayerField));if(-1==h)return null;var d=this.getValidChartFeatures(i,l,u,h);return d},getValidChartFeatures:function(e,t,a,i){if(null==e||null==t||null==a||null==i)return null;for(var l=[],r=0;r<e.length;++r){var n=e[r];if(null!=n){var s=n.values;if(null!=s){var u=s[t];if(null!=u)for(var h=0;h<a.length;++h){var d=a[h];if(null!=d){var F=d.values;if(null!=F){var o=F[i];if(null!=o&&o==u){n.geometry=d.geometry,n.gid=d.fid,l.push(n);break}}}}}}}return l},setBaseLayer:function(e){this.baseLayerName=e,this.chartFeatures=this.getChartFeatures()},getBaseLayer:function(){return this.baseLayerName},setBaseLayerField:function(e){this.baseLayerField=e,this.chartFeatures=this.getChartFeatures()},getBaseLayerField:function(){return this.baseLayerField},setDbName:function(e){this.dbName=e,this.chartFeatures=this.getChartFeatures()},getDbName:function(){return this.dbName},setTableName:function(e){this.tableName=e,this.chartFeatures=this.getChartFeatures()},getTableName:function(){return this.tableName},setTableField:function(e){this.tableField=e,this.chartFeatures=this.getChartFeatures()},getTableField:function(){return this.tableField},setChartFields:function(e){this.chartFields=e,this.chartFeatures=this.getChartFeatures()},getChartFields:function(){return this.chartFields},setChartOption:function(e){this.chartOption=e},getChartOption:function(){return this.chartOption},addLegend:function(){},showLegend:function(){this.map.mapDiv.find(".chart-legend#"+this.name).css("display","block")},hideLegend:function(){this.map.mapDiv.find(".chart-legend#"+this.name).css("display","none")},removeLegend:function(){this.map.mapDiv.find(".chart-legend#"+this.name).remove()},setName:function(e){this.name=e}}),GeoBeans.Layer.ChartLayer.Type={RANGE:"range",BAR:"bar",PIE:"pie",AQI:"aqi",AQITIMELINE:"aqi_timeline"};
GeoBeans.Layer.GroupLayer=GeoBeans.Class(GeoBeans.Layer,{layers:null,server:null,image:null,format:"image/png",version:"1.1.0",srs:"EPSG:4326",transparent:"true",updateFlag:!1,initialize:function(e,a,s){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.server=e,this.name=a,this.layers=[],void 0!=s&&(this.format=s),this.image=new Image},addLayer:function(e){null!=e&&this.layers.push(e)},insertLayer:function(e){null!=e&&this.layers.unshift(e)},removeLayer:function(e){for(var a=null,s=0;s<this.layers.length;++s)if(a=this.layers[s],a==e)return this.layers.splice(s,1),void e.cleanup()},getLayers:function(){return this.layers},loadTotal:function(){if(null==this.map)return void(this.flag=GeoBeans.Layer.Flag.LOADED);for(var e,a=this.map.canvas.width,s=this.map.canvas.height,r=this.map.viewer,i=r.xmin.toFixed(6)+","+r.ymin.toFixed(6)+","+r.xmax.toFixed(6)+","+r.ymax.toFixed(6),t="",l="",n=0;n<this.layers.length;++n){var h=this.layers[n],o=h.name,g=h.styleName,h=this.layers[n];if(null!=o&&h.visible&&!h.drawLocal){null!=g&&(t+=g),l+=o,n<this.layers.length-1&&(t+=",",l+=",");var u=h.heatMapLayer;null!=u&&u.visible&&u.load()}}if(e=this.server+"?service=WMS&version="+this.version+"&request=GetMap&layers="+l+"&styles="+t+"&bbox="+i+"&width="+a+"&height="+s+"&srs="+this.srs+"&format="+this.format+"&transparent="+this.transparent+"&mapName="+this.map.name,this.renderer.clearRect(0,0,a,s),""==l)return void(this.flag=GeoBeans.Layer.Flag.LOADED);if(this.image.src==e&&this.flag==GeoBeans.Layer.Flag.ERROR)return void console.log("ERROR");if(this.updateFlag){var y=new Date;this.image.src=e+"&t="+y.getTime(),this.updateFlag=!1}else this.image.src=e;if(this.image.complete){this.updateFlag=!1,this.flag=GeoBeans.Layer.Flag.LOADED,this.renderer.drawImage(this.image,0,0,a,s);var f=this.image.src.lastIndexOf("&t=");-1!=f&&(this.image.src=this.image.src.slice(0,f))}else{var m=this;m.flag=GeoBeans.Layer.Flag.READY,this.image.onload=function(){m.flag!=GeoBeans.Layer.Flag.LOADED&&(m.flag=GeoBeans.Layer.Flag.LOADED,m.renderer.drawImage(m.image,0,0,a,s),m.map.drawLayersAll())},this.image.onerror=function(){m.flag=GeoBeans.Layer.Flag.ERROR,m.map.drawLayersAll()}}},load:function(){this.flag=GeoBeans.Layer.Flag.READY;for(var e=null,a=0;a<this.layers.length;++a)e=this.layers[a],null!=e&&e.visible&&e.load();for(var s=null,a=0;a<this.layers.length;++a)if(e=this.layers[a],null!=e&&e.visible&&(s=e.flag,s==GeoBeans.Layer.Flag.READY))return;var r=null;this.renderer.clearRect(0,0,this.canvas.width,this.canvas.height);for(var a=this.layers.length-1;a>=0;--a)e=this.layers[a],null!=e&&e.visible&&(r=e.canvas,null!=r&&e.flag==GeoBeans.Layer.Flag.LOADED&&this.renderer.drawImage(r,0,0,r.width,r.height));this.flag=GeoBeans.Layer.Flag.LOADED},update:function(){this.updateFlag=!0},hasLayer:function(e){if(null==e)return!1;for(var a=null,s=0;s<this.layers.length;++s)if(a=this.layers[s],null!=a&&a.name==e)return!0;return!1}});
GeoBeans.Layer.HeatMapLayer=GeoBeans.Class(GeoBeans.Layer,{name:null,container:null,data:null,layer:null,field:null,uniqueValue:null,heatmapInstance:null,div:null,initialize:function(e){this.name=e},setMap:function(e){if(null!=e){this.map=e,this.div=document.createElement("div"),this.div.className="heatmap";var a=e.canvas,t=a.height,n=a.width;this.div.style.cssText="height:"+t+"px;width:"+n+"px;",this.heatmapInstance=h337.create({container:this.div})}},destory:function(){this.name=null,this.layer=null,this.field=null,this.heatmapInstance=null},setLayer:function(e,a,t){null!=e&&(null!=a||null!=t)&&(this.layer=e,this.field=a,this.uniqueValue=t)},getField:function(){return this.field},getUniqueValue:function(){return this.uniqueValue},load:function(){var e=this.layer.featureType;if(null==e)return void(this.flag=GeoBeans.Layer.Flag.LOADED);var a=e.getFieldIndex(this.field);if(0>a&&null==this.uniqueValue)return void(this.flag=GeoBeans.Layer.Flag.LOADED);var t,n,l=null,i=null,u=[],s=null,r=this.layer.map.transformation,h=this.map.getViewer();if(null==h)return void(this.flag=GeoBeans.Layer.Flag.LOADED);var o=this.layer.getFeatureBBoxGet(h);if(null==o)return void(this.flag=GeoBeans.Layer.Flag.LOADED);for(var d=0;d<o.length;++d){var f=o[d],c=f.geometry;c instanceof GeoBeans.Geometry.Point&&(s=r.toScreenPoint(c.x,c.y)),0>a&&null!=this.uniqueValue?(t=this.uniqueValue,i=t,l=t):a>=0&&(t=f.values[a],0==d&&(l=t,i=t),l=Math.max(t,l),i=Math.min(t,i)),n={x:s.x,y:s.y,value:t},u.push(n)}var v={max:l,min:i,data:u};this.heatmapInstance.setData(v),this.canvas=this.div.children[0],this.flag=GeoBeans.Layer.Flag.LOADED}});
GeoBeans.Layer.MapLayer=GeoBeans.Class(GeoBeans.Layer,{style_name:null,style:null,geomType:null,fields:null,initialize:function(e){GeoBeans.Layer.prototype.initialize.apply(this,arguments)},destory:function(){this.style_name=null,GeoBeans.Layer.prototype.destory.apply(this,arguments)},draw:function(){},setStyle:function(e){}});
GeoBeans.Layer.OverlayLayer=GeoBeans.Class(GeoBeans.Layer.FeatureLayer,{overlays:null,hitOverlay:null,hitOverlayCallback:null,editCanvas:null,editRenderer:null,editEvent:null,editOverlay:null,initialize:function(e){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.overlays=[]},addOverlay:function(e){null!=e&&(e.setLayer(this),this.overlays.push(e))},addOverlays:function(e){for(var t=0;t<e.length;++t){var a=e[t];this.addOverlay(a)}},removeOverlay:function(e){for(var t=this.overlays.length,a=t-1;a>=0;a--){this.overlays[a];a==e&&this.overlays.splice(a,1)}},removeOverlays:function(e){for(var t=0;t<e.length;++t){var a=e[t];this.overlays.splice(a,1)}},clearOverlays:function(){for(var e=this.overlays.length;e>0;)this.overlays.splice(e-1,1),e=this.overlays.length;null!=this.editRenderer&&this.editRenderer.clearRect(),null!=this.hitRenderer&&this.hitRenderer.clearRect()},load:function(){this.renderer.clearRect(),null!=this.hitRenderer&&this.hitRenderer.clearRect(),null!=this.editRenderer&&this.editRenderer.clearRect();for(var e=0;e<this.overlays.length;++e){var t=this.overlays[e];t.draw()}},draw:function(){var e=this.getLoadFlag();e==GeoBeans.Layer.Flag.LOADED&&this.map.drawLayersAll()},getLoadFlag:function(){for(var e=0;e<this.overlays.length;++e){var t=this.overlays[e],a=t.loadFlag;if(a!=GeoBeans.Overlay.Flag.LOADED)return GeoBeans.Layer.Flag.READY}return GeoBeans.Layer.Flag.LOADED},setHitOverlayCallback:function(e){this.hitOverlayCallback=e},onOverlayHit:function(e,t){var a=t.length;if(a>=1){var i=t[a-1];if(i.isEdit)return e.hitRenderer.clearRect(),void e.map.drawLayersAll();var r=e.getHitOverlaySymbolizer(i);e.drawHitOverlay(i,r),null!=e.hitOverlay&&(e.hitOverlay.isHit=!1),e.hitOverlay=i,i.isHit=!0,null!=e.hitOverlayCallback&&e.hitOverlayCallback(i)}else null!=e.editOverlay&&(e.editOverlay.isHit=!1),null!=e.hitOverlayCallback&&e.hitOverlayCallback(null),null!=e.hitOverlay&&(e.hitOverlay.isHit=!1)},getHitOverlaySymbolizer:function(e){var t=e.type,a=null;switch(t){case GeoBeans.Overlay.Type.MARKER:a=new GeoBeans.Symbolizer.PointSymbolizer,a.icon_url="../images/marker-hit.png",a.icon_offset_x=0,a.icon_offset_y=0;break;case GeoBeans.Overlay.Type.PLOYLINE:a=new GeoBeans.Symbolizer.LineSymbolizer,a.stroke.color.set(255,0,0,1),a.stroke.width=4;break;case GeoBeans.Overlay.Type.POLYGON:a=new GeoBeans.Symbolizer.PolygonSymbolizer,a.fill.color.set(255,255,255,1),a.stroke.color.set(255,0,0,1)}return a},drawHitOverlay:function(e,t){this.hitRenderer.clearRect(),this.hitRenderer.setSymbolizer(t);var a=this.hitRenderer.drawOverlay(e,t,this.map.transformation);a&&this.map.renderer.drawImage(this.hitCanvas,0,0,this.hitCanvas.width,this.hitCanvas.height)},registerHitEvent:function(){this.hitCanvas=document.createElement("canvas"),this.hitCanvas.width=this.canvas.width,this.hitCanvas.height=this.canvas.height,this.hitRenderer=new GeoBeans.Renderer(this.hitCanvas);var e=this,t=null,a=null,i=10,r=e.map;this.hitEvent=function(l){if(null==t)t=l.layerX,a=l.layerY;else{var n=Math.abs(l.layerX-t)+Math.abs(l.layerY-a);if(n>i){t=l.layerX,a=l.layerY;var s=r.transformation.toMapPoint(l.layerX,l.layerY);e.hit(s.x,s.y)}}},r.canvas.addEventListener("mousemove",this.hitEvent),this.registerEditEvent()},unregisterHitEvent:function(){var e=this.map;e.canvas.removeEventListener("mousemove",this.hitEvent),this.unregisterEditEvent(),this.editOverlay=null,this.editRenderer.clearRect(),this.hitRenderer.clearRect(),this.map.drawLayersAll()},hit:function(e,t){if(null!=this.overlays){this.map.renderer,this.map.transformation;this.selection=[];var a=0,i=null,r=null,l=this.overlays.length;for(a=0;l>a;a++)i=this.overlays[a],r=i.geometry,null!=r&&r.hit(e,t,this.map.tolerance)&&this.selection.push(i);this.hitRenderer.clearRect(),this.map.drawLayersAll(),void 0!=this.onOverlayHit&&this.onOverlayHit(this,this.selection)}},registerEditEvent:function(){null==this.editCanvas&&(this.editCanvas=document.createElement("canvas"),this.editCanvas.width=this.canvas.width,this.editCanvas.height=this.canvas.height,this.editRenderer=new GeoBeans.Renderer(this.editCanvas));var e=this.map,t=this;this.editEvent=function(a){var i=t.hitOverlay;if(null!=i){null!=t.editOverlay&&(t.editOverlay.isEdit=!1);var r=e.transformation.toMapPoint(a.layerX,a.layerY),l=i.geometry;if(l.hit(r.x,r.y,e.tolerance)){t.editOverlay=i;var n=t.getEditOverlaySymbolizer(i);t.drawEditOverlay(i,n),i.isEdit=!0,null!=t.hitOverlayCallback&&t.hitOverlayCallback(i)}}},this.map.canvas.addEventListener("click",this.editEvent)},unregisterEditEvent:function(){this.map.canvas.removeEventListener("click",this.editEvent)},getEditOverlaySymbolizer:function(e){var t=e.type,a=null;switch(t){case GeoBeans.Overlay.Type.MARKER:a=new GeoBeans.Symbolizer.PointSymbolizer,a.icon_url="../images/marker-edit.png",a.icon_offset_x=0,a.icon_offset_y=0;break;case GeoBeans.Overlay.Type.PLOYLINE:a=new GeoBeans.Symbolizer.LineSymbolizer,a.stroke.color.set(255,0,0,1),a.stroke.width=6;break;case GeoBeans.Overlay.Type.POLYGON:a=new GeoBeans.Symbolizer.PolygonSymbolizer,a.fill.color.set(255,0,0,1),a.stroke.color.set(255,0,0,1),a.stroke.width=8}return a},drawEditOverlay:function(e,t){this.editRenderer.clearRect(),this.editRenderer.setSymbolizer(t);var a=this.editRenderer.drawOverlay(e,t,this.map.transformation);a&&this.map.renderer.drawImage(this.editCanvas,0,0,this.editCanvas.width,this.editCanvas.height)},getOverlayIndex:function(e){if(null==e)return-1;for(var t=0;t<this.overlays.length;++t)if(e==this.overlays[t])return t;return-1},removeOverlayObj:function(e){var t=this.getOverlayIndex(e);this.removeOverlay(t)}});
GeoBeans.Layer.PanoramaLayer=GeoBeans.Class(GeoBeans.Layer.FeatureLayer,{overlays:null,initialize:function(e){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.overlays=[]},addMarker:function(e,a,t,i){if(null!=e&&null!=a&&null!=t){null==i&&(i="images/360.png");var n=new GeoBeans.Symbolizer.PointSymbolizer;n.icon_url=i,n.icon_offset_x=0,n.icon_offset_y=0;var l=new GeoBeans.Overlay.Marker(a,e,n);l.setLayer(this),l.htmlPath=t,this.overlays.push(l),null==this.clickEvent&&this.registerClickEvent()}},removeMarker:function(e){for(var a=null,t=0;t<this.overlays.length;++t)a=this.overlays[t],a.name==e&&this.overlays.splice(t,1);0==this.overlays.length&&this.unRegisterClickEvent(),this.map.infoWindow.attr("data-original-title")==e&&this.map.closeInfoWindow()},clearMarkers:function(){for(var e=this.overlays.length;e>0;)this.overlays.splice(e-1,1),e=this.overlays.length;this.renderer.clearRect(),this.unRegisterClickEvent(),this.map.closeInfoWindow()},load:function(){this.renderer.clearRect();for(var e=0;e<this.overlays.length;++e){var a=this.overlays[e];a.draw()}},draw:function(){var e=this.getLoadFlag();e==GeoBeans.Layer.Flag.LOADED&&this.map.drawLayersAll()},getLoadFlag:function(){for(var e=0;e<this.overlays.length;++e){var a=this.overlays[e],t=a.loadFlag;if(t!=GeoBeans.Overlay.Flag.LOADED)return GeoBeans.Layer.Flag.READY}return GeoBeans.Layer.Flag.LOADED},registerClickEvent:function(){var e=this.map,a=this;this.clickEvent=function(t){var i=e.transformation.toMapPoint(t.layerX,t.layerY);a.hit(i.x,i.y,a.hitOverlayCallback)},e.canvas.addEventListener("click",this.clickEvent)},unRegisterClickEvent:function(){var e=this.map;e.canvas.removeEventListener("click",this.clickEvent),this.clickEvent=null},hit:function(e,a,t){var i=[],n=0,l=null,r=null,s=this.overlays.length;for(n=0;s>n;n++)l=this.overlays[n],r=l.geometry,null!=r&&r.hit(e,a,this.map.tolerance)&&i.push(l);t(this,i)},hitOverlayCallback:function(e,a){if(null!=a&&0!=a.length){var t=a[0];if(null!=t){var i={title:t.name},n=t.htmlPath,l=t.geometry;if(null!=n&&null!=l){var r="<div style='width:400px;height:300px;'><iframe src='"+n+"' style='width:100%;height:100%' frameborder='no'></iframe></div>",s=new GeoBeans.InfoWindow(r,i);mapObj.openInfoWindow(s,l)}}}}});
GeoBeans.Layer.FeatureLayer.QueryLayer=GeoBeans.Class(GeoBeans.Layer.FeatureLayer,{layer:null,blinkFeature:null,blinkFeatureIndex:-1,timer:null,initialize:function(e){GeoBeans.Layer.prototype.initialize.apply(this,arguments)},setLayer:function(e){null!=e&&(this.layer=e,this.style=this.getStyle(e.geomType))},setFeatures:function(e){this.features=e,this.blinkFeatureIndex=null,this.blinkFeature=null,clearInterval(this.timer)},clearFeatures:function(){this.features=null,this.layer=null,this.style=null,this.blinkFeatureIndex=null,this.blinkFeature=null,this.map.drawLayersAll()},load:function(){if(this.flag=GeoBeans.Layer.Flag.LOADED,this.renderer.clearRect(),null!=this.style&&null!=this.features&&null!=this.layer){var e=this.style.rules;if(null!=e&&0!=e.length)for(var l=0;l<e.length;++l){var t=e[l],r=this.selectFeatures(t.filter);null!=t.symbolizer&&(null!=t.symbolizer.icon_url?this.renderer.drawIcons(r,t.symbolizer,this.map.transformation):this.drawFeatures(r,t.symbolizer)),null!=t.textSymbolizer&&this.labelFeatures(r,t.textSymbolizer)}}},getStyle:function(e){if(null==e)return null;e=e.toUpperCase();var l=null;switch(e){case"POINT":case"MULTIPOINT":l=new GeoBeans.Style.FeatureStyle("query",GeoBeans.Style.FeatureStyle.GeomType.Point);var t=new GeoBeans.Rule,r=new GeoBeans.Symbolizer.PointSymbolizer;r.fill.color.set(255,0,0,1),r.stroke.color.set(252,240,244,.9),t.symbolizer=r,l.addRule(t);break;case"LINESTRING":case"MULTILINESTRING":l=new GeoBeans.Style.FeatureStyle("default",GeoBeans.Style.FeatureStyle.GeomType.LineString);var t=new GeoBeans.Rule,r=new GeoBeans.Symbolizer.LineSymbolizer;r.stroke.color.set(255,0,0,1),r.stroke.width=4,t.symbolizer=r,l.addRule(t);break;case"POLYGON":case"MULTIPOLYGON":l=new GeoBeans.Style.FeatureStyle("default",GeoBeans.Style.FeatureStyle.GeomType.Polygon);var t=new GeoBeans.Rule,r=new GeoBeans.Symbolizer.PolygonSymbolizer;r.fill.color.set(255,0,0,1),r.stroke.color.set(252,240,244,.9),t.symbolizer=r,l.addRule(t)}return l},setFeatureBlink:function(e,l){if(null!=e&&null!=l){null!=this.blinkFeature&&(clearInterval(this.timer),-1==this.features.indexOf(this.blinkFeature)&&(this.features.splice(this.blinkFeatureIndex,0,this.blinkFeature),this.map.drawLayersAll())),this.blinkFeature=e;var t=this,r=this.features.indexOf(e);if(this.blinkFeatureIndex=r,-1!=r){var a=!1,s=setInterval(function(){return 0==l||null==t.features?void clearInterval(s):void(a?(t.features.splice(r,0,e),t.map.drawLayersAll(),a=!1,l--):(t.features.splice(r,1),t.map.drawLayersAll(),a=!0))},500);this.timer=s}}}});
GeoBeans.Layer.RasterDBLayer=GeoBeans.Class(GeoBeans.Layer.DBLayer,{rasterPath:null,type:null,initialize:function(e,a,t,r,s,i,y){GeoBeans.Layer.DBLayer.prototype.initialize.apply(this,arguments),void 0!=y&&(this.rasterPath=y),this.type=GeoBeans.Layer.DBLayer.Type.Raster}});
GeoBeans.TileState={LOADED:1,LOADING:2},GeoBeans.Tile=GeoBeans.Class({map:null,image:null,url:null,row:null,col:null,level:null,layer:null,state:null,initialize:function(e,i,l,t,a,s){this.map=e,this.url=i,this.row=t,this.col=a,this.level=s,this.layer=l},loading:function(e,i,l,t){if(null==this.image&&(this.image=new Image,this.image.src=this.url),this.image.complete&&0!=this.image.height&&0!=this.width)return this.state=GeoBeans.TileState.LOADED,void i(this,e,l,t);var a=this;this.image.onload=function(){a.layer.flag!=GeoBeans.Layer.Flag.LOADED&&(a.state=GeoBeans.TileState.LOADED,i(a,e,l,t))}},draw:function(e,i,l,l){this.map.level==this.level&&this.layer.renderer.drawImage(this.image,e,i,l,l)}});
GeoBeans.TileCache=GeoBeans.Class({cache:null,initialize:function(){this.cache=[]},destory:function(){this.cache=null},putTile:function(e){var i=e.url,n=this.getTile(i);return null!=n?!1:void this.cache.push(e)},getTile:function(e){for(var i=null,n=this.cache.length,l=0;n>l;l++)if(i=this.cache[l],i.url==e)return i;return null}});
GeoBeans.TileLayerState={LOADING:0,LOADED:1,ERROR:2},GeoBeans.Layer.TileLayer=GeoBeans.Class(GeoBeans.Layer,{IMG_WIDTH:null,IMG_HEIGHT:null,MIN_ZOOM_LEVEL:null,MAX_ZOOM_LEVEL:null,RESOLUTIONS:null,server:null,scale:null,cache:null,state:null,tiles:null,initialize:function(e,t){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.url=t,this.cache=new GeoBeans.TileCache,this.tiles=[]},destory:function(){this.server=null,this.scale=null,this.cache=null,GeoBeans.Layer.prototype.destroy.apply(this,arguments)},setName:function(){this.name=name},getValidView:function(){var e=this.map.viewer,t=Math.max(e.xmin,this.FULL_EXTENT.xmin),l=Math.max(e.ymin,this.FULL_EXTENT.ymin),n=Math.min(e.xmax,this.FULL_EXTENT.xmax),i=Math.min(e.ymax,this.FULL_EXTENT.ymax);return new GeoBeans.Envelope(t,l,n,i)},updateScale:function(){this.map,this.FULL_EXTENT},draw:null,drawCache:null,preDraw:null,loadingTiles:null,getTileID:null,computeTileBound:null,getResolution:function(e){return 0>=e||e>=this.RESOLUTIONS.length?-1:this.RESOLUTIONS[e-1]},getLevel:function(e){for(var t=0;t<this.RESOLUTIONS.length;++t){var l=this.RESOLUTIONS[t];if(e>=l)return t}},init:function(){var e=this.map;this.level=this.map.level,this.resolution=this.getResolution(this.level),e.setResolution(this.resolution),e.updateMapExtent()}});
GeoBeans.Layer.WFSLayer=GeoBeans.Class(GeoBeans.Layer.FeatureLayer,{style:null,server:null,url:null,typeName:null,format:"GML2",version:"1.0.0",srs:"EPSG:4326",features:null,maxFeatures:50,filter:null,workspace:null,viewer:null,initialize:function(e,a,t,r){GeoBeans.Layer.FeatureLayer.prototype.initialize.apply(this,arguments),this.name=e,this.server=a,this.typeName=t,this.format=r,this.image=new Image,this.workspace=new GeoBeans.WFSWorkspace(this.name,this.server,this.version)},destory:function(){this.server=null,this.name=null,this.server=null,this.typeName=null,this.format=null,this.featureType=null,this.workspace=null,GeoBeans.Layer.FeatureLayer.prototype.destory.apply(this,arguments)},load:function(){var e=this.map.viewer;if(null!=e&&null!=this.viewer&&e.equal(this.viewer)&&null!=this.features)return this.flag=GeoBeans.Layer.Flag.LOADED,this.drawLayerSnap(),this.renderer.clearRect(),this.drawLayer(),void this.drawBufferFeaturesCanvas();if(this.viewer=new GeoBeans.Envelope(e.xmin,e.ymin,e.xmax,e.ymax),null==this.featureType&&(this.featureType=this.workspace.getFeatureType(this.typeName)),null!=this.featureType){var a=this;a.flag=GeoBeans.Layer.Flag.READY,this.featureType.getFeaturesBBox(function(e,t){a.setTransformation(a.map.transformation),a.features=t,a.drawLayerSnap(),a.renderer.clearRect(),a.drawLayer(),a.drawBufferFeaturesCanvas(),a.map.drawLayersAll(),a.flag=GeoBeans.Layer.Flag.LOADED},this.viewer,this.filter)}},draw:function(){if(null!=this.features)return this.drawLayerSnap(),this.renderer.clearRect(),this.drawLayer(),void this.map.renderer.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height);if(null==this.featureType&&(this.featureType=this.workspace.getFeatureType(this.typeName)),null!=this.featureType){var e=this;this.featureType.getFeatures(function(a,t){e.setTransformation(e.map.transformation),e.features=t,e.drawLayerSnap(),e.renderer.clearRect(),e.drawLayer(),e.map.renderer.drawImage(e.canvas,0,0,e.canvas.width,e.canvas.height)})}},setFilter:function(e){this.filter=e,this.features=null},getFeatureType:function(){return null==this.featureType&&(this.featureType=this.workspace.getFeatureType(this.typeName)),null!=this.featureType?this.featureType:void 0},CLASS_NAME:"GeoBeans.Layer.WFSLayer"});
GeoBeans.Layer.WMSLayer=GeoBeans.Class(GeoBeans.Layer,{server:null,url:null,image:null,layers:[],mapLayers:[],styles:[],format:"image/png",version:"1.1.0",srs:"EPSG:4326",transparent:"true",workspace:null,updateFlag:!1,initialize:function(e,s,t,a,r){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.workspace=new GeoBeans.WMSWorkspace(e,s,"1.3.0"),this.name=e,this.server=s,this.layers=t,this.mapLayers=[];for(var i=0;i<this.layers.length;++i){var n=this.layers[i],l=this.workspace.getMapLayer(n);this.mapLayers.push(l)}void 0!=a&&(this.styles=a),void 0!=r&&(this.format=r),this.image=new Image;var h=this.workspace.extent;this.extent=h},destory:function(){this.server=null,this.name=null,this.server=null,this.layers=null,this.styles=null,this.format=null,this.image=null,this.mapLayers=null,GeoBeans.Layer.prototype.destory.apply(this,arguments)},load:function(){for(var e,s=this.map.canvas.width,t=this.map.canvas.height,a=this.map.viewer,r=a.xmin+","+a.ymin+","+a.xmax+","+a.ymax,i="",n="",l=0;l<this.mapLayers.length;++l){var h=this.mapLayers[l],o=h.name,m=h.style_name;null!=m&&h.visible&&(i+=m,n+=o),l<this.mapLayers.length-1&&(""!=i&&","!=i.substr(i.length-1,1)&&(i+=","),""!=n&&","!=n.substr(n.length-1,1)&&(n+=","))}if(","==i.substr(i.length-1,1)&&(i=i.substr(0,i.length-1)),","==n.substr(n.length-1,1)&&(n=n.substr(0,n.length-1)),e=this.server+"service=WMS&version="+this.version+"&request=GetMap&layers="+n+"&styles="+i+"&bbox="+r+"&width="+s+"&height="+t+"&srs="+this.srs+"&format="+this.format+"&transparent="+this.transparent,this.renderer.clearRect(0,0,s,t),""==n)return void(this.flag=GeoBeans.Layer.Flag.LOADED);if(this.updateFlag){var p=new Date;this.image.src=e+"&t="+p.getTime(),this.updateFlag=!1}else this.image.src=e;if(this.image.complete){this.updateFlag=!1,this.flag=GeoBeans.Layer.Flag.LOADED,this.renderer.drawImage(this.image,0,0,s,t);var y=this.image.src.lastIndexOf("&t=");-1!=y&&(this.image.src=this.image.src.slice(0,y))}else{var g=this;g.flag=GeoBeans.Layer.Flag.READY,this.image.onload=function(){g.flag!=GeoBeans.Layer.Flag.LOADED&&(g.flag=GeoBeans.Layer.Flag.LOADED,g.renderer.drawImage(g.image,0,0,s,t),g.map.drawLayersAll())}}},draw:function(){var e,s=this.map.canvas.width,t=this.map.canvas.height,a=this.map.viewer,r=a.xmin+","+a.ymin+","+a.xmax+","+a.ymax;e=this.server+"&service=WMS&version="+this.version+"&request=GetMap&layers="+this.layers+"&styles="+this.styles+"&bbox="+r+"&width="+s+"&height="+t+"&srs="+this.srs+"&format="+this.format+"&transparent="+this.transparent,this.image.src=e;var i=this.map.renderer;if(this.image.complete)i.drawImage(this.image,0,0,s,t);else{var n=this;this.image.onload=function(){i.drawImage(n.image,0,0,s,t)}}},getMapLayer:function(e){for(var s,t,a=0;a<this.mapLayers.length;++a)if(s=this.mapLayers[a],t=s.name,t==e)return s;return null},update:function(){this.updateFlag=!0},setMapLayerStyle:function(e,s,t){if(null!=e&&null!=s){var a=this,r=e.name,i="service=wms&version=1.0.0&request=SetStyle&&layer="+r+"&style="+s;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!1,beforeSend:function(e){},success:function(r,i){var n=a.parseSetMapLayerStyle(r);"success"==n&&(e.style_name=s),void 0!=t&&t(n)},complete:function(e,s){},error:function(){}})}},parseSetMapLayerStyle:function(e){var s="",t=$(e).find("SetStyle").text();return"SUCCESS"==t.toUpperCase()?s="success":""!=$(e).find("ExceptionText").text()&&(s=$(e).find("ExceptionText").text()),s}});
GeoBeans.Layer.AQIChartLayer=GeoBeans.Class(GeoBeans.Layer.ChartLayer,{chartField:null,labelField:null,timeField:null,timePoint:null,styleMgr:null,featuresAll:null,tipInfos:null,flagField:null,changeLegend:!0,colorMap:null,initialize:function(e,t,a,n,i,l,s,r,o){this.name=e,this.dbName=t,this.tableName=a,this.chartField=n,this.labelField=i,this.flagField=l,this.timeField=s,this.timePoint=r,this.chartOption=o,this.type=GeoBeans.Layer.ChartLayer.Type.AQI},setChartOption:function(e){this.chartOption=e,this.features=null,this.changeLegend=!0;var t=this.chartOption.colorMapID,a=this.styleMgr.getColorMapByID(t);this.colorMap=a},getChartField:function(){return this.chartField},setChartField:function(e){this.chartField=e,this.features=null,this.changeLegend=!0},getFlagField:function(){return this.flagField},getTimeField:function(){return this.timeField},getTimePoint:function(){return this.timePoint},setTimePoint:function(e){this.timePoint=e,this.features=null},getLableField:function(){return this.labelField},setMap:function(e){GeoBeans.Layer.prototype.setMap.apply(this,arguments);var t=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0"),a=new GeoBeans.FeatureType(t,this.tableName);this.featureType=a;var n=(a.getFields(null,this.dbName),this.map.server.slice(0,this.map.server.lastIndexOf("/mgr")));this.styleMgr=new GeoBeans.StyleManager(n);var i=this.chartOption.colorMapID,l=this.styleMgr.getColorMapByID(i);this.colorMap=l},load:function(){var e=this.map.viewer;if(null==this.minMaxValue){var t=this.getMinMaxValue();if(null==t)return;this.minMaxValue=t}return this.drawLegend(),null!=e&&null!=this.viewer&&e.equal(this.viewer)&&null!=this.features?(this.flag=GeoBeans.Layer.Flag.LOADED,void this.drawLegend()):(this.viewer=new GeoBeans.Envelope(e.xmin,e.ymin,e.xmax,e.ymax),this.getFeatures(),void(this.flag=GeoBeans.Layer.Flag.READY))},drawLegend:function(){return this.changeLegend&&(this.removeLegend(),this.addLegend(),this.changeLegend=!1),this.visible?void this.showLegend():void this.hideLegend()},getFeatures:function(){var e=new GeoBeans.BinaryLogicFilter;e.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd;var t=new GeoBeans.BinaryComparisionFilter;t.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var a=new GeoBeans.PropertyName;a.setName(this.timeField);var n=new GeoBeans.Literal;n.setValue(this.timePoint),t.expression1=a,t.expression2=n,e.addFilter(t);var i=this.featureType.geomFieldName,l=this.map.viewer,s=new GeoBeans.BBoxFilter;s.extent=l,a=new GeoBeans.PropertyName,a.setName(i),s.propName=a,e.addFilter(s),this.featureType.getFeaturesFilterAsync2(null,this.dbName,e,null,null,[this.chartField,i,this.labelField,this.flagField],null,this,this.getFeatures_callback)},getFeatures_callback:function(e,t){if(null!=e&&null!=t){e.features=t,e.style=e.getStyle();var a=e;a.flag=GeoBeans.Layer.Flag.READY,a.setTransformation(a.map.transformation),a.drawLayerSnap(),a.renderer.clearRect(),a.showTips(),a.drawLayer(),a.drawLegend(),a.flag=GeoBeans.Layer.Flag.LOADED,a.map.drawLayersAll()}},showTips:function(){if(null!=this.features&&null!=this.chartOption&&null!=this.colorMap&&null!=this.minMaxValue){this.tipInfos=[];for(var e=new GeoBeans.ColorRangeMap(this.colorMap.startColor,this.colorMap.endColor,this.minMaxValue.min,this.minMaxValue.max),t=this.featureType.getFieldIndex(this.chartField),a=this.featureType.getFieldIndex(this.labelField),n=this.featureType.getFieldIndex(this.flagField),i=null,l=null,s=null,r=0;r<this.features.length;++r)if(l=this.features[r],null!=l&&(s=l.geometry,null!=s)){var o=l.values;if(null!=o){i=o[t],i=parseFloat(i);var h=e.getValue(i),u=new GeoBeans.Rule,m=new GeoBeans.Symbolizer.PolygonSymbolizer,c=new GeoBeans.Fill;c.color=h,m.fill=c;var d=new GeoBeans.Stroke;d.color=h,d.width=.5,m.stroke=d,u.symbolizer=m;var v=new GeoBeans.Symbolizer.TextSymbolizer;v.labelText=i;var f=new GeoBeans.Font;f.family="宋体",f.style="normal",f.weight="normal",f.size="12",v.font=f;var p=new GeoBeans.Color;p.setByHex("#ffffff",1);var c=new GeoBeans.Fill;c.color=p,v.fill=c,u.textSymbolizer=v;var y=o[a],g=new GeoBeans.Rule,w=new GeoBeans.Symbolizer.PolygonSymbolizer,c=new GeoBeans.Fill;p=new GeoBeans.Color,p.setByHex("#ffffff",1),c.color=p,w.fill=c;var d=new GeoBeans.Stroke;d.color=h,d.width=.5,w.stroke=d,g.symbolizer=w;var v=new GeoBeans.Symbolizer.TextSymbolizer;v.labelText=y;var f=new GeoBeans.Font;f.family="宋体",f.style="normal",f.weight="normal",f.size="12",v.font=f;var p=new GeoBeans.Color;p.setByHex("#000000",1);var c=new GeoBeans.Fill;c.color=p,v.fill=c,g.textSymbolizer=v;var B=o[n],F=this.renderer.drawTip(s,this.map.transformation,u,g),b={flag:B,viewer:F,name:y};this.tipInfos.push(b)}}}},getMinMaxValue:function(){var e=this.chartField,t=0,a=500;switch(e){case"aqi":t=0,a=500;break;case"co":t=0,a=90;break;case"co_24h":t=0,a=90;break;case"no2":t=0,a=100;break;case"no2_24h":t=0,a=100;break;case"o3":t=0,a=200;break;case"o3_24h":t=0,a=200;break;case"o3_8h":t=0,a=200;break;case"o3_8h_24h":t=0,a=200;break;case"pm10":t=0,a=500;break;case"pm10_24":t=0,a=500;break;case"pm2_5":t=0,a=300;break;case"pm_2_5_24h":t=0,a=300;break;case"so2":t=0,a=500;break;case"so2_24h":t=0,a=500;break;default:t=0,a=500}return{min:t,max:a}},getStyle:function(){var e=new GeoBeans.Style.FeatureStyle("default",GeoBeans.Style.FeatureStyle.GeomType.Point),t=new GeoBeans.Rule,a=new GeoBeans.Symbolizer.PointSymbolizer,n=new GeoBeans.Color;return n.setByHex("#A4C3F2",1),a.fill.color=n,n=new GeoBeans.Color,n.setByHex("#808000",.1),a.stroke.color=n,a.size=1,t.symbolizer=a,e.addRule(t),e},addLegend:function(){if(null!=this.minMaxValue&&null!=this.minMaxValue.min&&null!=this.minMaxValue.max){var e="",e="<div class='chart-legend chart-legend-aqi' id='"+this.name+"'>";e+="<div class='chart-legend-title'><h5>"+this.chartField+"</h5></div>",e+="<div class='chart-legend-canvas'>	<canvas width='20' height='200'></canvas></div><div class='chart-legend-value'><div class='chart-legend-max'>"+this.minMaxValue.max+"</div><div class='chart-legend-min'>"+this.minMaxValue.min+"</div></div>",e+="</div>",this.map.mapDiv.append(e);var t=this.map.mapDiv.find("#"+this.name+" .chart-legend-canvas canvas"),a=t[0].getContext("2d"),n=new Image;n.src=this.colorMap.url,n.onload=function(){var e=t.width()/2,i=t.height()/2,l=n.width,s=n.height;a.clearRect(0,0,l,s),a.translate(e,i),a.rotate(270*Math.PI/180),a.drawImage(n,-l/2,-s/2,l,s),a.rotate(-270*Math.PI/180),a.translate(-e,-i)}}},registerHitEvent:function(e,t){var a=this,n=null,i=null,l=3;this.hitEvent=function(s){if(null==n){n=s.layerX,i=s.layerY;var r=new GeoBeans.Geometry.Point(n,i),o=a.map.transformation.toMapPoint(r.x,r.y),h=a.getTipInfo(r);if(null!=h){var u={title:h.name},m=new GeoBeans.InfoWindow(e,u);a.map.openInfoWindow(m,o),null!=t&&t(h.flag,h.name,a)}}else{var c=Math.abs(s.layerX-n)+Math.abs(s.layerY-i);if(c>l){n=s.layerX,i=s.layerY;var r=new GeoBeans.Geometry.Point(n,i),o=a.map.transformation.toMapPoint(r.x,r.y),h=a.getTipInfo(r);if(null!=h){var u={title:h.name},m=new GeoBeans.InfoWindow(e,u);a.map.openInfoWindow(m,o),null!=t&&t(h.flag,h.name,a)}}}};var s=null,r=null;this.moveEvent=function(e){if(null==s)s=e.layerX,r=e.layerY;else{var t=Math.abs(e.layerX-s)+Math.abs(e.layerY-r);if(t>l){s=e.layerX,r=e.layerY;var n=new GeoBeans.Geometry.Point(s,r),i=(a.map.transformation.toMapPoint(n.x,n.y),a.getTipInfo(n));null!=i?document.body.style.cursor="pointer":document.body.style.cursor="default"}}},this.map.canvas.addEventListener("click",this.hitEvent),this.map.canvas.addEventListener("mousemove",this.moveEvent)},unRegisterHitEvent:function(){this.map.canvas.removeEventListener("click",this.hitEvent),this.map.canvas.removeEventListener("mousemove",this.moveEvent),this.hitEvent=null,this.moveEvent=null},setVisiable:function(e){GeoBeans.Layer.prototype.setVisiable.apply(this,arguments),this.visible?null!=this.hitEvent&&(this.map.canvas.addEventListener("click",this.hitEvent),this.map.canvas.addEventListener("mousemove",this.moveEvent)):null!=this.hitEvent&&(this.map.canvas.removeEventListener("click",this.hitEvent),this.map.canvas.removeEventListener("mousemove",this.moveEvent))},getTipInfo:function(e){for(var t=null,a=null,n=this.tipInfos.length;n>=0;n--)if(t=this.tipInfos[n],null!=t&&(a=t.viewer,a.contain(e.x,e.y)))return t;return null}});
GeoBeans.Layer.AQITimelineLayer=GeoBeans.Class(GeoBeans.Layer.ChartLayer,{chartField:null,labelField:null,timePoints:null,styleMgr:null,flagField:null,timeField:null,chartLayers:null,interval:null,currentLayerID:null,timeline:null,initialize:function(e,t,i,a,s,n,r,l,h,o){this.name=e,this.dbName=t,this.tableName=i,this.chartField=a,this.labelField=s,this.flagField=n,this.timeField=r,this.timePoints=l,this.interval=h,this.chartOption=o,this.chartLayers=[],this.type=GeoBeans.Layer.ChartLayer.Type.AQITIMELINE},setMap:function(e){GeoBeans.Layer.prototype.setMap.apply(this,arguments);for(var t=null,i=0;i<this.timePoints.length;++i)if(t=this.timePoints[i],null!=t){var a=new GeoBeans.Layer.AQIChartLayer(this.name,this.dbName,this.tableName,this.chartField,this.labelField,this.flagField,this.timeField,t,this.chartOption);a.setMap(this.map),this.chartLayers.push(a)}this.currentLayerID=0,this.timeline=new GeoBeans.TimeLineBar(this)},cleanup:function(){GeoBeans.Layer.ChartLayer.prototype.cleanup.apply(this,arguments),this.timeline.cleanup()},load:function(){if(null==this.chartLayers)return void(this.flag=GeoBeans.Layer.Flag.LOADED);this.setTransformation(this.map.transformation),this.drawLayerSnap(),this.renderer.clearRect();var e=this.chartLayers,t=e[this.currentLayerID];if(null!=t){t.load();var i=t.canvas;null!=i&&t.flag==GeoBeans.Layer.Flag.LOADED&&this.renderer.drawImage(i,0,0,i.width,i.height)}this.flag=GeoBeans.Layer.Flag.LOADED},getChartField:function(){return this.chartField},getTimePoints:function(){return this.timePoints},setTimePoints:function(e){this.timePoints=e;for(var t=0;t<this.chartLayers.length;++t){var i=this.chartLayers[t];null!=i&&i.cleanup()}this.chartLayers=[];for(var t=0;t<this.timePoints.length;++t)if(timePoint=this.timePoints[t],null!=timePoint){var i=new GeoBeans.Layer.AQIChartLayer(this.name,this.dbName,this.tableName,this.chartField,this.labelField,this.flagField,this.timeField,timePoint,this.chartOption);i.setMap(this.map),this.chartLayers.push(i)}this.currentLayerID=0,this.timeline.cleanup(),this.timeline=new GeoBeans.TimeLineBar(this)},setChartOption:function(e){this.chartOption=e;for(var t=null,i=0;i<this.chartLayers.length;++i)t=this.chartLayers[i],null!=t&&(t.features=null,t.changeLegend=!0,t.setChartOption(e))},setChartField:function(e){this.chartField=e;for(var t=0;t<this.chartLayers.length;++t)layer=this.chartLayers[t],null!=layer&&(layer.features=null,layer.changeLegend=!0,layer.setChartField(e))},getInterval:function(){return this.interval},setInterval:function(e){this.interval=e,this.timeline.cleanup(),this.timeline=new GeoBeans.TimeLineBar(this)},setVisiable:function(e){GeoBeans.Layer.prototype.setVisiable.apply(this,arguments),this.visible?this.timeline.show():this.timeline.hide()}});
GeoBeans.Layer.BarChartLayer=GeoBeans.Class(GeoBeans.Layer.ChartLayer,{minMax:null,chartOption:null,initialize:function(t,e,a,i,r,n,s,l){GeoBeans.Layer.ChartLayer.prototype.initialize.apply(this,arguments),this.chartOption=l,this.type=GeoBeans.Layer.ChartLayer.Type.BAR},load:function(){this.visible?(this.removeLegend(),this.addLegend(),this.showLegend()):(this.removeLegend(),this.hideLegend()),this.minMax=this.getMinMaxValue();var t=this;this.flag=GeoBeans.Layer.Flag.READY,t.setTransformation(t.map.transformation),t.drawLayerSnap(),t.renderer.clearRect(),this.drawLayer(),t.flag=GeoBeans.Layer.Flag.LOADED},drawLayer:function(){if(null!=this.chartFeatures){var t=null,e=null,a=null,i=null,r=null;this.renderer.save(),this.renderer.setGlobalAlpha(this.chartOption.opacity);for(var n=0;n<this.chartFeatures.length;++n)if(t=this.chartFeatures[n],null!=t&&(geometry=t.geometry,null!=geometry&&geometry.type==GeoBeans.Geometry.Type.POINT&&(e=t.values,null!=e))){var s=[],l=null,h=null,o=document.createElement("canvas"),p=o.getContext("2d");p.font="12px Arial, Verdana, sans-seri";for(var d=this.chartFields.length,c=0;d>c;++c)if(i=this.chartFields[c],null!=i){var u=this.chartFeatureType.getFieldIndex(i);if(-1!=u){a=parseFloat(e[u]);var m=new Object;m.name=i,m.type="bar",m.data=[a];var y=p.measureText(e[u]).width;h=null==h?y:h>y?h:y,m.itemStyle={normal:{label:{show:this.chartOption.showLabel,position:"top"}}},s.push(m),l=null==l?a:a>l?a:l}}var g=10,v=10;h>this.chartOption.width&&(g=h-this.chartOption.width/d/2,v=h-this.chartOption.width/d/2);var x={top:26,bottom:12,left:g,right:v};r={grid:{x:x.left+"px",y:x.top+"px",x2:x.right+"px",y2:x.bottom+"px",width:this.chartOption.width+"px",borderWidth:0},xAxis:[{type:"category",data:[""],splitLine:{show:this.chartOption.x_splitLine},axisLabel:{show:!1},axisTick:{show:!1},axisLine:{show:this.chartOption.x_axisLine}}],yAxis:[{min:this.minMax.min,max:l,splitLine:{show:this.chartOption.y_splitLine},axisLabel:{show:!1},axisTick:{show:!1},axisLine:{show:this.chartOption.y_axisLine}}],color:this.chartOption.colors,series:s,animation:!1,calculable:!1};var f=this.chartOption.height,L=this.chartOption.width,w=parseFloat(x.top)+parseFloat(x.bottom),O=l/this.minMax.max*f+w,F=x.left+x.right,b=L+F,B="bar_chart_"+this.name+n,G="<div class='chart-div' style='height: "+O+"px; width:"+b+"px' id='"+B+"'></div>";this.map.mapDiv.append(G);var T=echarts.init(document.getElementById(B));T.setOption(r);var M=$("#"+B).find("canvas").first(),_=M.width(),A=M.height(),C=geometry.x,D=geometry.y,I=this.map.transformation.toScreenPoint(C,D),E=I.x-_/2+this.chartOption.offsetX,k=I.y-O+x.bottom-this.chartOption.offsetY;this.renderer.drawImage(M[0],E,k,_,A),T.dispose()}var R="bar_chart_"+this.name;$("*[id*='"+R+"']").remove(),this.renderer.restore()}},getMinMaxValue:function(){for(var t=null,e=null,a=null,i=null,r=null,n=null,s=null,l=0;l<this.chartFields.length;++l)if(a=this.chartFields[l],null!=a&&(s=this.chartFeatureType.getFieldIndex(a),-1!=s)){for(var h=null,o=null,p=0;p<this.chartFeatures.length;++p)i=this.chartFeatures[p],null!=i&&(r=i.values,null!=r&&(n=parseFloat(r[s]),h=null==h?n:n>h?n:h,o=null==o?n:o>n?n:o));t=null==t?h:h>t?h:t,e=null==e?o:e>o?o:e}return{min:e,max:t}},addLegend:function(){if(null!=this.chartOption){var t="<div class='chart-legend' id='"+this.name+"'>";t+="<div class='chart-legend-title'><h5>"+this.name+"</h5></div>";for(var e=null,a=null,i=this.chartOption.colors,r=0;r<this.chartFields.length;++r)e=this.chartFields[r],null!=e&&(a=i[r],t+="<div>	<span class='chart-legend-symbol' style='background-color:"+a+"'></span>	<span class='chart-legend-label'>"+e+"</span></div>");t+="</div>",this.map.mapDiv.append(t)}}});
GeoBeans.Layer.PieChartLayer=GeoBeans.Class(GeoBeans.Layer.ChartLayer,{chartOption:null,initialize:function(t,e,a,i,r,s,n,h){GeoBeans.Layer.ChartLayer.prototype.initialize.apply(this,arguments),this.chartOption=h,this.type=GeoBeans.Layer.ChartLayer.Type.PIE},setChartOption:function(t){this.chartOption=t,this.chartFeatures=this.getChartFeatures()},getChartOption:function(){return this.chartOption},load:function(){this.removeLegend(),this.addLegend(),this.visible?this.showLegend():this.hideLegend(),this.flag=GeoBeans.Layer.Flag.READY,this.setTransformation(this.map.transformation),this.drawLayerSnap(),this.renderer.clearRect(),this.drawLayer(),this.flag=GeoBeans.Layer.Flag.LOADED},drawLayer:function(){if(null!=this.chartFeatures){var t=null,e=null,a=null,i=null,r=null,s=80,n=[],h=0,l=0,o=!1,c=1;null!=this.chartOption&&(null!=this.chartOption.radius&&(s=this.chartOption.radius),null!=this.chartOption.colors&&(n=this.chartOption.colors),null!=this.chartOption.offsetX&&(h=this.chartOption.offsetX),null!=this.chartOption.offsetY&&(l=this.chartOption.offsetY),null!=this.chartOption.showLabel&&(o=this.chartOption.showLabel),null!=this.chartOption.opacity&&(c=this.chartOption.opacity)),this.renderer.save(),this.renderer.setGlobalAlpha(c);for(var p=0;p<this.chartFeatures.length;++p)if(t=this.chartFeatures[p],null!=t&&(geometry=t.geometry,null!=geometry&&geometry.type==GeoBeans.Geometry.Type.POINT&&(e=t.values,null!=e))){var d=[],u=document.createElement("canvas"),y=u.getContext("2d");y.font="12px Arial, Verdana, sans-seri";for(var m=null,g=0;g<this.chartFields.length;++g)if(i=this.chartFields[g],null!=i){var v=this.chartFeatureType.getFieldIndex(i);if(-1!=v){a=e[v];var f=new Object;f.name=a,f.value=[parseFloat(a)],d.push(f);var O=y.measureText(a).width;m=null==m?O:m>O?m:O}}var r={series:[{type:"pie",radius:this.chartOption.radius+"px",center:["50%","50%"],data:d,itemStyle:{normal:{label:{show:this.chartOption.showLabel,position:"outer"},labelLine:{show:this.chartOption.showLabel,length:0}}}}],animation:!1,calculable:!1,color:n},L=2*this.chartOption.radius+2*m+52,w=2*this.chartOption.radius+40,F="pie_chart_"+this.name+p,b="<div class='chart-div' style='height: "+w+"px; width:"+L+"px' id='"+F+"'></div>";this.map.mapDiv.append(b);var G=echarts.init(document.getElementById(F));G.setOption(r);var x=$("#"+F).find("canvas").first(),B=x.width(),C=x.height(),T=geometry.x,D=geometry.y,E=this.map.transformation.toScreenPoint(T,D),I=E.x-L/2+h,A=E.y-w/2-l;this.renderer.drawImage(x[0],I,A,B,C),G.dispose()}var P="pie_chart_"+this.name;$("*[id*='"+P+"']").remove(),this.renderer.restore()}},addLegend:function(){if(null!=this.chartOption){var t="<div class='chart-legend' id='"+this.name+"'>";t+="<div class='chart-legend-title'><h5>"+this.name+"</h5></div>";for(var e=null,a=null,i=this.chartOption.colors,r=0;r<this.chartFields.length;++r)e=this.chartFields[r],null!=e&&(a=i[r],t+="<div>	<span class='chart-legend-symbol' style='background-color:"+a+"'></span>	<span class='chart-legend-label'>"+e+"</span></div>");t+="</div>",this.map.mapDiv.append(t)}}});
GeoBeans.Layer.RangeChartLayer=GeoBeans.Class(GeoBeans.Layer.ChartLayer,{chartOption:null,style:null,styleMgr:null,colors:null,minMaxValue:null,labelLayerName:null,labelLayerField:null,changeLegend:!0,initialize:function(e,t,a,l,r,n,i,s,o,h){GeoBeans.Layer.ChartLayer.prototype.initialize.apply(this,arguments),this.chartOption=s,this.type=GeoBeans.Layer.ChartLayer.Type.RANGE,this.labelLayerName=o,this.labelLayerField=h},cleanup:function(){GeoBeans.Layer.ChartLayer.prototype.cleanup.apply(this,arguments),this.unRegisterHitEvent()},setVisiable:function(e){GeoBeans.Layer.prototype.setVisiable.apply(this,arguments),this.visible?null==this.hitEvent&&this.registerHitEvent(this.onFeatureHit):null!=this.hitEvent&&this.unRegisterHitEvent()},setChartOption:function(e){GeoBeans.Layer.ChartLayer.prototype.setChartOption.apply(this,arguments),this.style=this.getStyle(),this.changeLegend=!0,this.flag=GeoBeans.Layer.Flag.READY},setChartFields:function(e){this.chartFields=e,this.changeLegend=!0},setMap:function(e){GeoBeans.Layer.prototype.setMap.apply(this,arguments),this.getFeatures();var t=this.map.server.slice(0,this.map.server.lastIndexOf("/mgr"));this.styleMgr=new GeoBeans.StyleManager(t),this.registerHitEvent(this.onFeatureHit)},onFeatureHit:function(e,t,a){if(console.log(t.length),"pointer"==document.body.style.cursor)return void e.map.closeInfoWindow();if(0==t.length)e.map.closeInfoWindow();else{var l=t[0],r=l.chartValue,n=e.featureType;if(null==n)return;var i=l.values;if(null==i)return;var s=n.getFieldIndex(e.baseLayerField),o=i[s];null==r&&(r="空");var h="<div>"+r+"</div>",u={title:o,width:100,height:40},c=new GeoBeans.InfoWindow(h,u);e.map.openInfoWindow(c,a)}},getChartFeatureValue:function(e){for(var t=this.chartFields[0],a=this.chartFeatureType.getFieldIndex(t),l=this.tableField,r=this.chartFeatureType.getFieldIndex(l),n=null,i=0;i<this.chartFeatures.length;++i)if(n=this.chartFeatures[i],null!=n){var s=n.gid;if(s==e){var o=n.values;if(null!=o){var h=o[a],u=o[r];return{value:h,table:u}}}}return""},load:function(){var e=this.map.viewer;if(null!=e&&null!=this.viewer&&e.equal(this.viewer)&&null!=this.features&&this.flag==GeoBeans.Layer.Flag.LOADED)return void this.drawLegend();this.viewer=new GeoBeans.Envelope(e.xmin,e.ymin,e.xmax,e.ymax),null==this.style&&(this.style=this.getStyle());var t=this;t.flag=GeoBeans.Layer.Flag.READY,t.setTransformation(t.map.transformation),t.drawLayerSnap(),t.drawLegend(),t.renderer.clearRect();new Date;t.drawLayer(),t.flag=GeoBeans.Layer.Flag.LOADED},drawLegend:function(){this.changeLegend&&(this.removeLegend(),this.addLegend(),this.changeLegend=!1)},addLegend:function(){if(null!=this.minMaxValue&&null!=this.minMaxValue.min&&null!=this.minMaxValue.max){var e="",e="<div class='chart-legend chart-legend-range' id='"+this.name+"'>";e+="<div class='chart-legend-title'><h5>"+this.chartFields[0]+"</h5></div>",e+="<div class='chart-legend-canvas'>	<canvas width='20' height='200'></canvas></div><div class='chart-legend-value'><div class='chart-legend-max'>"+this.minMaxValue.max+"</div><div class='chart-legend-min'>"+this.minMaxValue.min+"</div></div>",e+="</div>",this.map.mapDiv.append(e);var t=this.map.mapDiv.find("#"+this.name+" .chart-legend-canvas canvas"),a=t[0].getContext("2d"),l=new Image;l.src=this.colorMap.url,l.onload=function(){var e=t.width()/2,r=t.height()/2,n=l.width,i=l.height;a.clearRect(0,0,n,i),a.translate(e,r),a.rotate(270*Math.PI/180),a.drawImage(l,-n/2,-i/2,n,i),a.rotate(-270*Math.PI/180),a.translate(-e,-r)}}},getChartStyle:function(){if(null==this.chartFeatures||null==this.chartOption)return null;var e=this.getMinMaxValue();if(null==e)return null;this.minMaxValue=e;var t=this.chartFeatures.length,a=this.chartOption.colorMapID,l=this.styleMgr.getColorMapByID(a);this.colorMap=l;for(var r=new GeoBeans.ColorRangeMap(this.colorMap.startColor,this.colorMap.endColor,e.min,e.max),n=this.chartFields[0],i=this.chartFeatureType.getFieldIndex(n),s=this.tableField,o=this.chartFeatureType.getFieldIndex(s),h=new GeoBeans.Style.FeatureStyle("chart",GeoBeans.Style.FeatureStyle.GeomType.Polygon),u=[],c=null,d=0;t>d;++d)if(c=this.chartFeatures[d],null!=c){var y=c.values;if(null!=y){var p=y[i];if(p=parseFloat(p),null!=p){var g=y[o],v=r.getValue(p),f=new GeoBeans.Symbolizer.PolygonSymbolizer;null!=this.chartOption.opacity?v.setOpacity(this.chartOption.opacity):v.setOpacity(1),f.fill.color=v,v=new GeoBeans.Color,null!=this.chartOption.border&&v.setByHex(this.chartOption.border,1),null!=this.chartOption.borderOpacity?v.setOpacity(this.chartOption.borderOpacity):v.setOpacity(1),f.stroke.color=v;var m=new GeoBeans.IDFilter;m.addID(c.gid);var v=new GeoBeans.Color,F=new GeoBeans.Fill;F.color=v;var B=new GeoBeans.Rule;B.filter=m,B.name=g,B.symbolizer=f,u.push(B)}}}return h.rules=u,h},getLabelLayer:function(){var e=this.map.getLayer(this.labelLayerName);if(null==e)return null;var t=e.featureType,a=t.geomFieldName,l=[this.labelLayerField,a],r=t.getFeaturesFilter(this.map.name,null,null,null,null,l),n=t.getFieldIndex(this.labelLayerField),i=null,s=this.chartFeatureType.getFieldIndex(this.tableField),o=this.chartFeatureType.getFieldIndex(this.chartFields[0]),h=new GeoBeans.Layer.FeatureLayer("label");h.features=[];for(var u=new GeoBeans.Style.FeatureStyle("label",GeoBeans.Style.FeatureStyle.GeomType.Point),c=[],d=0;d<r.length;++d)if(i=r[d],null!=i){var y=i.values;if(null!=y)for(var p=y[n],g=0;g<this.chartFeatures.length;++g){var v=this.chartFeatures[g];if(null!=v){var f=v.values;if(null!=f){var m=f[s];if(m==p){h.addFeature(i);var F=f[o],B=new GeoBeans.Rule,L=new GeoBeans.Symbolizer.TextSymbolizer;L.labelText=F;var w=new GeoBeans.Font;w.family="SimSun",w.style="normal",w.weight="normal",w.size="18",L.font=w;var b=new GeoBeans.Color;b.setByHex("#f500c0",1);var G=new GeoBeans.Fill;G.color=b,L.fill=G,L.stroke=null;var x=new GeoBeans.IDFilter;x.addID(i.fid),B.textSymbolizer=L,B.filter=x,c.push(B)}}}}}return u.rules=c,h.style=u,h},getFeatures:function(){if(null==this.baseLayerName||null==this.baseLayerField||null==this.dbName||null==this.tableName||null==this.tableField)return null;var e=this.map.getLayer(this.baseLayerName);if(null==e)return null;var t=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0"),a=new GeoBeans.FeatureType(t,this.tableName);this.chartFeatureType=a;var l=(a.getFields(null,this.dbName),a.getFeaturesFilter(null,this.dbName,null,null,null,[this.tableField].concat(this.chartFields))),r=a.getFieldIndex(this.tableField);if(-1==r)return null;var n=a.getFieldIndex(this.chartFields[0]),i=e.getFeatureType(),s=i.geomFieldName,o=[this.baseLayerField,s],h=i.getFeaturesFilter(this.map.name,null,null,null,null,o),u=(e.getFields(),i.getFieldIndex(this.baseLayerField));if(-1==u)return null;for(var c=0;c<h.length;++c){var d=h[c];if(null!=d){var y=d.values;if(null!=y)for(var p=y[u],g=0;g<l.length;++g){var v=l[g];if(null!=v){var f=v.values;if(null!=f){var m=f[r];if(p==m){var F=f[n];d.chartValue=F}}}}}}this.features=h,this.featureType=i},getStyle:function(){if(null==this.features||null==this.chartOption)return null;var e=this.getMinMaxValue();if(null==e)return null;this.minMaxValue=e;var t=this.features.length,a=this.chartOption.colorMapID,l=this.styleMgr.getColorMapByID(a);this.colorMap=l;for(var r=new GeoBeans.ColorRangeMap(this.colorMap.startColor,this.colorMap.endColor,e.min,e.max),n=new GeoBeans.Style.FeatureStyle("chart",GeoBeans.Style.FeatureStyle.GeomType.Polygon),i=[],s=0;t>s;++s){var o=this.features[s];if(null!=o){var h=o.chartValue,u=new GeoBeans.Symbolizer.PolygonSymbolizer,c=null;null==h?(c=new GeoBeans.Color,c.setByHex("#ffffff",1)):(h=parseFloat(h),c=r.getValue(h)),null!=this.chartOption.opacity?c.setOpacity(this.chartOption.opacity):c.setOpacity(1),u.fill.color=c,c=new GeoBeans.Color,null!=this.chartOption.border&&c.setByHex(this.chartOption.border,1),null!=this.chartOption.borderOpacity?c.setOpacity(this.chartOption.borderOpacity):c.setOpacity(1),u.stroke.color=c;var d=new GeoBeans.IDFilter;d.addID(o.fid);var c=new GeoBeans.Color,y=new GeoBeans.Fill;y.color=c;var p=new GeoBeans.Rule;p.filter=d,p.name=h,p.symbolizer=u,i.push(p)}}return n.rules=i,n},getMinMaxValue:function(){if(null==this.features)return null;for(var e=null,t=null,a=null,l=0;l<this.features.length;++l)if(a=this.features[l],null!=a){var r=a.chartValue;null!=r&&(r=parseFloat(r),e=null==e?r:e>r?r:e,t=null==t?r:r>t?r:t)}return{min:e,max:t}}});
GeoBeans.Layer.AMapLayer=GeoBeans.Class(GeoBeans.Layer.TileLayer,{AMP_URL:"/appmaptile?lang=zh_cn&size=1&scale=1&style=8",IMG_WIDTH:256,IMG_HEIGHT:256,MIN_ZOOM_LEVEL:1,MAX_ZOOM_LEVEL:18,FULL_EXTENT:{xmin:-20037508.3427892,ymin:-20037508.3427892,xmax:20037508.3427892,ymax:20037508.3427892},RESOLUTIONS:[78271.51696402031,39135.75848201016,19567.87924100508,9783.939620502539,4891.96981025127,2445.984905125635,1222.992452562817,611.4962262814087,305.7481131407043,152.8740565703522,76.43702828517608,38.21851414258804,19.10925707129402,9.554628535647009,4.777314267823505,2.388657133911752,1.194328566955876,.5971642834779382],resolution:null,rows:null,cols:null,offset_x:0,offset_y:0,lrow:0,urow:0,lcol:0,rcol:0,initialize:function(t,i){GeoBeans.Layer.TileLayer.prototype.initialize.apply(this,arguments)},destory:function(){GeoBeans.Layer.TileLayer.prototype.destroy.apply(this,arguments)},computeTileBound:function(){var t=this.map,i=(t.level,t.resolution),e=i*this.IMG_WIDTH,a=this.getValidView(),s=Math.floor((a.xmin-this.FULL_EXTENT.xmin)/e),l=Math.ceil((a.xmax-this.FULL_EXTENT.xmin)/e),r=Math.floor((this.FULL_EXTENT.ymax-a.ymax)/e),n=Math.ceil((this.FULL_EXTENT.ymax-a.ymin)/e);return{rmin:r,rmax:n,cmin:s,cmax:l}},updateTileCache:function(t){var i,e,a,s,l=t.rmin,r=t.rmax,n=t.cmin,o=t.cmax,h=null,c=this.map.level;for(a=l;r>a;a++)for(s=n;o>s;s++)i="x="+s+"&y="+a+"&z="+c,e=this.AMP_URL+"&"+i,null==this.cache.getTile(e)&&(h=new GeoBeans.Tile(this.map,e,this,s,a,c,0,0),this.cache.putTile(h))},draw:function(){var t=this.computeTileBound();this.updateTileCache(t);var i=t.rmin,e=t.rmax,a=t.cmin,s=t.cmax,l=this.map.transformation.toScreenPoint(this.FULL_EXTENT.xmin,this.FULL_EXTENT.ymax);l.x=Math.floor(l.x+.5),l.y=Math.floor(l.y+.5);var r,n,o,h,c,m=this.IMG_WIDTH*this.scale,u=this.map.level;for(n=l.y+i*m,o=i;e>o;o++){for(r=l.x+a*m,h=a;s>h;h++)tid=this.getTileID(o,h,u),turl=this.AMP_URL+"&"+tid,c=this.cache.getTile(turl),null!=c&&c.draw(r,n,m,m),r+=m;n+=m}},drawCache:function(){var t=this.computeTileBound(),i=t.rmin,e=t.rmax,a=t.cmin,s=t.cmax,l=this.map.transformation.toScreenPoint(this.FULL_EXTENT.xmin,this.FULL_EXTENT.ymax);l.x=Math.floor(l.x+.5),l.y=Math.floor(l.y+.5);var r,n,o,h,c,m=this.IMG_WIDTH*this.scale,u=this.map.level;for(n=l.y+i*m,o=i;e>o;o++){for(r=l.x+a*m,h=a;s>h;h++)tid=this.getTileID(o,h,u),turl=this.AMP_URL+"&"+tid,c=this.cache.getTile(turl),null!=c&&c.draw(r,n,m,m),r+=m;n+=m}},preDraw:function(){var t=this.computeTileBound();this.updateTileCache(t);var i=t.rmin,e=t.rmax,a=t.cmin,s=t.cmax,l=this.map.transformation.toScreenPoint(this.FULL_EXTENT.xmin,this.FULL_EXTENT.ymax);l.x=Math.floor(l.x+.5),l.y=Math.floor(l.y+.5);var r,n,o,h,c,m=this.IMG_WIDTH*this.scale,u=this.map.level;for(n=l.y+i*m,o=i;e>o;o++){for(r=l.x+a*m,h=a;s>h;h++){tid=this.getTileID(o,h,u),turl=this.AMP_URL+"&"+tid,c=this.cache.getTile(turl);var T=new Object;T.tile=c,T.img_size=m,T.x=r,T.y=n,this.tiles.push(T),r+=m}n+=m}},loadingTiles:function(t){for(var i=0;i<this.tiles.length;++i){var e=this.tiles[i].tile;if(null!=e)if(e.state!=GeoBeans.TileState.LOADED)e.loading(t,this.loadTileCallback,this.tiles,i),this.state=GeoBeans.TileLayerState.LOADING;else if(e.state==GeoBeans.TileState.LOADED){var a=this.tiles[i],s=a.img_size,l=a.x,r=a.y;e.draw(l,r,s,s)}}for(var i=0;i<this.tiles.length;++i){var n=this.tiles[i];if(n.tile.state!=GeoBeans.TileState.LOADED)return}t(this.map)},loadTileCallback:function(t,i,e,a){var s=e[a],l=s.img_size,r=s.x,n=s.y;t.draw(r,n,l,l);for(var o=0;o<e.length;++o){var h=e[o];if(h.tile.state!=GeoBeans.TileState.LOADED)return}i(t.map)},getRows:function(){},getCols:function(){},computeExtent:function(){},computeCenterTileOffset:function(){var t=this.map.center,i=(t.x-this.ORIGIN.x,t.y-this.ORIGIN.y,Math.floor((t.x-this.ORIGIN.x)/this.resolution)),e=Math.floor((t.y-this.ORIGIN.y)/this.resolution);offset_x=i,offset_y=e},getTileID:function(t,i,e){return"x="+i+"&y="+t+"&z="+e},isCached:function(t){for(var i in this.tileCache){var e=this.tileCache[i];if(e.url==t)return!0}return!1}});
GeoBeans.Layer.BaiduLayer=GeoBeans.Class(GeoBeans.Layer.TileLayer,{ORIGIN:{x:0,y:0},IMG_WIDTH:256,IMG_HEIGHT:256,MIN_ZOOM_LEVEL:1,MAX_ZOOM_LEVEL:19,RESOLUTIONS:[131072,65536,32768,16384,8192,4096,2048,1024,512,256,128,64,32,16,8,4,2,1,.5],initialize:function(e){GeoBeans.Layer.TileLayerLayer.prototype.initialize.apply(this,arguments)},destory:function(){GeoBeans.Layer.TileLayerLayer.prototype.destroy.apply(this,arguments)}});

GeoBeans.Layer.QSLayer=GeoBeans.Class(GeoBeans.Layer.TileLayer,{AMP_URL:"/QuadServer/maprequest?services=world_image",IMG_WIDTH:256,IMG_HEIGHT:256,MIN_ZOOM_LEVEL:1,MAX_ZOOM_LEVEL:10,FULL_EXTENT:{xmin:-256,ymin:-256,xmax:256,ymax:256},RESOLUTIONS:[1,.5,.25,.125,.0625,.03125,.015625,.0078125,.00390625,.001953125,976563e-9,488281e-9,244141e-9,12207e-8,6103515625e-14,30517578125e-15,152587890625e-16,762939453125e-17,3814697265625e-18,19073486328125e-19],resolution:null,rows:null,cols:null,offset_x:0,offset_y:0,lrow:0,urow:0,lcol:0,rcol:0,initialize:function(t,e){GeoBeans.Layer.TileLayer.prototype.initialize.apply(this,arguments)},destory:function(){GeoBeans.Layer.TileLayer.prototype.destroy.apply(this,arguments)},updateTileCache:function(t){var e,i,a,s,l=t.rmin,r=t.rmax,o=t.cmin,n=t.cmax,h=null,m=this.map.level;for(a=l;r>a;a++)for(s=o;n>s;s++)e=this.getTileID(a,s,m),i=this.url+"&"+e,null==this.cache.getTile(i)&&(h=new GeoBeans.Tile(this.map,i,this,a,s,m,0,0),this.cache.putTile(h))},preDraw:function(){this.renderer.clearRect();var t=this.computeTileBound();this.updateTileCache(t);var e=t.rmin,i=t.rmax,a=t.cmin,s=t.cmax,l=this.map.transformation.toScreenPoint(this.FULL_EXTENT.xmin,this.FULL_EXTENT.ymin);l.x=Math.floor(l.x+.5),l.y=Math.floor(l.y+.5);var r,o,n,h,m,c=this.IMG_WIDTH*this.scale;this.map.transformation.toMapPoint(l.x,l.y);this.tiles=[];var u=this.map.level;for(o=l.y-(e+1)*c,n=e;i>n;n++){for(r=l.x+a*c,h=a;s>h;h++){tid=this.getTileID(n,h,u),turl=this.url+"&"+tid,m=this.cache.getTile(turl);var f=new Object;f.tile=m,f.img_size=c,f.x=r,f.y=o,this.tiles.push(f),r+=c}o-=c}},loadingTiles:function(t){for(var e=0;e<this.tiles.length;++e){var i=this.tiles[e].tile;if(null!=i)if(i.state!=GeoBeans.TileState.LOADED)i.loading(t,this.loadTileCallback,this.tiles,e),this.state=GeoBeans.TileLayerState.LOADING;else if(i.state==GeoBeans.TileState.LOADED){var a=this.tiles[e],s=a.img_size,l=a.x,r=a.y;i.draw(l,r,s,s)}}for(var e=0;e<this.tiles.length;++e){var o=this.tiles[e];if(o.tile.state!=GeoBeans.TileState.LOADED)return}t(this.map)},loadTileCallback:function(t,e,i,a){var s=i[a],l=s.img_size,r=s.x,o=s.y;t.draw(r,o,l,l);for(var n=0;n<i.length;++n){var h=i[n];if(h.tile.state!=GeoBeans.TileState.LOADED)return}e(t.map)},draw:function(){for(var t=0;t<this.tilesLoaded.length;++t){var e=this.tilesLoaded[t],i=e.tile,a=e.img_size,s=e.x,l=e.y;null!=i&&i.draw(s,l,a,a)}},drawCache:function(){var t=this.computeTileBound(),e=t.rmin,i=t.rmax,a=t.cmin,s=t.cmax,l=this.map.transformation.toScreenPoint(this.FULL_EXTENT.xmin,this.FULL_EXTENT.ymin);l.x=Math.floor(l.x+.5),l.y=Math.floor(l.y+.5);var r,o,n,h,m,c=this.IMG_WIDTH*this.scale,u=this.map.level;for(o=l.y-(e+1)*c,n=e;i>n;n++){for(r=l.x+a*c,h=a;s>h;h++)tid=this.getTileID(n,h,u),turl=this.url+"&"+tid,m=this.cache.getTile(turl),null!=m&&m.draw(r,o,c,c),r+=c;o-=c}},getRows:function(){},getCols:function(){},computeExtent:function(){},computeCenterTileOffset:function(){var t=this.map.center,e=(t.x-this.ORIGIN.x,t.y-this.ORIGIN.y,Math.floor((t.x-this.ORIGIN.x)/this.resolution)),i=Math.floor((t.y-this.ORIGIN.y)/this.resolution);offset_x=e,offset_y=i},getTileID:function(t,e,i){return"col="+e+"&row="+t+"&level="+i},computeTileBound:function(){var t=this.map,e=(t.level,t.resolution),i=e*this.IMG_WIDTH,a=this.getValidView(),s=Math.floor((a.xmin-this.FULL_EXTENT.xmin)/i),l=Math.ceil((a.xmax-this.FULL_EXTENT.xmin)/i),r=Math.floor((a.ymin-this.FULL_EXTENT.ymin)/i),o=Math.ceil((a.ymax-this.FULL_EXTENT.ymin)/i);return{rmin:r-1,rmax:o+1,cmin:s-1,cmax:l+1}}});
GeoBeans.Layer.WMTSLayer=GeoBeans.Class(GeoBeans.Layer.TileLayer,{name:null,type:null,extent:null,format:null,tms:null,sourceName:null,IMG_WIDTH:180,IMG_HEIGHT:180,MIN_ZOOM_LEVEL:1,MAX_ZOOM_LEVEL:10,RESOLUTIONS:[1,.5,.25,.125,.0625,.03125,.015625,.0078125,.00390625,.001953125,976563e-9,488281e-9,244141e-9,12207e-8,6103515625e-14,30517578125e-15,152587890625e-16,762939453125e-17,3814697265625e-18,19073486328125e-19],initialize:function(t,e,i,a,s,n,l){GeoBeans.Layer.TileLayer.prototype.initialize.apply(this,arguments),this.typeName=i,this.extent=a,this.tms=s,this.format=n,this.FULL_EXTENT={xmin:this.extent.xmin,ymin:this.extent.ymin,xmax:this.extent.xmax,ymax:this.extent.ymax},this.scale=1,this.sourceName=l},setExtent:function(t){this.extent=t},getExtent:function(){return this.extent},setFormat:function(t){this.format=t},getFormat:function(){return this.format},setTMS:function(t){this.tms=t},getTMS:function(){return this.tms},load:function(){this.preDraw(),this.loadingTiles(this.map.drawBaseLayerCallback)},preDraw:function(){this.renderer.clearRect();var t=this.computeTileBound();this.updateTileCache(t);var e=t.rmin,i=t.rmax,a=t.cmin,s=t.cmax;console.log("row:"+e+","+i+";col:"+a+","+s);var n=this.map.transformation.toScreenPoint(this.FULL_EXTENT.xmin,this.FULL_EXTENT.ymax);n.x=Math.floor(n.x+.5),n.y=Math.floor(n.y+.5);var l,r,h,o,m,T=this.IMG_WIDTH*this.scale;this.map.transformation.toMapPoint(n.x,n.y);this.tiles=[];var u=this.map.level;for(r=n.y-e*T,r=n.y+e*T,h=e;i>=h;h++){for(l=n.x+a*T,o=a;s>=o;o++){tid=this.getTileID(h,o,u),turl=this.url+tid,m=this.cache.getTile(turl);var c=new Object;c.tile=m,c.img_size=T,c.x=l,c.y=r,this.tiles.push(c),l+=T}r+=T}},computeTileBound:function(){var t=this.map,e=(t.level,t.resolution),i=e*this.IMG_WIDTH,a=this.getValidView(),s=Math.floor((a.xmin-this.FULL_EXTENT.xmin)/i),n=Math.ceil((a.xmax-this.FULL_EXTENT.xmin)/i),l=Math.floor((this.FULL_EXTENT.ymax-a.ymax)/i),r=Math.ceil((this.FULL_EXTENT.ymax-a.ymin)/i);return{rmin:l,rmax:r-1,cmin:s,cmax:n-1}},updateTileCache:function(t){var e,i,a,s,n=t.rmin,l=t.rmax,r=t.cmin,h=t.cmax,o=null,m=this.map.level;for(a=n;l>=a;a++)for(s=r;h>=s;s++)e=this.getTileID(a,s,m),i=this.url+e,null==this.cache.getTile(i)&&(o=new GeoBeans.Tile(this.map,i,this,a,s,m,0,0),this.cache.putTile(o))},getTileID:function(t,e,i){var a="?SERVICE=dbs&REQUEST=GetTile&VERSION=1.0.0&LAYER="+this.typeName+"&STYLE=Default&FORMAT="+this.format+"&TILEMATRIXSET="+this.tms+"&TILEMATRIX="+this.tms+":"+i+"&TILEROW="+t+"&TILECOL="+e+"&sourceName="+this.sourceName;return a},loadingTiles:function(t){for(var e=0;e<this.tiles.length;++e){var i=this.tiles[e].tile;if(null!=i)if(i.state!=GeoBeans.TileState.LOADED)i.loading(t,this.loadTileCallback,this.tiles,e),this.state=GeoBeans.TileLayerState.LOADING,this.flag=GeoBeans.Layer.Flag.READY;else if(i.state==GeoBeans.TileState.LOADED){var a=this.tiles[e],s=a.img_size,n=a.x,l=a.y;i.draw(n,l,s,s)}}for(var e=0;e<this.tiles.length;++e){var r=this.tiles[e];if(r.tile.state!=GeoBeans.TileState.LOADED)return}this.flag=GeoBeans.Layer.Flag.LOADED,t(this.map)},loadTileCallback:function(t,e,i,a){var s=i[a],n=s.img_size,l=s.x,r=s.y;t.draw(l,r,n,n);for(var h=0;h<i.length;++h){var o=i[h];if(o.tile.state!=GeoBeans.TileState.LOADED)return}t.layer.flag=GeoBeans.Layer.Flag.LOADED,e(t.map)}});
GeoBeans.Overlay.Circle=GeoBeans.Class(GeoBeans.Overlay,{type:GeoBeans.Overlay.Type.CIRCLE});
GeoBeans.Overlay.Marker=GeoBeans.Class(GeoBeans.Overlay,{image:null,type:GeoBeans.Overlay.Type.MARKER,initialize:function(e,a){GeoBeans.Overlay.prototype.initialize.apply(this,arguments)}});
GeoBeans.Overlay.Polygon=GeoBeans.Class(GeoBeans.Overlay,{type:GeoBeans.Overlay.Type.POLYGON});
GeoBeans.Overlay.Polyline=GeoBeans.Class(GeoBeans.Overlay,{type:GeoBeans.Overlay.Type.PLOYLINE});
GeoBeans.PoiManager=GeoBeans.Class({server:null,service:"poi",version:"1.0.0",initialize:function(e){this.server=e+"/mgr"},getPoi:function(e,n,t,i,s){if(null==e)return void(null!=s&&s("keyword is null"));var r=this,o="service="+this.service+"&version="+this.version+"&request=GetPoi";if($.isArray(e)){for(var a="",l=0;l<e.length;++l)a+=e[l],l<e.length-1&&(a+=",");o+="&name="+a}else o+="&name="+e;null!=n&&(o+="&limit="+n),null!=t&&(o+="&offset="+t),null!=i&&i instanceof GeoBeans.Envelope&&(o+="&extent="+i.toString()),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var t=r.parsGetPoi(e);null!=s&&s(t)},complete:function(e,n){},error:function(){}})},parsGetPoi:function(e){var n=[];return $(e).find("Pois>Poi").each(function(){var e=$(this).find("name").text(),t=$(this).find("lon").text(),i=$(this).find("lat").text(),s=$(this).find("address").text(),r=$(this).find("type").text(),o={name:e,x:t,y:i,address:s,type:r};n.push(o)}),n}});
GeoBeans.Raster=GeoBeans.Class({name:null,format:null,bands:null,width:null,height:null,extent:null,initialize:function(t,i,n,s,e,l,h){this.name=t,this.format=i,this.bands=n,this.srid=s,this.width=e,this.height=l,this.extent=h}});
GeoBeans.RasterDBManager=GeoBeans.Class({server:null,service:"rds",version:"1.0.0",currentPath:null,initialize:function(e){this.server=e+"/mgr"},getList:function(e,r,t){if(null==e||null==r)return void(null!=t&&t("invalid params"));var n=this,s="service="+this.service+"&version="+this.version+"&request=List&path="+r+"&sourceName="+e;n.currentPath=r,$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var s=n.parseList(e);void 0!=t&&t(s)},complete:function(e,r){},error:function(){}})},parseList:function(e){var r=this,t=[],n=$(e).find("Files");return n.children().each(function(){if("File"==this.tagName){var e=r.parseFile(this);t.push(e)}else if("Folder"==this.tagName){var n=r.parseFolder(this);t.push(n)}}),t},parseFile:function(e){var r=$(e).attr("name"),t=$(e).attr("access_time"),n=$(e).attr("last_modified_time"),s=$(e).attr("size"),a=null;a="/"==this.currentPath?this.currentPath+r:this.currentPath+"/"+r;var i=new GeoBeans.File(this.currentPath,a,r,t,n,s);return i},parseFolder:function(e){var r=$(e).attr("name"),t=$(e).attr("access_time"),n=$(e).attr("last_modified_time"),s=null;s="/"==this.currentPath?this.currentPath+r:this.currentPath+"/"+r;var a=new GeoBeans.Folder(this.currentPath,s,r,t,n);return a},addRaster:function(e,r,t,n,s){if(null==e||null==r||null==t||null==n)return void(null!=s&&s("invalid params"));var a=this,i="service="+this.service+"&version="+this.version+"&request=AddRaster&sourceName="+e+"&rasterName="+r+"&rasterPath="+t+"&filePath="+n;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var t=a.parseAddRaster(e);void 0!=s&&s(t)},complete:function(e,r){},error:function(){}})},parseAddRaster:function(e){var r=$(e).find("AddRaster").text();if("success"==r.toLowerCase())return"success";var t=$(e).find("ExceptionText").text();return t},removeRaster:function(e,r,t,n){if(null==e||null==r||null==t)return void(null!=n&&n("invalid params"));var s=this,a="service="+this.service+"&version="+this.version+"&request=RemoveRaster&sourceName="+e+"&rasterName="+r+"&path="+t;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var t=s.parseRemoveRaster(e);void 0!=n&&n(t)},complete:function(e,r){},error:function(){}})},parseRemoveRaster:function(e){var r=$(e).find("RemoveRaster").text();if("success"==r.toLowerCase())return"success";var t=$(e).find("ExceptionText").text();return t},getRaster:function(e,r,t,n){if(null==e||null==r||null==t)return void(null!=n&&n("invalid params"));var s="service="+this.service+"&version="+this.version+"&request=GetRaster&sourceName="+e+"&rasterName="+r+"&Path="+t;$.ajax({type:"get",url:this.server,data:encodeURI(s),async:!0,beforeSend:function(e){},success:function(e,r){null!=n&&n(e)},complete:function(e,r){},error:function(e){}})},getRasterUrl:function(e,r,t){if(null==e||null==r||null==t)return null;var n=this.server+"?service="+this.service+"&version="+this.version+"&request=GetRaster&sourceName="+e+"&rasterName="+r+"&Path="+t;return n},describeRaster:function(e,r,t,n){if(null==e||null==r||null==t)return void(null!=n&&n("invalid params"));var s=this,a="service="+this.service+"&version="+this.version+"&request=DescribeRaster&sourceName="+e+"&rasterName="+r+"&Path="+t;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var t=s.parseDescribeRaster(e);null!=n&&n(t)},complete:function(e,r){},error:function(){}})},parseDescribeRaster:function(e){var r=$(e).find("Raster>Name").text(),t=$(e).find("Raster>Format").text(),n=$(e).find("Raster>Bands").text(),s=$(e).find("Raster>SRID").text(),a=$(e).find("Raster>Width").text(),i=$(e).find("Raster>Height").text(),u=null,o=null,l=null,c=null,v=$(e).find("Raster>Boundingbox>LowerLeft").text();if(null!=v){var d=v.split(" ");u=parseFloat(d[0]),o=parseFloat(d[1])}var f=$(e).find("Raster>Boundingbox>UpperRight").text();if(null!=f){var d=f.split(" ");l=parseFloat(d[0]),c=parseFloat(d[1])}var h=null;null!=u&&null!=o&&null!=l&&null!=c&&(h=new GeoBeans.Envelope(u,o,l,c));var p=null;return null!=r&&(p=new GeoBeans.Raster(r,t,n,s,a,i,h)),p},createFolder:function(e,r,t){if(null==r||null==e)return void(null!=t&&t("params is invalid"));var n=this,s="service="+this.service+"&version="+this.version+"&request=CreateFolder&sourceName="+e+"&path="+r;n.currentPath=r,$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var s=n.parseCreateFolder(e);void 0!=t&&t(s)},complete:function(e,r){},error:function(){}})},parseCreateFolder:function(e){var r=$(e).find("CreateFolder").text();if("success"==r.toLowerCase())return"success";var t=$(e).find("ExceptionText").text();return t},removeFolder:function(e,r,t){if(null==r||null==e)return void(null!=t&&t("params is invalid"));var n=this,s="service="+this.service+"&version="+this.version+"&request=RemoveFolder&sourceName="+e+"&path="+r;n.currentPath=r,$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var s=n.parseRemoveFolder(e);void 0!=t&&t(s)},complete:function(e,r){},error:function(){}})},parseRemoveFolder:function(e){var r=$(e).find("RemoveFolder").text();if("success"==r.toLowerCase())return"success";var t=$(e).find("ExceptionText").text();return t}});
GeoBeans.ColorMap=GeoBeans.Class({id:null,startColor:null,endColor:null,initialize:function(l,o,i,n){this.id=l,this.startColor=o,this.endColor=i,this.url=n}});
GeoBeans.Style.FeatureStyle=GeoBeans.Class(GeoBeans.Style,{name:null,rules:null,geomType:null,styleClass:null,field:null,initialize:function(e,l){this.name=e,this.geomType=l,this.type=GeoBeans.Style.Type.FeatureType,this.rules=[]},addRule:function(e){this.rules.push(e)},removeRule:function(e){this.rules.splice(e,1)},clone:function(){for(var e=new GeoBeans.Style.FeatureStyle(this.name,this.geomType),l=0;l<this.rules.length;++l){var t=this.rules[l].clone();e.addRule(t)}return e.styleClass=this.styleClass,e}}),GeoBeans.Style.FeatureStyle.GeomType={Point:"Point",LineString:"LineString",Polygon:"Polygon"},GeoBeans.Style.FeatureStyle.StyleClass={SINGLE:"single",UNIQUE:"unique",QUANTITIES:"quantities",CUSTOM:"custom",DOTDENSITY:"DotDensity"};
GeoBeans.Fill=GeoBeans.Class({color:null,initialize:function(){this.color=new GeoBeans.Color},getRgba:function(){return this.color.getRgba()},getOpacity:function(){return this.color.getOpacity()},getRgb:function(){return this.color.getRgb()},clone:function(){var o=new GeoBeans.Fill;return null!=this.color&&(o.color=this.color.clone()),o}});
GeoBeans.Font=GeoBeans.Class({family:null,style:null,weight:null,size:null,initialize:function(){this.family="Times New Roman",this.style=GeoBeans.Font.StyleType.Normal,this.weight=GeoBeans.Font.WeightType.Normal,this.size=12},clone:function(){var e=new GeoBeans.Font;return e.family=this.family,e.style=this.style,e.weight=this.weight,e.size=this.size,e}}),GeoBeans.Font.StyleType={Normal:"normal",Italic:"italic",Oblique:"oblique"},GeoBeans.Font.WeightType={Normal:"normal",Bold:"bold"};
GeoBeans.Symbolizer.LineSymbolizer=GeoBeans.Class(GeoBeans.Symbolizer,{stroke:null,fill:null,symbol:null,initialize:function(){GeoBeans.Symbolizer.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Symbolizer.Type.Line,this.stroke=new GeoBeans.Stroke,this.fill=new GeoBeans.Fill},clone:function(){var l=new GeoBeans.Symbolizer.LineSymbolizer;return null!=this.stroke?l.stroke=this.stroke.clone():l.stroke=null,null!=this.fill?l.fill=this.fill.clone():l.fill=null,null!=this.symbol&&(l.symbol=this.symbol.clone()),l}});
GeoBeans.Symbolizer.PointSymbolizer=GeoBeans.Class(GeoBeans.Symbolizer,{size:null,fill:null,stroke:null,icon_url:null,icon_offset_x:null,icon_offset_y:null,symbol:null,initialize:function(){GeoBeans.Symbolizer.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Symbolizer.Type.Point,this.fill=new GeoBeans.Fill,this.stroke=new GeoBeans.Stroke,this.size=3},clone:function(){var l=new GeoBeans.Symbolizer.PointSymbolizer;return null!=this.fill?l.fill=this.fill.clone():l.fill=null,null!=this.stroke?l.stroke=this.stroke.clone():l.stroke=null,l.size=this.size,null!=this.symbol?l.symbol=this.symbol.clone():l.symbol=null,l}});
GeoBeans.Symbolizer.PolygonSymbolizer=GeoBeans.Class(GeoBeans.Symbolizer,{fill:null,stroke:null,geomName:null,symbol:null,initialize:function(){GeoBeans.Symbolizer.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Symbolizer.Type.Polygon,this.fill=new GeoBeans.Fill,this.stroke=new GeoBeans.Stroke},clone:function(){var l=new GeoBeans.Symbolizer.PolygonSymbolizer;return null!=this.fill?l.fill=this.fill.clone():l.fill=null,null!=this.stroke?l.stroke=this.stroke.clone():l.stroke=null,null!=this.symbol?l.symbol=this.symbol.clone():l.symbol=null,l.geomName=this.geomName,l}});
GeoBeans.Rule=GeoBeans.Class({name:null,symbolizer:null,textSymbolizer:null,filter:null,minScale:null,maxScale:null,initialize:function(){},clone:function(){var l=new GeoBeans.Rule;return l.name=this.name,null!=this.symbolizer&&(l.symbolizer=this.symbolizer.clone()),null!=this.textSymbolizer&&(l.textSymbolizer=this.textSymbolizer.clone()),null!=this.filter&&(l.filter=this.filter.clone()),l.minScale=this.minScale,l.maxScale=this.maxScale,l}});
GeoBeans.Stroke=GeoBeans.Class({color:null,width:null,lineCap:null,lineJoin:null,dashOffset:null,initialize:function(){this.color=new GeoBeans.Color,this.width=2,this.lineCap=GeoBeans.Stroke.LineCapType.RoundCap,this.lineJoin=GeoBeans.Stroke.LineJoinType.RoundJoin},getRgba:function(){return this.color.getRgba()},getRgb:function(){return this.color.getRgb()},getOpacity:function(){return this.color.getOpacity()},clone:function(){var e=new GeoBeans.Stroke;return null!=this.color&&(e.color=this.color.clone()),e.width=this.width,e.lineCap=this.lineCap,e.lineJoin=this.lineJoin,e.dashOffset=this.dashOffset,e}}),GeoBeans.Stroke.LineCapType={ButtCap:"butt",SquareCap:"square",RoundCap:"round",LineCapMax:"max"},GeoBeans.Stroke.LineJoinType={MiterJoin:"miter",MiterRevertJoin:"miterRevert",RoundJoin:"round",BevelJoin:"bevel",LineJoinMax:"max"};
GeoBeans.StyleManager=GeoBeans.Class({name:"",server:null,styles:null,colorMaps:null,service:"ims",version:"1.0.0",reader:null,writer:null,initialize:function(e){this.server=e+"/mgr",this.styles=[],this.colorMaps=[],this.reader=new GeoBeans.StyleReader,this.writer=new GeoBeans.StyleWriter},getStyles:function(){var e=this,t="service="+this.service+"&version="+this.version+"&request=GetStyle";return $.ajax({type:"get",url:this.server,data:encodeURI(t),dataType:"xml",async:!1,beforeSend:function(e){},success:function(t,r){e.styles=e.parseStyles(t)},complete:function(e,t){},error:function(){}}),this.styles},getStyle:function(e){if(null==this.styles)return null;for(var t=0;t<this.styles.length;++t){var r=this.styles[t];if(r.name==e)return r}return null},getStyleXML:function(e,t){if(null!=e){var r=this,n="service="+this.service+"&version="+this.version+"&request=GetStyle&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(n,s){var o=r.parseStyleXML(n);if(null==o&&null!=t)return void t(null);var i=r.getStyle(e);if(null==i)return void(void 0!=t&&t(o));var a=o.rules;i.rules=[];for(var l=0;l<a.length;++l)i.addRule(a[l]);i.styleClass=o.styleClass,void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})}},getStyleByType:function(e){if(null==this.styles)return null;for(var t=new Array,r=0;r<this.styles.length;++r){var n=this.styles[r],s=n.geomType;s==e&&t.push(n)}return t},addStyle:function(e,t,r,n){var s=this,o="service="+this.service+"&version="+this.version+"&request=AddStyle&name="+t+"&type="+r+"&style="+e;$.ajax({type:"POST",url:this.server,data:encodeURI(o),contentType:"application/x-www-form-urlencoded",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var r=s.parseAddStyleXml(e);s.getStyles(),void 0!=n&&n(r)},complete:function(e,t){},error:function(){}})},updateStyle:function(e,t,r){var n=this,s="service="+this.service+"&version="+this.version+"&request=UpdateStyle&name="+t+"&style="+e;$.ajax({type:"POST",url:this.server,data:encodeURI(s),contentType:"application/x-www-form-urlencoded",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var s=n.parseUpdateStyleXml(e);n.getStyles(),void 0!=r&&r(s)},complete:function(e,t){},error:function(){}})},removeStyle:function(e,t){if(null!=e){var r=this,n="service="+this.service+"&version="+this.version+"&request=removeStyle&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var s=r.parseRemoveStyleXml(e);r.getStyles(),void 0!=t&&t(s)},complete:function(e,t){},error:function(){}})}},getColorMaps:function(e){if(null==e){var t=this.getColorMapsSyn();return t}this.getColorMapsAsync(e)},getColorMapsAsync:function(e){var t=this,r="service="+this.service+"&version="+this.version+"&request=GetColorMap";$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(r,n){t.colorMaps=t.parseColorMaps(r),void 0!=e&&e(t.colorMaps)},complete:function(e,t){},error:function(){}})},getColorMapsSyn:function(){var e=this,t="service="+this.service+"&version="+this.version+"&request=GetColorMap";return $.ajax({type:"get",url:this.server,data:encodeURI(t),dataType:"xml",async:!1,beforeSend:function(e){},success:function(t,r){e.colorMaps=e.parseColorMaps(t)},complete:function(e,t){},error:function(){}}),e.colorMaps},getColorMapByID:function(e,t){if(null==t){var r=this.getColorMapByIDSyn(e);return r}this.getColorMapByIDAsync(e,t)},getColorMapByIDAsync:function(e,t){var r=this,n="service="+this.service+"&version="+this.version+"&request=GetColorMap&id="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){r.colorMap=r.parseColorMapID(e),void 0!=t&&t(r.colorMap)},complete:function(e,t){},error:function(){}})},getColorMapByIDSyn:function(e){var t=this,r="service="+this.service+"&version="+this.version+"&request=GetColorMap&id="+e;return this.colorMapID=e,$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,r){t.colorMap=t.parseColorMapID(e)},complete:function(e,t){},error:function(){}}),t.colorMap},getColorMap:function(e,t,r){if(null==r){var n=this.getColorMapSyn(e,t);return n}this.getColorMapAsync(e,t,r)},getColorMapSyn:function(e,t){var r=this,n="service="+this.service+"&version="+this.version+"&request=GetColorMap&id="+e+"&count="+t;return $.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){var n=r.parseColorMap(e);r.colors=n},complete:function(e,t){},error:function(){}}),r.colors},getColorMapAsync:function(e,t,r){var n=this,s="service="+this.service+"&version="+this.version+"&request=GetColorMap&id="+e+"&count="+t;$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var s=n.parseColorMap(e);void 0!=r&&r(s)},complete:function(e,t){},error:function(){}})},getSymbols:function(e,t){if(null==e)return void(null!=t&&t("params is invalid"));var r=this,n="service="+this.service+"&version="+this.version+"&request=GetSymbol&type="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var s=r.parseGetSymbol(e);void 0!=t&&t(s)},complete:function(e,t){},error:function(){}})},getSymbol:function(e,t){var r=this,n="service="+this.service+"&version="+this.version+"&request=GetSymbol&type="+e+"&name="+t;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){var n=r.parseGetSymbol(e);void 0!=callback&&callback(n)},complete:function(e,t){},error:function(){}})},getSymbolIcon:function(e,t){var r=this.server+"?service="+this.service+"&version="+this.version+"&request=GetSymbolIcon&type="+e+"&name="+t;return r},parseStyles:function(e){var t=this,r=new Array;return $(e).find("Style").each(function(){var e=$(this).attr("name"),n=$(this).attr("type"),s=t.readStyleType(n),o=new GeoBeans.Style.FeatureStyle(e,s);r.push(o)}),r},readStyleType:function(e){var t=null;switch(e=e.toLowerCase()){case"point":t=GeoBeans.Style.FeatureStyle.GeomType.Point;break;case"linestring":t=GeoBeans.Style.FeatureStyle.GeomType.LineString;break;case"polygon":t=GeoBeans.Style.FeatureStyle.GeomType.Polygon}return t},parseAddStyleXml:function(e){var t="",r=$(e).find("AddStyle").text();return"SUCCESS"==r.toUpperCase()?t="success":""!=$(e).find("ExceptionText").text()&&(t=$(e).find("ExceptionText").text()),t},parseUpdateStyleXml:function(e){var t="",r=$(e).find("UpdateStyle").text();return"SUCCESS"==r.toUpperCase()?t="success":""!=$(e).find("ExceptionText").text()&&(t=$(e).find("ExceptionText").text()),t},parseRemoveStyleXml:function(e){var t="",r=$(e).find("RemoveStyle").text();return"SUCCESS"==r.toUpperCase()?t="success":""!=$(e).find("ExceptionText").text()&&(t=$(e).find("ExceptionText").text()),t},parseStyleXML:function(e){var t=this.reader.read(e);return t},parseColorMaps:function(e){var t=[];return $(e).find("ColorMap").each(function(){var e=$(this).attr("id"),r=$(this).find("Start:first").text(),n=$(this).find("End:first").text(),s=$(this).find("OnlineResource").attr("xlink:href"),o=new GeoBeans.ColorMap(e,r,n,s);t.push(o)}),t},parseColorMapID:function(e){var t=this.colorMapID,r=$(e).find("Start:first").text(),n=$(e).find("End:first").text(),s=$(e).find("OnlineResource").attr("xlink:href"),o=new GeoBeans.ColorMap(t,r,n,s);return o},parseColorMap:function(e){var t=[];return $(e).find("Color").each(function(){var e=$(this).text();t.push(e)}),t},parseGetSymbol:function(e){var t=[],r=this;return $(e).find("Symbol").each(function(){var e=r.parseSymbol(this);null!=e&&t.push(e)}),t},parseSymbol:function(e){var t=$(e).find("Name").text(),r=$(e).find("Icon").attr("xlink:href"),n=null;return(null!=t||null!=r)&&(n=new GeoBeans.Symbol(t,r)),n}});
GeoBeans.StyleReader=GeoBeans.Class({filterReader:null,initialize:function(){this.filterReader=new GeoBeans.FilterReader},read:function(e){var t=null,r=$(e),l=r.find("StyledLayerDescriptor");if(1!=l.length)return null;var i=l.children()[0].tagName;i=i.slice(i.lastIndexOf(":")+1,i.length);return"UserLayer"==i?t=this.parseUserLayer(l.children()):"NamedLayer"==i&&(t=this.parseNamedLayer(l.children())),t},parseUserLayer:function(e){var t=e.find("UserStyle");if(1!=t.length)return null;var r=this.parseUserStyle(e);return r},parseUserStyle:function(e){var t=e.find("Name:first").text(),r=e.find("FeatureTypeStyle");if(1!=r.length)return null;var l=this.parseFeatureTypeXML(e),i=e.find("StyleClass").text();null!=i&&(l.styleClass=i);var a=e.find("StyleField").text();return null!=a&&(l.field=a),l.name=t,l},parseFeatureTypeXML:function(e){var t=new GeoBeans.Style.FeatureStyle,r=this;return e.find("Rule").each(function(){var e=r.parseRule($(this));t.addRule(e)}),t},parseRule:function(e){var t=this,r=new GeoBeans.Rule;e.children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),"Name"==e)r.name=$(this).text();else if("PointSymbolizer"==e){var l=t.parsePointSymbolizer($(this));r.symbolizer=l}else if("LineSymbolizer"==e){var i=t.parseLineSymbolizer($(this));r.symbolizer=i}else if("PolygonSymbolizer"==e){var a=t.parsePolygonSymbolizer($(this));r.symbolizer=a}else if("TextSymbolizer"==e){var n=t.parseTextSymbolizer($(this));r.textSymbolizer=n}else if("MinScaleDenominator"==e){var s=$(this).text();r.minScale=s}else if("MaxScaleDenominator"==e){var o=$(this).text();r.maxScale=o}else if("Filter"==e){var f=t.filterReader.read($(this));r.filter=f}});e.find("Name:first").text(),e.find("Title:first").text();return r},parsePointSymbolizer:function(e){var t=this,r=new GeoBeans.Symbolizer.PointSymbolizer;return r.stroke=null,r.fill=null,e.children().each(function(){var e=this.tagName;e=e.slice(e.lastIndexOf(":")+1,e.length),"Graphic"==e&&t.parseGraphic($(this),r)}),r},parseLineSymbolizer:function(e){var t=this,r=new GeoBeans.Symbolizer.LineSymbolizer;return r.fill=null,r.stroke=null,e.children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),"Stroke"==e){var l=t.parseStroke($(this));r.stroke=l}else if("Geometry"==e);else if("WellKnownName"==e){var i=t.parseSymbol($(this));r.symbol=i}else if("Fill"==e){var a=t.parseFill($(this));r.fill=a}}),r},parsePolygonSymbolizer:function(e){var t=this,r=new GeoBeans.Symbolizer.PolygonSymbolizer;return r.stroke=null,r.fill=null,e.children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),"Fill"==e){var l=t.parseFill($(this));r.fill=l}else if("Stroke"==e){var i=t.parseStroke($(this));r.stroke=i}else if("Geometry"==e){var a=t.parseGeometry($(this));r.geomName=a}else if("WellKnownName"==e){var n=t.parseSymbol($(this));r.symbol=n}}),r},parseGraphic:function(e,t){var r=this;e.children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),"Size"==e){var l=parseFloat($(this).text());t.size=l}else"Mark"==e&&r.parseMark($(this),t)})},parseMark:function(e,t){var r=this;e.children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),"WellKnownName"==e){var l=r.parseSymbol($(this));t.symbol=l}if("Fill"==e){var i=r.parseFill($(this));t.fill=i}else if("Stroke"==e){var a=r.parseStroke($(this));t.stroke=a}})},parseSize:function(e,t){e.children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),"Literal"==e){var r=$(this).text();t.size=parseFloat(r)}})},parseStroke:function(e){var t=new GeoBeans.Stroke,r=null,l=null,i=null;e.children().each(function(){var e=$(this).attr("name");"stroke"==e?r=$(this).text():"stroke-opacity"==e?l=$(this).text():"stroke-width"==e&&(i=parseFloat($(this).text()))});var a=new GeoBeans.Color;return a.setByHex(r,l),t.color=a,t.width=i,t},parseFill:function(e){var t=new GeoBeans.Fill,r=null,l=null;e.children().each(function(){var e=$(this).attr("name");"fill"==e?r=$(this).text():"fill-opacity"==e&&(l=$(this).text())});var i=new GeoBeans.Color;return i.setByHex(r,l),t.color=i,t},parseSymbol:function(e){var t=e.text();if(null!=t||""!=t){var r=new GeoBeans.Symbol(t,null);return r}return null},parseNamedLayer:function(e){return null},parseTextSymbolizer:function(e){var t=this,r=new GeoBeans.Symbolizer.TextSymbolizer;return r.fill=null,r.stroke=null,e.children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),"Label"==e)t.parseLabel($(this),r);else if("Font"==e){var l=t.parseFont($(this));r.font=l}else if("LabelPlacement"==e);else if("Fill"==e){var i=t.parseFill($(this));r.fill=i}else if("Stroke"==e){var a=t.parseStroke($(this));r.stroke=a}}),r},parseLabel:function(e,t){var r=$(e).find("PropertyName");if(1==r.length){var l=r.text();t.labelProp=l}else{var i=e.text();t.labelText=i}},parseFont:function(e){var t=new GeoBeans.Font;return e.children().each(function(){var e=$(this).attr("name");if("font-family"==e){var r=$(this).text();t.family=r}else if("font-size"==e){var l=parseFloat($(this).text());t.size=l}else if("font-style"==e){var i=$(this).text();"normal"==i?t.style=GeoBeans.Font.StyleType.Normal:"italic"==i?t.style=GeoBeans.Font.StyleType.Italic:"oblique"==i&&(t.style=GeoBeans.Font.StyleType.Oblique)}else if("font-weight"==e){var a=$(this).text();"normal"==a?t.weight=GeoBeans.Font.WeightType.Normal:"bold"==a&&(t.weight=GeoBeans.Font.WeightType.Bold)}}),t},parseGeometry:function(e){var t=$(e).find("PropertyName");if(1==t.length){var r=t.text();return r}return null}});
GeoBeans.StyleWriter=GeoBeans.Class({filterWriter:null,initialize:function(){this.filterWriter=new GeoBeans.FilterWriter},write:function(e){if(null==e)return null;var t=null;if(e.type==GeoBeans.Style.Type.FeatureType?t=this.writeFeature(e):e.type==GeoBeans.Style.Type.RasterType&&(t=this.writeRaster(e)),null!=t){var r=(new XMLSerializer).serializeToString(t);return r}return null},writeFeature:function(e){var t=$.parseXML('<?xml version="1.0" encoding="UTF-8"?><sld:StyledLayerDescriptor xmlns="http://www.opengis.net/sld" xmlns:sld="http://www.opengis.net/sld" xmlns:ogc="http://www.opengis.net/ogc" xmlns:gml="http://www.opengis.net/gml" version="1.0.0"/>'),r=t.createElement("sld:UserLayer"),l=t.createElement("sld:LayerFeatureConstraints"),a=t.createElement("sld:FeatureTypeConstraint");$(l).append(a),$(r).append(l);var n=this.writeUserStyle(t,e);return $(r).append(n),$("StyledLayerDescriptor",t).append(r),t},writeRaster:function(e){return null},writeUserStyle:function(e,t){var r=e.createElement("sld:UserStyle"),l=t.name,a=e.createElement("sld:Name");$(a).text(l),$(r).append(a);var n=this.writeFeatureType(e,t);$(r).append(n);var i=t.styleClass;if(null!=i){var s=e.createElement("sld:StyleClass");if($(s).text(i),$(r).append(s),i==GeoBeans.Style.FeatureStyle.StyleClass.DOTDENSITY){var p=t.field;if(null!=p){var o=e.createElement("sld:StyleField");$(o).text(p),$(r).append(o)}}}return r},writeFeatureType:function(e,t){for(var r=e.createElement("sld:FeatureTypeStyle"),l=t.rules,a=0;a<l.length;++a){var n=l[a];if(null!=n){var i=this.writeRule(e,n);$(r).append(i)}}return r},writeRule:function(e,t){var r=e.createElement("sld:Rule"),l=t.name;if(null!=l){var a=e.createElement("sld:Name");$(a).text(l),$(r).append(a)}var n=t.filter;if(null!=n){var i=this.filterWriter.write(e,n);$(r).append(i)}var s=t.symbolizer;if(null!=s){var p=s.type;if(p==GeoBeans.Symbolizer.Type.Point){var o=this.writePointSymbolizer(e,s);$(r).append(o)}else if(p==GeoBeans.Symbolizer.Type.Line){var m=this.writeLineSymbolizer(e,s);$(r).append(m)}else if(p==GeoBeans.Symbolizer.Type.Polygon){var d=this.writePolygonSymbolizer(e,s);$(r).append(d)}}var u=t.textSymbolizer;if(null!=u){var v=this.writeTextSymbolizer(e,u);$(r).append(v)}return r},writePointSymbolizer:function(e,t){var r=e.createElement("sld:PointSymbolizer"),l=e.createElement("sld:Graphic"),a=e.createElement("sld:Mark"),n=t.symbol;if(null!=n){var i=this.writeSymbol(e,n);$(a).append(i)}var s=t.fill;if(null!=s){var p=this.writeFill(e,s);$(a).append(p)}var o=t.stroke;if(null!=o){var m=this.writeStroke(e,o);$(a).append(m)}$(l).append(a);var d=t.size,u=e.createElement("sld:Size");return $(u).text(d),$(l).append(u),$(r).append(l),r},writeLineSymbolizer:function(e,t){var r=e.createElement("sld:LineSymbolizer"),l=t.symbol;if(null!=l){var a=this.writeSymbol(e,l);$(r).append(a)}var n=t.stroke;if(null!=n){var i=this.writeStroke(e,n);$(r).append(i)}var s=t.fill;if(null!=s){var p=this.writeFill(e,s);$(r).append(p)}return r},writePolygonSymbolizer:function(e,t){var r=e.createElement("sld:PolygonSymbolizer"),l=t.geomName;if(null!=l){var a=this.writeGeom(e,l);$(r).append(a)}var n=t.symbol;if(null!=n){var i=this.writeSymbol(e,n);$(r).append(i)}var s=t.fill;if(null!=s){var p=this.writeFill(e,s);$(r).append(p)}var o=t.stroke;if(null!=o){var m=this.writeStroke(e,o);$(r).append(m)}return r},writeFill:function(e,t){var r=e.createElement("sld:Fill"),l=t.color,a=l.getHex(),n=e.createElement("sld:CssParameter");$(n).attr("name","fill").text(a),$(r).append(n);var i=e.createElement("sld:CssParameter"),s=l.getOpacity();return $(i).attr("name","fill-opacity").text(s),$(r).append(i),r},writeStroke:function(e,t){var r=e.createElement("sld:Stroke"),l=t.color,a=l.getHex(),n=e.createElement("sld:CssParameter");$(n).attr("name","stroke").text(a),$(r).append(n);var i=l.getOpacity(),s=e.createElement("sld:CssParameter");$(s).attr("name","stroke-opacity").text(i),$(r).append(s);var p=t.width,o=e.createElement("sld:CssParameter");return $(o).attr("name","stroke-width").text(p),$(r).append(o),r},writeSize:function(e,t){var r=e.createElement("sld:Size"),l=e.createElement("ogc:Literal");return $(l).text(t),$(r).append(l),r},writeGeom:function(e,t){var r=e.createElement("sld:Geometry"),l=e.createElement("ogc:PropertyName");return $(l).text(t),$(r).append(l),r},writeTextSymbolizer:function(e,t){var r=e.createElement("sld:TextSymbolizer"),l=t.labelText;if(null!=l){var a=e.createElement("sld:Label");$(a).text(l),$(r).append(a)}var n=t.labelProp;if(null!=n){var i=e.createElement("sld:Label"),s=e.createElement("ogc:PropertyName");$(s).text(n),$(i).append(s),$(r).append(i)}var p=t.font;if(null!=p){var o=this.writeFont(e,p);$(r).append(o)}var m=t.fill;if(null!=m){var d=this.writeFill(e,m);$(r).append(d)}var u=t.stroke;if(null!=u){var v=this.writeStroke(e,u);$(r).append(v)}return r},writeFont:function(e,t){var r=e.createElement("sld:Font"),l=t.family;if(null!=l){var a=e.createElement("sld:CssParameter");$(a).attr("name","font-family").text(l),$(r).append(a)}var n=t.size;if(null!=n){var i=e.createElement("sld:CssParameter");$(i).attr("name","font-size").text(n),$(r).append(i)}var s=t.style;if(null!=s){var p=e.createElement("sld:CssParameter");$(p).attr("name","font-style").text(s),$(r).append(p)}var o=t.weight;if(null!=o){var m=e.createElement("sld:CssParameter");$(m).attr("name","font-weight").text(o),$(r).append(m)}return r},writeSymbol:function(e,t){if(null==t)return null;var r=e.createElement("sld:WellKnownName");return $(r).text(t.name),r}});
GeoBeans.Symbol=GeoBeans.Class({name:null,icon:null,initialize:function(n,i){this.name=n,this.icon=i},clone:function(){var n=new GeoBeans.Symbol;return null!=this.name&&(n.name=this.name),null!=this.icon&&(n.icon=this.icon),n}});
GeoBeans.Symbolizer.TextSymbolizer=GeoBeans.Class(GeoBeans.Symbolizer,{fill:null,stroke:null,rotation:null,rotationProp:null,font:null,labelText:null,labelProp:null,anchorX:0,anchorY:0,displaceX:0,displaceY:0,initialize:function(){GeoBeans.Symbolizer.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Symbolizer.Type.Text,this.fill=new GeoBeans.Fill,this.stroke=new GeoBeans.Stroke,this.font=new GeoBeans.Font,this.anchorX=0,this.anchorY=0,this.displaceX=0,this.displaceY=0},clone:function(){var l=new GeoBeans.Symbolizer.TextSymbolizer;return null!=this.fill?l.fill=this.fill.clone():l.fill=null,null!=this.stroke?l.stroke=this.stroke.clone():l.stroke=null,l.rotation=this.rotation,l.rotationProp=this.rotationProp,null!=this.font?l.font=this.font.clone():l.font=null,l.labelText=this.labelText,l.labelProp=this.labelProp,l}});
GeoBeans.SubManager=GeoBeans.Class({server:null,service:"ims",version:"1.0.0",poinames:null,aqiCitys:null,aqiLayer:null,aqiSourceName:null,aqiTimeField:null,aqiCityField:null,aqiUptimeLayer:null,aqiUptimeField:null,aqiDowntimeField:null,aqiFeatureType:null,time:null,subInt:null,timeTick:600,user_callback:null,poiFeatures:null,aqiFeatures:null,initialize:function(e){this.server=e+"/mgr",this.time=new Date,(null==this.poinames||null==this.aqiCitys)&&this.getSubscription(this.getSubscription_callback)},setSubParams:function(e,t,i,a,r,n,s,l){this.aqiSourceName=e,this.aqiLayer=t,this.aqiTimeField=i,this.aqiCityField=a,this.aqiUptimeLayer=r,this.aqiUptimeField=n,this.aqiDowntimeField=s,this.user_callback=l;var o=new GeoBeans.WFSWorkspace("tmp",this.server,"1.0.0");this.aqiFeatureType=new GeoBeans.FeatureType(o,this.aqiLayer),this.aqiUptimeFeatureType=new GeoBeans.FeatureType(o,this.aqiUptimeLayer)},getSubscription:function(e){var t=this,i="service="+this.service+"&version="+this.version+"&request=GetSubscription";$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(i,a){var r=t.parseGetSubscription(i);null!=e&&e(t,r)},complete:function(e,t){},error:function(){}})},parseGetSubscription:function(e){var t=$(e).find("ExceptionText");if(0!=t.length)return t.text();var i=new Object;return $(e).find("Theme").each(function(){var e=$(this).attr("name");if("poi"==e){var t=[];$(this).find("Keyword").each(function(){var e=$(this).text();t.push(e)}),i.poi=t}else if("aqi"==e){var a=[];$(this).find("Keyword").each(function(){var e=$(this).text();a.push(e)}),i.aqi=a}}),i},getSubscription_callback:function(e,t){if(null!=e&&null!=t){var i=t.poi,a=t.aqi;e.poinames=i,e.aqiCitys=a,e.beginSubscribe()}},beginSubscribe:function(){if(null==this.subInt&&null!=this.aqiFeatureType){var e=this;this.subInt=setInterval(function(){e.getSubscription(e.subscribe_callback)},1e3*this.timeTick)}},subscribe_callback:function(e,t){if(null!=e&&null!=t){var i=t.poi,a=t.aqi;e.poinames=i,e.aqiCitys=a,null!=a&&0!=a.length&&e.getDownloadTime(e.time,e.getDownloadTime_callback);var r=e.dateAdd(e.time,"second",e.timeTick);e.time=r}},getDownloadTime:function(e,t){if(null!=e&&null!=this.aqiUptimeFeatureType){var i=this.dateAdd(e,"minute",-1),a=new GeoBeans.BinaryComparisionFilter;a.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThan;var r=new GeoBeans.PropertyName;r.setName(this.aqiDowntimeField);var n=new GeoBeans.Literal,s=this.getTimeFormat(i);n.setValue(s),a.expression1=r,a.expression2=n,this.aqiUptimeFeatureType.fields=this.aqiUptimeFeatureType.getFields(null,this.aqiSourceName);var l=this.aqiUptimeFeatureType.buildGetFeatureFilterXML(null,this.aqiSourceName,a,null,null,null),o=this.server,u=this;$.ajax({type:"post",url:o,data:l,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,i){var a=u.aqiUptimeFeatureType.parseFeatures(e);void 0!=t&&t(u,a)},complete:function(e,t){},error:function(e,t,i){console.log("textStatus:"+t),console.log("error:"+i)}})}},getDownloadTime_callback:function(e,t){if(null!=e&&null!=t&&0!=t.length){for(var i=[],a=(e.aqiUptimeFeatureType.getFields(),e.aqiUptimeFeatureType.getFieldIndex(e.aqiUptimeField)),r=null,n=null,s=null,l=0;l<t.length;++l)n=t[l],null!=n&&(r=n.values,s=r[a],null!=s&&i.push(s));e.getAqisByUptime(e.aqiCitys,i,e.getAqisByUptime_callback)}},getAqisByUptime:function(e,t,i){if(null!=e&&null!=t&&$.isArray(e)&&$.isArray(t)){var a=new GeoBeans.BinaryLogicFilter;a.operator=GeoBeans.LogicFilter.OperatorType.LogicOprOr;for(var r=null,n=0;n<e.length;++n){r=e[n];var s=new GeoBeans.BinaryComparisionFilter;s.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var l=new GeoBeans.PropertyName;l.setName(this.aqiCityField);var o=new GeoBeans.Literal;o.setValue(r),s.expression1=l,s.expression2=o,a.addFilter(s)}var u=null,c=new GeoBeans.BinaryLogicFilter;c.operator=GeoBeans.LogicFilter.OperatorType.LogicOprOr;for(var n=0;n<t.length;++n){u=t[n];var p=new GeoBeans.BinaryComparisionFilter;p.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var l=new GeoBeans.PropertyName;l.setName(this.aqiTimeField);var o=new GeoBeans.Literal;o.setValue(u),p.expression1=l,p.expression2=o,c.addFilter(p)}var h=new GeoBeans.BinaryLogicFilter;h.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd,h.addFilter(a),h.addFilter(c),this.aqiFeatureType.fields=this.aqiFeatureType.getFields(null,this.aqiSourceName);var m=this.aqiFeatureType.buildGetFeatureFilterXML(null,this.aqiSourceName,h,200,null,null),d=this.server,F=this;$.ajax({type:"post",url:d,data:m,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var a=F.aqiFeatureType.parseFeatures(e);if(void 0!=i){var r=F.time;i(F,r,"aqi",a)}},complete:function(e,t){},error:function(e,t,i){console.log("textStatus:"+t),console.log("error:"+i)}})}},getAqisByUptime_callback:function(e,t,i,a){var r=e.dateAdd(t,"second",-e.timeTick);"aqi"==i?e.aqiFeatures=a:"poi"==i&&(e.poiFeatures=a),null!=e.user_callback&&(e.poiFeatures=[],e.user_callback(r,e.poiFeatures,e.aqiFeatures))},getSubFeatures:function(e){null!=this.poinames&&null!=this.aqiCitys&&null!=this.aqiFeatureType&&(this.aqiFeatures=null,this.poiFeatures=null,this.getPois(this.poinames,e,this.getSubFeatures_callback),this.getAqis(this.aqiCitys,e,this.getSubFeatures_callback))},getPois:function(e,t,i){this.poiFeatures=[]},getAqis:function(e,t,i){if(null!=e){0==e.length&&(this.aqiFeatures=[]);var a=new GeoBeans.BinaryComparisionFilter;a.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThan;var r=new GeoBeans.PropertyName;r.setName(this.aqiTimeField);var n=new GeoBeans.Literal,s=this.getTimeFormat(t);n.setValue(s),a.expression1=r,a.expression2=n;var l=new GeoBeans.BinaryLogicFilter;l.operator=GeoBeans.LogicFilter.OperatorType.LogicOprOr;for(var o=null,u=0;u<e.length;++u){o=e[u];var c=new GeoBeans.BinaryComparisionFilter;c.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var r=new GeoBeans.PropertyName;r.setName(this.aqiCityField);var n=new GeoBeans.Literal;n.setValue(o),c.expression1=r,c.expression2=n,l.addFilter(c)}var p=new GeoBeans.BinaryLogicFilter;p.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd,p.addFilter(a),p.addFilter(l),this.aqiFeatureType.fields=this.aqiFeatureType.getFields(null,this.aqiSourceName);var h=this.aqiFeatureType.buildGetFeatureFilterXML(null,this.aqiSourceName,p,200,null,null),m=this.server,d=this;$.ajax({type:"post",url:m,data:h,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,a){var r=d.aqiFeatureType.parseFeatures(e);void 0!=i&&i(d,t,"aqi",r)},complete:function(e,t){},error:function(e,t,i){console.log("textStatus:"+t),console.log("error:"+i)}})}},getSubFeatures_callback:function(e,t,i,a){null!=e&&null!=i&&null!=a&&("aqi"==i?e.aqiFeatures=a:"poi"==i&&(e.poiFeatures=a),null!=e.user_callback&&e.user_callback(t,e.poiFeatures,e.aqiFeatures))},dateAdd:function(e,t,i){var a=new Date(e);switch(t.toLowerCase()){case"year":a.setFullYear(a.getFullYear()+i);break;case"quarter":a.setMonth(a.getMonth()+3*i);break;case"month":a.setMonth(a.getMonth()+i);break;case"week":a.setDate(a.getDate()+7*i);break;case"day":a.setDate(a.getDate()+i);break;case"hour":a.setTime(a.getTime()+36e5*i);break;case"minute":a.setTime(a.getTime()+6e4*i);break;case"second":a.setTime(a.getTime()+1e3*i);break;default:a=void 0}return a},getTimeFormat:function(e){if(null==e)return null;var t=this.dateFormat(e,"yyyy-MM-dd hh:mm:ss");return t},dateFormat:function(e,t){var i={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length)));for(var a in i)new RegExp("("+a+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?i[a]:("00"+i[a]).substr((""+i[a]).length)));return t},subscribe:function(e,t,i){if(null==e||null==t||!$.isArray(t))return void(null!=i&&i("params is invalid"));for(var a="",r=0;r<t.length;++r){var n=t[r];null!=n&&(a+=n,r+1<t.length&&(a+=","))}var s="service="+this.service+"&version="+this.version+"&request=subscribe&theme="+e+"&keywords="+a,l=this;$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var a=l.parseSubscribe(e);null!=i&&i(a),"SUCCESS"==a&&l.getSubscription(l.getSubscription_callback)},complete:function(e,t){},error:function(){}})},parseSubscribe:function(e){var t=$(e).find("Subscribe").text();if("success"==t.toLowerCase())return"SUCCESS";var i=$(e).find("ExceptionText");return 0!=i.length?i.text():void 0},endSubSribe:function(){null!=this.subInt&&clearInterval(this.subInt),this.subInt=null},Unsubscribe:function(e,t,i){if(null==e||null==t)return void(null!=i&&i("params is invalid"));var a="service="+this.service+"&version="+this.version+"&request=Unsubscribe&theme="+e+"&keywords="+t,r=this;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var a=r.parseUnsubscribe(e);null!=i&&i(a),"SUCCESS"==a&&r.getSubscription(r.getSubscription_callback)},complete:function(e,t){},error:function(){}})},parseUnsubscribe:function(e){var t=$(e).find("Unsubscribe").text();if("success"==t.toLowerCase())return"SUCCESS";var i=$(e).find("ExceptionText");return 0!=i.length?i.text():void 0}});
GeoBeans.TileDBManager=GeoBeans.Class({name:null,userServer:null,server:null,service:"wmts",version:"1.0.0",initialize:function(e){this.userServer=e},setName:function(e){null!=e&&(this.name=e,this.server=this.userServer+"/"+this.name+"/wmts")},getCapabilities:function(){var e=this,t="service="+this.service+"&version="+this.version+"&request=GetCapabilities";return $.ajax({type:"get",url:this.server,data:encodeURI(t),dataType:"xml",async:!1,beforeSend:function(e){},success:function(t,r){e.layers=e.parseGetCapabilities(t)},complete:function(e,t){},error:function(){}}),e.layers},parseGetCapabilities:function(e){var t=[],r=this;return $(e).find("Layer").each(function(){var e=r.parseLayer(this);t.push(e)}),t},parseLayer:function(e){var t=$(e).find("Identifier:first").text(),r=$(e).find("Format:first").text(),i=$(e).find("TileMatrixSetLink>TileMatrixSet").text(),s=$(e).find("LowerCorner").text(),n=$(e).find("UpperCorner").text(),a=s.indexOf(" "),l=s.lastIndexOf(" "),o=s.slice(0,a),f=s.slice(l+1,s.length);a=n.indexOf(" "),l=n.lastIndexOf(" ");var u=n.slice(0,a),c=n.slice(l+1,n.length),p=new GeoBeans.Envelope(parseFloat(o),parseFloat(f),parseFloat(u),parseFloat(c)),v=new GeoBeans.Layer.WMTSLayer(t,this.server,t,p,i,r);return v}});
GeoBeans.TileStore=GeoBeans.Class({name:null,extent:null,format:null,tms:null,sourceName:null,initialize:function(e,t,n,l,s){this.name=e,this.extent=t,this.format=n,this.tms=l,this.sourceName=s}});
GeoBeans.WFSWorkspace=GeoBeans.Class(GeoBeans.Workspace,{server:null,service:"wfs",version:"1.0.0",featureTypes:null,xmlns:null,xmlnsWorkspace:null,workspaceName:null,initialize:function(e,t,n){GeoBeans.Workspace.prototype.initialize.apply(this,arguments),this.server=t,this.version=n,this.featureTypes=null;var s=t.lastIndexOf("/"),r=t.substr(0,s),a=r.lastIndexOf("/");this.workspaceName=r.substr(a+1,r.length)},destory:function(){this.server=null,this.version=null,this.featureTypes=null,GeoBeans.Workspace.prototype.destory.apply(this,arguments)},getFeatureTypes:function(e){if(null!=this.featureTypes)return this.featureTypes;var t=this,n="service="+this.service+"&version="+this.version+"&request=getCapabilities";return $.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,n){t.featureTypes=t.parseFeatureTypes(e),t.xmlns=$(e).children("WFS_Capabilities").attr("xmlns");var s="xmlns:"+t.workspaceName;t.xmlnsWorkspace=$(e).children("WFS_Capabilities").attr(s)},complete:function(e,t){},error:function(){}}),this.featureTypes},getFeatureType:function(e){for(var t=this.getFeatureTypes(),n=t.length,s=0;n>s;s++){var r=t[s];if(r.name==e)return r}return null},parseFeatureTypes:function(e){var t=null,n=new Array,s=this;return $(e).find("FeatureType").each(function(){t=s.parseFeatureType(this),n.push(t)}),n},parseFeatureType:function(e){var t=$(e).children("Name:first").text(),n=$(e).children("Title:first").text(),s=$(e).children("Keywords:first").text(),r=$(e).children("SRS:first").text(),a=$(e).children("LatLongBoundingBox:first"),i=parseFloat($(a).attr("minx")),o=parseFloat($(a).attr("maxx")),l=parseFloat($(a).attr("miny")),u=parseFloat($(a).attr("maxy")),c=new GeoBeans.Envelope(i,l,o,u),p=new GeoBeans.FeatureType(this);return p.setName(t),p.setTitle(n),p.setKeywords(s),p.setSrs(r),p.setExtent(c),p},queryByBuffer:function(e,t,n,s){if(!(null==e||0>e||null==t||null==n)){var r=n.geomFieldName,a=new GeoBeans.Geometry.GML.Writer(GeoBeans.Geometry.GML.Version.v_2_0),i=(a.write(t),n.name),o=this.buildBufferXML(i,r,t,e);$.ajax({type:"post",url:this.server,contentType:"text/xml",data:o,dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){var r=n.parseFeatures(e);s(r)},complete:function(e,t){},error:function(){}})}},buildBufferXML:function(e,t,n,s){var r="",a=this.workspaceName,i='xmlns:wfs="http://www.opengis.net/wfs"',o="xmlns:"+a+'="'+this.xmlnsWorkspace+'"',l='xmlns:gml="http://www.opengis.net/gml"',u='xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"',c='xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/WFS-basic.xsd"',p=new GeoBeans.Geometry.GML.Writer(GeoBeans.Geometry.GML.Version.v_2_0),f=p.write(n);return r+='<wfs:GetFeature service="WFS" version="1.0.0"  '+i+" "+o+" "+l+" "+u+" "+c+'><wfs:Query typeName="'+e+'"><Filter><DWithin><PropertyName>'+t+"</PropertyName>"+f+"<Distance>"+s+"</Distance></DWithin></Filter></wfs:Query></wfs:GetFeature>"},transaction:function(e,t,n,s){var r=this.server,a=this.buildTransactionXML(e,t,n);$.ajax({type:"post",url:r,data:a,dataType:"xml",contentType:"text/xml",async:!1,beforeSend:function(e){},success:function(e,t){var n=$(e),r=n.find("SUCCESS");if(0!=r.length){var a=n.find("InsertResult");if(0!=a.length){var i=a.find("FeatureId").attr("fid");return i=i.substr(i.lastIndexOf(".")+1,i.length),s(i),that.features=null,void that.map.draw()}}var o=n.find("ServiceExceptionReport");if(0!=o.length){var l=n.find("ServiceException").text();return void s(l)}},complete:function(e,t){},error:function(){}})},buildTransactionXML:function(e,t,n){if(null!=e&&null!=t&&null!=n){for(var s="",r=e.name,a=this.workspaceName,i='xmlns:wfs="http://www.opengis.net/wfs"',o="xmlns:"+a+'="'+this.xmlnsWorkspace+'"',l='xmlns:gml="http://www.opengis.net/gml"',u='xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"',c='xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/WFS-basic.xsd"',p="",f=0;f<n.length;++f){var m=n[f],h=m.field,v=m.value;-1!=e.getFieldIndex(h)&&(p+="<"+a+":"+h+">",p+=v,p+="</"+a+":"+h+">")}var d=new GeoBeans.Geometry.GML.Writer(GeoBeans.Geometry.GML.Version.v_2_0),x=d.write(t),w="";return w+="<"+a+":"+e.geomFieldName+">",w+=x,w+="</"+a+":"+e.geomFieldName+">",s+='<wfs:Transaction service="WFS" version="1.0.0"  '+i+" "+o+" "+l+" "+u+" "+c+">",s+="<wfs:Insert>",s+="<"+a+":"+r+">",s+=p,s+=w,s+="</"+a+":"+r+">",s+="</wfs:Insert>",s+="</wfs:Transaction>"}},getValue:function(e,t,n,s,r){if(null!=e&&null!=t&&null!=s){null==r&&(r="asc");var a=this,i="service="+this.service+"&version="+this.version+"&request=GetValue&typeName="+e+"&field="+t+"&type=unique&order="+r;null!=n&&(i+="&mapName="+n),$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseValues(e);s(n)},complete:function(e,t){},error:function(){}})}},parseValues:function(e){var t=[];return $(e).find("Value").each(function(){var e=$(this).text();t.push(e)}),t},getMinMaxValue:function(e,t,n,s){if(null!=e&&null!=t&&null!=s){var r=this,a="service="+this.service+"&version="+this.version+"&request=GetValue&typeName="+e+"&field="+t+"&type=minmax";null!=n&&(a+="&mapName="+n),$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=r.pareseMinMaxValue(e);s(n)},complete:function(e,t){},error:function(){}})}},pareseMinMaxValue:function(e){var t=$(e).find("Min").text(),n=$(e).find("Max").text(),s=new Object;return s.min=parseFloat(t),s.max=parseFloat(n),s}});
GeoBeans.WMSWorkspace=GeoBeans.Class(GeoBeans.Workspace,{server:null,service:"wms",version:"1.3.0",layers:null,extent:null,format:"image/png",srs:"EPSG:4326",transparent:"true",initialize:function(e,t,s){GeoBeans.Workspace.prototype.initialize.apply(this,arguments),this.server=t,this.version=s,this.layers=null,this.extent=null},destory:function(){this.server=null,this.version=null,this.layers=null,this.extent=null,GeoBeans.Workspace.prototype.destory.apply(this,arguments)},getLayers:function(e){return void 0==e?this.getLayers_sync():void this.getLayers_aync(e)},getLayers_sync:function(){var e=this,t="service="+this.service+"&version="+this.version+"&request=getCapabilities";return $.ajax({type:"get",url:this.server,data:encodeURI(t),dataType:"xml",async:!1,beforeSend:function(e){},success:function(t,s){e.parseCapabilities(t)},complete:function(e,t){},error:function(){}}),this.layers},getLayers_aync:function(e){var t=this,s="service="+this.service+"&version="+this.version+"&request=getCapabilities";$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(s,r){t.parseCapabilities(s),e(t.layers)},complete:function(e,t){},error:function(t,s){null!=e&&e(s)}})},getMap:function(e,t,s,r,a,n){var i=this,o=this.getMapURL(e,t,s,r,a,n);$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xmllayers, styles, width, height, format",async:!0,beforeSend:function(e){},success:function(e,t){i.parseCapabilities(e),callback(i.layers)},complete:function(e,t){},error:function(){}})},parseCapabilities:function(e){this.extent=this.parseExent($(e).find("Layer>BoundingBox").first()),this.layers=this.parseLayers($(e).find("Layer>Layer"))},parseExent:function(e){if(void 0==e)return null;var t=parseFloat($(e).attr("minx")),s=parseFloat($(e).attr("miny")),r=parseFloat($(e).attr("maxx")),a=parseFloat($(e).attr("maxy"));return new GeoBeans.Envelope(t,s,r,a)},parseLayers:function(e){var t=this,s=[];return $(e).each(function(){var e=t.parseLayer(this);null!=e&&s.push(e)}),s},parseLayer:function(e){var t=$(e).find("Name").first().text(),s=$(e).find("CRS").first().text(),r=this.parseExent($(e).find("BoundingBox").first()),a=$(e).find("Style>Name").first().text(),n=$(e).find("GeometryType").first().text(),i=this.getGeomType(n),o=new GeoBeans.Layer.MapLayer(t);return o.srs=s,o.extent=r,o.style_name=a,o.geomType=i,o},getGeomType:function(e){var t=null;switch(e.toUpperCase()){case"POINT":t=GeoBeans.Geometry.Type.POINT;break;case"LINESTRING":t=GeoBeans.Geometry.Type.LINESTRING;break;case"POLYGON":t=GeoBeans.Geometry.Type.POLYGON;break;case"MULTIPOINT":t=GeoBeans.Geometry.Type.MULTIPOINT;break;case"MULTILINESTRING":t=GeoBeans.Geometry.Type.MULTILINESTRING;break;case"MULTIPOLYGON":t=GeoBeans.Geometry.Type.MULTIPOLYGON}return t},getMapURL:function(e,t,s,r,a,n){var i=t.xmin+","+t.ymin+","+t.xmax+","+t.ymax,o="service=wms";return o+="&version="+this.version,o+="&request=getMap",o+="&layers="+this.layers,o+="&width="+s,o+="&height="+r,o+="&format="+a,o+="&bbox="+i,o+=null==n?"&styles=":"&styles="+n},getMapLayer:function(e){if(null==this.layers&&(this.layers=this.getLayers_sync()),null!=this.layers){for(var t=0;t<this.layers.length;++t){var s=this.layers[t];if(s.name==e)return s}return null}}});
GeoBeans.WMTSWorkspace=GeoBeans.Class(GeoBeans.Workspace,{name:null,server:null,layers:null,initialize:function(e,r){this.name=e,this.server=r},getLayer:function(e,r){for(var n=this.getLayers(),t=null,a=0;a<n.length;++a)if(t=n[a],t.typeName==e)return t.setName(r),t;return null},getLayers:function(){if(null!=this.server){var e=this;return $.ajax({type:"get",url:this.server,dataType:"xml",async:!1,beforeSend:function(e){},success:function(r,n){e.layers=e.parseLayers(r)},complete:function(e,r){},error:function(){}}),e.layers}},parseLayers:function(e){var r=[],n=this;return $(e).find("Layer").each(function(){var e=n.parseLayer(this);r.push(e)}),r},parseLayer:function(e){var r=$(e).find("Identifier:first").text(),n=$(e).find("Format:first").text(),t=$(e).find("TileMatrixSetLink>TileMatrixSet").text(),a=$(e).find("LowerCorner").text(),s=$(e).find("UpperCorner").text(),i=a.indexOf(" "),l=a.lastIndexOf(" "),o=a.slice(0,i),f=a.slice(l+1,a.length);i=s.indexOf(" "),l=s.lastIndexOf(" ");var u=s.slice(0,i),c=s.slice(l+1,s.length),p=new GeoBeans.Envelope(parseFloat(o),parseFloat(f),parseFloat(u),parseFloat(c)),y=new GeoBeans.Layer.WMTSLayer(r,this.server,r,p,t,n);return y}});